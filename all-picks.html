<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>All Picks • Weekend Predictor</title>
  <link rel="stylesheet" href="brand.css" />
  <style>
    /* Force landscape-style layout: one full-width column */
    .main-layout { grid-template-columns: 1fr !important; }

    .matrix-wrap { overflow: auto; border-radius: 16px; border: 1px solid rgba(148,163,184,0.28); }
    table.matrix { width: 100%; border-collapse: collapse; min-width: 980px; }
    .matrix th, .matrix td { padding: 10px; border-bottom: 1px solid rgba(148,163,184,0.18); text-align: center; }
    .matrix thead th { position: sticky; top: 0; background: rgba(2,6,23,0.78); z-index: 2; }

    /* Sticky fixture column */
    .fixture-col {
      text-align: left !important;
      min-width: 300px;
      position: sticky;
      left: 0;
      z-index: 3;
      background: rgba(2,6,23,0.82);
    }
    .matrix tbody td.fixture-col { background: rgba(2,6,23,0.62); }

    .player-header { white-space: nowrap; }

    .status-line { margin: 10px 0 14px; color: #cbd5e1; }
    .week-title { margin: 0 0 8px; }

    .pill { display: inline-flex; align-items: center; justify-content: center; padding: 2px 8px; border-radius: 999px; font-size: 0.72rem; border: 1px solid rgba(148,163,184,0.35); }
    .pill-lock { border-color: rgba(244, 63, 94, 0.75); background: rgba(190, 18, 60, 0.28); color: #fecdd3; margin-left: 6px; }

    .pick-neutral { background: rgba(2,6,23,0.25); }
    .pick-exact { background: rgba(34,197,94,0.18); border: 1px solid rgba(34,197,94,0.35); }
    .pick-correct { background: rgba(59,130,246,0.16); border: 1px solid rgba(59,130,246,0.30); }
    .pick-wrong { background: rgba(15,23,42,0.35); border: 1px solid rgba(148,163,184,0.18); color: rgba(229,231,235,0.85); }

    .fx-meta { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .fx-names { font-weight: 800; }
    .fx-score { color: #e5e7eb; font-weight: 800; }
    .fx-kick { color: #9ca3af; font-size: 0.85rem; }

    /* Make the side panel look good underneath */
    .panel-side { margin-top: 18px; }
  </style>
</head>
<body class="bg-hero">
  <div class="page-shell">
    <header class="top-nav">
      <div class="top-nav-left">
        <div class="nav-logo">
          <img src="assets/brand-logo.png" alt="Weekend Predictor logo" />
        </div>
        <nav class="nav-links">
          <a href="index.html">Home</a>
          <a href="predict.html">Predict</a>
          <a href="my-picks.html">My Picks</a>
          <a href="teams.html">Teams</a>
        <a class="active" href="all-picks.html">All Picks</a>
          <a href="leaderboard.html">Leaderboard</a>
          <a href="stats.html">Stats</a>
          <a href="wallet.html">Wallet</a>
          <a href="profile.html">Profile</a>
          <a id="navAdmin" href="admin.html" style="display:none;">Admin</a>
          <a id="navLogout" href="#">Logout</a>
        </nav>
      </div>
      <div class="top-nav-right">
        <span class="muted">Current week only • All players visible</span>
      </div>
    </header>

    <main class="main-layout">
      <section class="panel">
        <div class="panel-inner">
          <h1 class="week-title">All Picks</h1>
          <div id="weekRange" class="muted"></div>
          <div id="statusLine" class="status-line">Loading…</div>

          <div id="tableWrapper" class="matrix-wrap" style="display:none;">
            <table class="matrix">
              <thead id="matrixHead"></thead>
              <tbody id="matrixBody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <aside class="panel panel-side">
        <div class="panel-inner">
          <h2>How this page works</h2>
          <ul class="bullet-list">
            <li>Rows = fixtures for the current week (Mon–Sun).</li>
            <li>Columns = all players (including AI Predictor).</li>
            <li>Cell = predicted score <em>(home–away)</em>, coloured when the fixture finishes.</li>
            <li>Green = exact score • Blue = correct result • Dark = wrong.</li>
            <li>“L” badge = that player has locked their picks for the week.</li>
          </ul>
        </div>
      </aside>
    </main>
  </div>

  <script type="module">
    import { supabase } from './supabase-config.js';

    const navAdmin = document.getElementById('navAdmin');
    const navLogout = document.getElementById('navLogout');
    const weekRange = document.getElementById('weekRange');
    const statusLine = document.getElementById('statusLine');
    const wrapper = document.getElementById('tableWrapper');
    const headEl = document.getElementById('matrixHead');
    const bodyEl = document.getElementById('matrixBody');

    function escapeHtml(s) {
      return String(s ?? '').replace(/[&<>"']/g, c => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      }[c]));
    }

    function startOfWeek(d) {
      const x = new Date(d);
      x.setHours(0,0,0,0);
      const day = x.getDay(); // Sun=0
      const diff = day === 0 ? -6 : 1 - day; // Monday start
      x.setDate(x.getDate() + diff);
      return x;
    }

    function addDays(d, n) {
      const x = new Date(d);
      x.setDate(x.getDate() + n);
      return x;
    }

    function isoDate(d) {
      const x = new Date(d);
      x.setHours(0,0,0,0);
      return x.toISOString();
    }

    function outcome(h,a) {
      if (h>a) return 'H';
      if (h<a) return 'A';
      return 'D';
    }

    const weekStart = startOfWeek(new Date());
    const weekEnd = addDays(weekStart, 7); // exclusive upper bound
    const weekStartStr = weekStart.toISOString().slice(0,10);

    weekRange.textContent =
      `${weekStart.toLocaleDateString()} – ${addDays(weekStart,6).toLocaleDateString()} (Mon–Sun)`;

    (async () => {
      const { data: { session } } = await supabase.auth.getSession();
      const user = session?.user;
      if (!user) {
        window.location.replace('login.html');
        return;
      }

      // admin
      try {
        const { data: prof } = await supabase
          .from('profiles')
          .select('is_admin')
          .eq('id', user.id)
          .maybeSingle();
        if (prof?.is_admin) navAdmin.style.display = '';
      } catch {}

      navLogout?.addEventListener('click', async (e)=>{
        e.preventDefault();
        try { await supabase.auth.signOut(); } catch {}
        window.location.replace('login.html');
      });

      await loadMatrix();
    })();

    async function loadMatrix() {
      statusLine.textContent = 'Loading current week fixtures…';
      wrapper.style.display = 'none';
      headEl.innerHTML = '';
      bodyEl.innerHTML = '';

      // 1) Load ALL players (including AI), so everyone is visible even without picks
      const { data: profiles, error: pfErr } = await supabase
        .from('profiles')
        .select('id, display_name, is_ai')
        .order('display_name', { ascending: true });

      if (pfErr) {
        console.error(pfErr);
        statusLine.textContent = 'Could not load players.';
        return;
      }

      const players = (profiles || [])
        .map(p => ({
          id: p.id,
          name: p.display_name || 'Player',
          is_ai: !!p.is_ai
        }))
        .sort((a,b)=>{
          if (a.is_ai !== b.is_ai) return a.is_ai ? 1 : -1; // AI at end
          return a.name.localeCompare(b.name);
        });

      // 2) Load fixtures ONLY for the current week
      // Keep featured-only if you want; set featuredOnly=false to show all fixtures in the week.
      const featuredOnly = true;

      let fxQuery = supabase
        .from('fixtures')
        .select('id, utc_date, home_team, away_team, home_score, away_score, status, featured')
        .gte('utc_date', isoDate(weekStart))
        .lt('utc_date', isoDate(weekEnd))
        .order('utc_date', { ascending: true });

      if (featuredOnly) fxQuery = fxQuery.eq('featured', true);

      const { data: fixtures, error: fxErr } = await fxQuery;

      if (fxErr) {
        console.error(fxErr);
        statusLine.textContent = 'Could not load fixtures.';
        return;
      }

      if (!fixtures || fixtures.length === 0) {
        statusLine.textContent = featuredOnly
          ? 'No featured fixtures for the current week.'
          : 'No fixtures found for the current week.';
        return;
      }

      const fixtureIds = fixtures.map(f => f.id);

      // 3) Predictions for these fixtures (any user)
      const { data: preds, error: prErr } = await supabase
        .from('predictions')
        .select('user_id, fixture_id, home_goals, away_goals')
        .in('fixture_id', fixtureIds);

      if (prErr) {
        console.error(prErr);
        statusLine.textContent = 'Could not load predictions.';
        return;
      }

      // 4) Pick locks for this week (for ALL players)
      const { data: locks } = await supabase
        .from('pick_locks')
        .select('user_id, week_start')
        .eq('week_start', weekStartStr);

      const lockSet = new Set((locks || []).map(l => l.user_id));

      // Build lookup for predictions: key = fixture_id|user_id
      const predMap = new Map();
      (preds || []).forEach(p => {
        predMap.set(`${p.fixture_id}|${p.user_id}`, p);
      });

      // --- Header ---
      const headRow = document.createElement('tr');
      const thFx = document.createElement('th');
      thFx.className = 'fixture-col';
      thFx.textContent = 'Fixture';
      headRow.appendChild(thFx);

      players.forEach(pl => {
        const th = document.createElement('th');
        th.innerHTML = `<span class="player-header">${escapeHtml(pl.name)}${pl.is_ai ? ' <span class="ai-badge ai-inline">AI</span>' : ''}</span>`;
        headRow.appendChild(th);
      });

      headEl.appendChild(headRow);

      // --- Body ---
      bodyEl.innerHTML = '';
      fixtures.forEach(fx => {
        const tr = document.createElement('tr');

        const tdFx = document.createElement('td');
        tdFx.className = 'fixture-col';

        const isFinished =
          String(fx.status || '').toUpperCase() === 'FINISHED' &&
          fx.home_score != null && fx.away_score != null;

        const kick = fx.utc_date ? new Date(fx.utc_date) : null;
        const kickText = kick ? kick.toLocaleString() : '—';

        tdFx.innerHTML = `
          <div class="fx-meta">
            <span class="fx-names">${escapeHtml(fx.home_team)} vs ${escapeHtml(fx.away_team)}</span>
            <span class="fx-kick">${escapeHtml(kickText)}</span>
            ${isFinished ? `<span class="fx-score">${fx.home_score}–${fx.away_score}</span>` : ''}
          </div>
        `;
        tr.appendChild(tdFx);

        const actualOutcome = isFinished ? outcome(fx.home_score, fx.away_score) : null;

        players.forEach(pl => {
          const td = document.createElement('td');

          const key = `${fx.id}|${pl.id}`;
          const p = predMap.get(key);

          const locked = lockSet.has(pl.id);
          const lockBadge = locked ? `<span class="pill pill-lock">L</span>` : '';

          if (!p) {
            td.innerHTML = `<span class="muted">—</span>${lockBadge}`;
            tr.appendChild(td);
            return;
          }

          const h = p.home_goals;
          const a = p.away_goals;

          td.innerHTML = `${h}–${a}${lockBadge}`;

          let cls = 'pick-neutral';
          if (isFinished) {
            const predOutcome = outcome(h, a);
            if (h === fx.home_score && a === fx.away_score) cls = 'pick-exact';
            else if (predOutcome === actualOutcome) cls = 'pick-correct';
            else cls = 'pick-wrong';
          }

          td.classList.add(cls);
          tr.appendChild(td);
        });

        bodyEl.appendChild(tr);
      });

      statusLine.textContent = `Loaded ${fixtures.length} fixtures and ${players.length} players.`;
      wrapper.style.display = '';
    }
  </script>
</body>
</html>
