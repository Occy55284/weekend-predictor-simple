<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>All Picks • Weekend Predictor</title>
  <link rel="stylesheet" href="brand.css" />

  <style>
    .main-layout { grid-template-columns: 1fr !important; }

    .matrix-wrap {
      overflow: auto;
      border-radius: 16px;
      border: 1px solid rgba(148,163,184,0.28);
    }
    table.matrix {
      width: 100%;
      border-collapse: collapse;
      min-width: 980px;
    }
    .matrix th, .matrix td {
      padding: 10px;
      border-bottom: 1px solid rgba(148,163,184,0.18);
      text-align: center;
    }
    .matrix thead th {
      position: sticky;
      top: 0;
      background: rgba(2,6,23,0.78);
      z-index: 2;
    }

    .fixture-col {
      text-align: left !important;
      min-width: 320px;
      position: sticky;
      left: 0;
      z-index: 3;
      background: rgba(2,6,23,0.85);
    }
    .matrix tbody td.fixture-col {
      background: rgba(2,6,23,0.65);
    }

    .pick-neutral { background: rgba(2,6,23,0.25); }
    .pick-exact { background: rgba(34,197,94,0.18); border:1px solid rgba(34,197,94,0.35); }
    .pick-correct { background: rgba(59,130,246,0.16); border:1px solid rgba(59,130,246,0.30); }
    .pick-wrong { background: rgba(15,23,42,0.35); border:1px solid rgba(148,163,184,0.18); }

    .ai-info {
      margin-left: 6px;
      font-weight: 900;
      cursor: help;
      opacity: 0.9;
    }

    /* Floating tooltip (NOT clipped) */
    #aiTooltip {
      position: fixed;
      max-width: 420px;
      padding: 10px 12px;
      background: rgba(2,6,23,0.96);
      color: #e5e7eb;
      border: 1px solid rgba(148,163,184,0.35);
      border-radius: 12px;
      font-size: 0.8rem;
      line-height: 1.4;
      z-index: 9999;
      pointer-events: none;
      display: none;
      box-shadow: 0 10px 25px rgba(0,0,0,0.4);
    }
  </style>
</head>

<body class="bg-hero">
<div class="page-shell">
  <header class="top-nav">
    <div class="top-nav-left">
      <div class="nav-logo">
        <img src="assets/brand-logo.png" alt="Weekend Predictor logo" />
      </div>
      <nav class="nav-links">
        <a href="index.html">Home</a>
        <a href="predict.html">Predict</a>
        <a href="my-picks.html">My Picks</a>
        <a class="active" href="all-picks.html">All Picks</a>
        <a href="leaderboard.html">Leaderboard</a>
        <a href="stats.html">Stats</a>
        <a href="wallet.html">Wallet</a>
        <a href="profile.html">Profile</a>
      </nav>
    </div>
    <div class="top-nav-right">
      <span class="muted">AI explanations on hover</span>
    </div>
  </header>

  <main class="main-layout">
    <section class="panel">
      <div class="panel-inner">
        <h1>All Picks</h1>
        <div id="statusLine" class="muted">Loading…</div>

        <div class="matrix-wrap" id="tableWrap" style="display:none;">
          <table class="matrix">
            <thead id="matrixHead"></thead>
            <tbody id="matrixBody"></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>
</div>

<!-- Floating tooltip -->
<div id="aiTooltip"></div>

<script type="module">
  import { supabase } from './supabase-config.js';

  const statusLine = document.getElementById('statusLine');
  const headEl = document.getElementById('matrixHead');
  const bodyEl = document.getElementById('matrixBody');
  const wrap = document.getElementById('tableWrap');
  const tooltip = document.getElementById('aiTooltip');

  function escapeHtml(s) {
    return String(s ?? '').replace(/[&<>"']/g, c =>
      ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])
    );
  }

  function startOfWeek(d) {
    const x = new Date(d);
    x.setHours(0,0,0,0);
    const day = x.getDay();
    x.setDate(x.getDate() + (day === 0 ? -6 : 1 - day));
    return x;
  }
  function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
  function iso(d){ const x=new Date(d); x.setHours(0,0,0,0); return x.toISOString(); }
  function outcome(h,a){ return h>a?'H':h<a?'A':'D'; }

  const ws = startOfWeek(new Date());
  const we = addDays(ws,7);
  const weekStartStr = ws.toISOString().slice(0,10);

  (async () => {
    const { data:{session} } = await supabase.auth.getSession();
    if(!session?.user){ location.replace('login.html'); return; }
    await load();
  })();

  async function load(){
    statusLine.textContent = 'Loading…';

    const { data: profiles } = await supabase
      .from('profiles')
      .select('id, display_name, is_ai')
      .order('display_name');

    const players = (profiles||[])
      .map(p=>({id:p.id,name:p.display_name||'Player',is_ai:p.is_ai}))
      .sort((a,b)=>a.is_ai===b.is_ai?a.name.localeCompare(b.name):a.is_ai?1:-1);

    const { data: fixtures } = await supabase
      .from('fixtures')
      .select('id, utc_date, home_team, away_team, home_score, away_score, status')
      .gte('utc_date', iso(ws))
      .lt('utc_date', iso(we))
      .eq('featured', true)
      .order('utc_date');

    const fxIds = fixtures.map(f=>f.id);

    const { data: preds } = await supabase
      .from('predictions')
      .select('id, user_id, fixture_id, home_goals, away_goals')
      .in('fixture_id', fxIds);

    const predMap = new Map();
    preds.forEach(p=>predMap.set(`${p.fixture_id}|${p.user_id}`, p));

    const aiIds = preds.filter(p=>{
      const pl = players.find(x=>x.id===p.user_id);
      return pl?.is_ai;
    }).map(p=>p.id);

    const { data: meta } = await supabase
      .from('ai_prediction_meta')
      .select('prediction_id, ai_explanation')
      .eq('week_start', weekStartStr)
      .in('prediction_id', aiIds);

    const explain = new Map();
    (meta||[]).forEach(m=>explain.set(m.prediction_id, m.ai_explanation));

    // Header
    const hr = document.createElement('tr');
    const thFx = document.createElement('th');
    thFx.className='fixture-col'; thFx.textContent='Fixture';
    hr.appendChild(thFx);
    players.forEach(p=>{
      const th=document.createElement('th');
      th.innerHTML = `${escapeHtml(p.name)}${p.is_ai?' <span class="ai-badge ai-inline">AI</span>':''}`;
      hr.appendChild(th);
    });
    headEl.appendChild(hr);

    fixtures.forEach(fx=>{
      const tr=document.createElement('tr');
      const tdFx=document.createElement('td');
      tdFx.className='fixture-col';
      const fin = fx.status==='FINISHED';
      tdFx.innerHTML = `
        <strong>${escapeHtml(fx.home_team)} vs ${escapeHtml(fx.away_team)}</strong><br>
        <span class="muted">${new Date(fx.utc_date).toLocaleString()}</span>
        ${fin?`<span class="fx-score">${fx.home_score}–${fx.away_score}</span>`:''}
      `;
      tr.appendChild(tdFx);

      players.forEach(pl=>{
        const td=document.createElement('td');
        const p=predMap.get(`${fx.id}|${pl.id}`);
        if(!p){ td.textContent='—'; tr.appendChild(td); return; }

        let info='';
        if(pl.is_ai && explain.has(p.id)){
          info = ` <span class="ai-info" data-text="${escapeHtml(explain.get(p.id))}">ℹ</span>`;
        }
        td.innerHTML = `${p.home_goals}–${p.away_goals}${info}`;

        if(fin){
          const ao=outcome(fx.home_score,fx.away_score);
          const po=outcome(p.home_goals,p.away_goals);
          td.className = (p.home_goals===fx.home_score && p.away_goals===fx.away_score)
            ? 'pick-exact'
            : (ao===po?'pick-correct':'pick-wrong');
        } else td.className='pick-neutral';

        tr.appendChild(td);
      });
      bodyEl.appendChild(tr);
    });

    wrap.style.display='';
    statusLine.textContent='Loaded.';
    bindTooltips();
  }

  function bindTooltips(){
    document.querySelectorAll('.ai-info').forEach(el=>{
      el.addEventListener('mouseenter',e=>{
        tooltip.textContent = el.dataset.text;
        tooltip.style.display='block';
      });
      el.addEventListener('mousemove',e=>{
        tooltip.style.left = (e.clientX + 14)+'px';
        tooltip.style.top  = (e.clientY + 14)+'px';
      });
      el.addEventListener('mouseleave',()=>{
        tooltip.style.display='none';
      });
    });
  }
</script>
</body>
</html>
