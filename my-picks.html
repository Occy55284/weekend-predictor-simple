<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>My Picks • Weekend Predictor</title>
  <link rel="stylesheet" href="brand.css?v=96" />

  <!-- ✅ Early auth gate -->
  <script type="module">
    import { supabase } from './supabase-config.js';
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) {
      window.location.replace('login.html');
      throw new Error('Redirecting to login');
    }
  </script>

  <style>
    .small-note {
      margin-top: 8px;
      font-size: 0.85rem;
    }
    .muted-center {
      text-align: center;
      color: #9ca3af;
      font-size: 0.9rem;
    }
    .tag {
      display: inline-flex;
      align-items: center;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      padding: 2px 8px;
      font-size: 0.75rem;
      color: #e5e7eb;
      background: rgba(15, 23, 42, 0.95);
      gap: 4px;
    }
    .tag-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 8px rgba(34,197,94,.9);
    }
  </style>
</head>
<body class="bg-hero">
  <div class="page-shell">
    <header class="top-nav">
      <div class="top-nav-left">
        <div class="nav-logo">
          <img src="assets/brand-logo.png" alt="Weekend Predictor logo" />
        </div>
        <div class="nav-text-group">
          <div class="nav-title">Weekend Predictor</div>
          <div class="nav-subtitle">Premier League prediction challenge</div>
        </div>
      </div>
      <nav class="top-nav-links">
        <a href="index.html">Home</a>
        <a href="predict.html">Predict</a>
        <a href="leaderboard.html">Leaderboard</a>
        <a href="my-picks.html" class="active">My Picks</a>
        <a href="profile.html">Profile</a>
        <a href="admin.html" id="navAdmin" style="display:none">Admin</a>
        <a href="#" id="navLogout">Logout</a>
      </nav>
    </header>

    <main class="main-layout">
      <section class="panel panel-main">
        <div class="panel-inner">
          <h1>My picks</h1>
          <p class="muted">
            A history of your predictions, results and points.
          </p>

          <div class="user-banner">
            Signed in as: <span id="userEmail"></span>
          </div>

          <div class="tag">
            <span class="tag-dot"></span>
            Latest fixtures listed first
          </div>

          <p class="muted small-note">
            Use the Predict page to update future scores before kick-off. Once results are entered, points will appear here.
          </p>

          <div id="picksList" class="fixtures-list" style="margin-top: 14px;">
            <div class="muted-center">Loading your picks…</div>
          </div>
        </div>
      </section>

      <aside class="panel panel-side">
        <div class="panel-inner">
          <h2>Quick tips</h2>
          <ul class="bullet-list muted">
            <li>Check this page after each gameweek to see how you did.</li>
            <li>Look for patterns in your predictions (too many home wins, big scores, etc.).</li>
            <li>Use that insight to tweak next week’s picks.</li>
          </ul>
        </div>
      </aside>
    </main>
  </div>

  <script type="module">
    import { supabase } from './supabase-config.js';

    const picksList  = document.getElementById('picksList');
    const navAdmin   = document.getElementById('navAdmin');
    const navLogout  = document.getElementById('navLogout');
    const userEmailEl = document.getElementById('userEmail');

    // Logout
    navLogout?.addEventListener('click', async (e) => {
      e.preventDefault();
      try { await supabase.auth.signOut(); } catch {}
      window.location.replace('login.html');
    });

    async function boot() {
      const { data: { session } } = await supabase.auth.getSession();
      const user = session?.user;
      if (!user) {
        window.location.replace('login.html');
        return;
      }

      userEmailEl.textContent = user.email || '';

      // Show Admin link if profile has is_admin
      try {
        const { data: profile, error: profErr } = await supabase
          .from('profiles')
          .select('is_admin')
          .eq('id', user.id)
          .maybeSingle();
        if (!profErr && profile?.is_admin) {
          navAdmin.style.display = '';
        }
      } catch {
        // ignore
      }

      await loadMyPicks(user.id);
    }

    async function loadMyPicks(userId) {
      picksList.innerHTML = '<div class="muted-center">Loading your picks…</div>';

      // View that joins fixtures + your predictions + results
      const { data, error } = await supabase
        .from('user_picks_with_fixtures')
        .select('*')
        .eq('user_id', userId)
        .order('kickoff', { ascending: false });

      if (error) {
        console.error(error);
        picksList.innerHTML = '<div class="muted-center">Error loading picks.</div>';
        return;
      }

      if (!data || data.length === 0) {
        picksList.innerHTML = '<div class="muted-center">No picks yet. Go to the Predict page to get started.</div>';
        return;
      }

      picksList.innerHTML = '';
      data.forEach(row => {
        const card = document.createElement('div');
        card.className = 'fixture-row';

        const kickoffStr = row.kickoff
          ? new Date(row.kickoff).toLocaleString()
          : '';

        const yourScore =
          row.pred_home_goals != null && row.pred_away_goals != null
            ? `${row.pred_home_goals} - ${row.pred_away_goals}`
            : 'Not set';

        const resultScore =
          row.actual_home_goals != null && row.actual_away_goals != null
            ? `${row.actual_home_goals} - ${row.actual_away_goals}`
            : 'TBC';

        const pts = row.points != null ? row.points : '—';

        card.innerHTML = `
          <div class="fixture-main-info">
            <div class="fixture-teams">
              <div class="fixture-team">
                <span class="fixture-team-name">${escapeHtml(row.home_team || '')}</span>
              </div>
              <span class="fixture-vs">vs</span>
              <div class="fixture-team">
                <span class="fixture-team-name">${escapeHtml(row.away_team || '')}</span>
              </div>
            </div>
            <div class="fixture-meta">
              <span>${kickoffStr}</span>
              <span class="fixture-venue">${escapeHtml(row.venue || '')}</span>
            </div>
          </div>
          <div class="fixture-inputs" style="flex-direction:column; align-items:flex-end; gap:4px;">
            <div class="picks-line">
              <span class="label">Your pick</span>
              <span class="value">${yourScore}</span>
            </div>
            <div class="picks-line">
              <span class="label">Result</span>
              <span class="value">${resultScore}</span>
            </div>
            <div class="picks-line">
              <span class="label">Points</span>
              <span class="value">${pts}</span>
            </div>
          </div>
        `;
        picksList.appendChild(card);
      });
    }

    function escapeHtml(str = '') {
      return String(str).replace(/[&<>"']/g, ch => {
        switch (ch) {
          case '&': return '&amp;';
          case '<': return '&lt;';
          case '>': return '&gt;';
          case '"': return '&quot;';
          case "'": return '&#39;';
          default: return ch;
        }
      });
    }

    boot();
  </script>
</body>
</html>
