<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>My Picks • Weekend Predictor</title>
  <link rel="stylesheet" href="brand.css?v=107" />
  <style>
    /* Remove any hero/logo/wallpaper on this page */
    body { background: #f8fafc !important; background-image: none !important; }
    .hero, .page-hero, .wall, .wallpaper, .bg-hero, .brand-hero,
    .logo, .logo-wrap, img.logo, header img[alt*="logo"],
    .prem-hero, img[src*="prem-hero"], .prem-hero-img { display: none !important; }

    .wrap{max-width:1000px;margin:0 auto;padding:16px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;
          box-shadow:0 8px 20px rgba(0,0,0,.08);padding:16px;margin-bottom:16px}
    h1{margin:0 0 8px;color:#1f357a}
    .muted{color:#64748b}
    .top .bar{display:flex;align-items:center;justify-content:space-between;padding:12px 16px}
    .brand{display:flex;align-items:center;gap:8px;color:#1f357a;text-decoration:none;font-weight:900}
    .brand .badge{display:inline-flex;height:28px;align-items:center;padding:0 10px;border-radius:999px;background:#1f357a;color:#fff;border:1px solid #1f357a}
    .nav a{margin-left:14px;text-decoration:none;color:#334155;font-weight:700}
    .nav a.active{color:#1f357a}
    .nav .logout{color:#dc2626}

    table{width:100%;border-collapse:separate;border-spacing:0;border:1px solid #e5e7eb;border-radius:12px;overflow:hidden}
    thead th{background:#f8fafc;color:#334155;font-weight:800;text-align:left;padding:10px;border-bottom:1px solid #e5e7eb}
    tbody td{padding:10px;border-bottom:1px solid #eef2f7}
    tbody tr:last-child td{border-bottom:none}
    .right{text-align:right}
    .center{text-align:center}
    .pill{font-size:.75rem;padding:3px 8px;border-radius:999px;background:#eef2ff;color:#1f357a;border:1px solid #c7d2fe;display:inline-block}
    .pill.locked{background:#ecfdf5;color:#065f46;border-color:#a7f3d0}
    .pill.open{background:#fef3c7;color:#92400e;border-color:#fde68a}
    .empty{padding:16px;border:1px dashed #cbd5e1;border-radius:12px;text-align:center;color:#64748b}
    .meta{color:#475569;font-size:.9rem}
    .grid-2{display:grid;grid-template-columns:1fr 320px;gap:16px}
    @media (max-width: 960px){ .grid-2{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <header class="top">
    <div class="bar">
      <a class="brand" href="index.html">
        <div class="badge">WP</div>
        Weekend Predictor
      </a>
      <nav class="nav">
        <a href="predict.html" data-nav="predict">Predict</a>
        <a href="my-picks.html" data-nav="my-picks" class="active">My Picks</a>
        <a href="leaderboard.html" data-nav="leaderboard">Leaderboard</a>
        <a href="profile.html" data-nav="profile">Profile</a>
        <a href="rivals.html" data-nav="rivals">Rivals</a>
        <a href="admin.html" id="navAdmin" style="display:none">Admin</a>
        <a class="logout" id="navLogout" href="login.html">Logout</a>
      </nav>
    </div>
  </header>

  <main class="wrap grid-2">
    <section class="card">
      <h1>My picks</h1>
      <div class="muted" style="margin-bottom:12px">Your most recent selections.</div>

      <div id="empty" class="empty" style="display:none">
        No picks found for your account.
      </div>

      <div id="tableWrap" style="display:none">
        <table aria-label="Your picks">
          <thead>
            <tr>
              <th>Fixture</th>
              <th class="center">Your Pick</th>
              <th class="center">Result</th>
              <th class="right">Status</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
        <div class="meta" id="lastUpdated" style="margin-top:6px"></div>
      </div>
    </section>

    <aside class="card">
      <div class="meta"><strong>Tip:</strong> Once your picks are <em>locked</em>, they cannot be changed.</div>
      <div class="meta" style="margin-top:6px">Head-to-head: try the new <a href="rivals.html"><strong>Rivals</strong></a> page.</div>
    </aside>
  </main>

  <!-- Auth + logout wiring -->
  <script type="module">
    import { supabase } from './supabase-config.js';
    document.addEventListener('DOMContentLoaded', ()=>{
      const navLogout = document.getElementById('navLogout');
      navLogout?.addEventListener('click', async (e)=>{
        e.preventDefault();
        try{ await supabase.auth.signOut(); }catch{}
        window.location.replace('login.html');
      });
    });
  </script>

  <!-- Page logic (no week filter; multiple sources; buttonless) -->
  <script type="module">
    import { supabase } from './supabase-config.js';

    const $ = (id)=> document.getElementById(id);
    const tbody = $('tbody');
    const empty = $('empty');
    const tableWrap = $('tableWrap');
    const lastUpdated = $('lastUpdated');
    const navAdmin = $('navAdmin');

    const bool = (v)=> v === true || v === 'true' || v === 1;

    function pickScore(r){
      const hg = r.home_goals ?? r.home_score ?? r.h ?? r.pred_home ?? r.home_prediction ?? null;
      const ag = r.away_goals ?? r.away_score ?? r.a ?? r.pred_away ?? r.away_prediction ?? null;
      if (hg == null && ag == null) return '—';
      return `${hg ?? '–'} : ${ag ?? '–'}`;
    }
    function pickTeams(r){
      const home = r.home_team ?? r.home ?? r.home_name ?? r.ht ?? 'Home';
      const away = r.away_team ?? r.away ?? r.away_name ?? r.at ?? 'Away';
      return `${home} vs ${away}`;
    }

    async function ensureAdmin(uid){
      try{
        const { data } = await supabase.from('profiles').select('is_admin').eq('id', uid).maybeSingle();
        if (data?.is_admin) navAdmin.style.display = '';
      }catch{}
    }

    // 1) RPCs first (no date filter; most recent 30)
    async function loadFromRPC(uid){
      const rpcNames = ['my_picks','get_my_picks','week_picks'];
      for (const fn of rpcNames){
        try{
          const { data, error } = await supabase.rpc(fn, { uid });
          if (!error && Array.isArray(data) && data.length) {
            // sort newest first if created_at exists
            data.sort((a,b)=> new Date(b.created_at||0) - new Date(a.created_at||0));
            return data.slice(0,30);
          }
        }catch{}
      }
      return null;
    }

    // 2) Tables/views (self rows; no week filter; most recent 30)
    async function loadFromTables(uid){
      const sources = [
        { table:'predictions' },
        { table:'picks' },
        { table:'user_picks' },
        { table:'vw_my_picks' }
      ];
      for (const s of sources){
        try{
          const { data, error } = await supabase
            .from(s.table)
            .select('fixture_id, home_team, away_team, home_goals, away_goals, result, result_text, locked, created_at, home, away, home_score, away_score, h, a, pred_home, pred_away, home_prediction, away_prediction')
            .eq('user_id', uid)
            .order('created_at', { ascending: false })
            .limit(30);
          if (!error && Array.isArray(data) && data.length) return data;
        }catch{}
      }
      return null;
    }

    async function loadMyPicks(uid){
      const rpcRows = await loadFromRPC(uid);
      if (rpcRows) return rpcRows;
      const tblRows = await loadFromTables(uid);
      if (tblRows) return tblRows;
      return [];
    }

    function render(rows){
      tbody.innerHTML = '';
      if (!rows?.length){
        tableWrap.style.display = 'none';
        empty.style.display = '';
        return;
      }
      tableWrap.style.display = '';
      empty.style.display = 'none';

      rows.forEach(r=>{
        const tr = document.createElement('tr');
        const fixture = pickTeams(r);
        const pick = pickScore(r);
        const res = r.result_text ?? r.result ?? '—';
        const locked = bool(r.locked);
        tr.innerHTML = `
          <td>${fixture}</td>
          <td class="center"><strong>${pick}</strong></td>
          <td class="center">${res}</td>
          <td class="right"><span class="pill ${locked?'locked':'open'}">${locked?'Locked':'Open'}</span></td>
        `;
        tbody.appendChild(tr);
      });
      lastUpdated.textContent = `Showing your most recent ${rows.length} picks`;
    }

    (async ()=>{
      const { data:{ session } } = await supabase.auth.getSession();
      if (!session?.user){ window.location.replace('login.html'); return; }
      const uid = session.user.id;

      await ensureAdmin(uid);

      const rows = await loadMyPicks(uid);
      render(rows);
    })();
  </script>
</body>
</html>
