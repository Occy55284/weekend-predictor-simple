<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>My Picks • Weekend Predictor</title>
  <link rel="stylesheet" href="brand.css?v=96" />
  <style>
    .small-note { margin-top: 8px; font-size: 0.85rem; }
    .muted-center { text-align: center; color: #9ca3af; font-size: 0.9rem; }
    .pill {
      font-size: .75rem;
      padding: 3px 8px;
      border-radius: 999px;
      display: inline-block;
      border: 1px solid rgba(148,163,184,0.8);
    }
    .pill.locked {
      background: #ecfdf5;
      color: #065f46;
      border-color: #a7f3d0;
    }
    .pill.open {
      background: #fefce8;
      color: #854d0e;
      border-color: #facc15;
    }
  </style>
</head>
<body class="bg-hero">
  <div class="page-shell">
    <header class="top-nav">
      <div class="top-nav-left">
        <div class="nav-logo">
          <img src="assets/brand-logo.png" alt="Weekend Predictor logo" />
        </div>
        <div class="nav-text-group">
          <div class="nav-title">Weekend Predictor</div>
          <div class="nav-subtitle">Premier League prediction challenge</div>
        </div>
      </div>
      <nav class="top-nav-links">
        <a href="index.html">Home</a>
        <a href="predict.html">Predict</a>
        <a href="leaderboard.html">Leaderboard</a>
        <a href="my-picks.html" class="active">My Picks</a>
        <a href="all-picks.html">All Picks</a>
        <a href="stats.html">Stats</a>
        <a href="wallet.html">Wallet</a>
        <a href="profile.html">Profile</a>
        <a href="admin.html" id="navAdmin" style="display:none">Admin</a>
        <a href="#" id="navLogout">Logout</a>
      </nav>
    </header>

    <main class="main-layout">
      <section class="panel panel-main">
        <div class="panel-inner">
          <h1>My picks</h1>
          <p class="muted">
            Your predictions for this week’s featured fixtures.
          </p>

          <div class="user-banner">
            Signed in as: <span id="userEmail"></span>
          </div>

          <p class="muted small-note">
            Picks are shown for the current gameweek (Mon–Sun). Once games kick off,
            fixtures will gradually move from “Open” to “Locked”.
          </p>

          <div id="empty" class="muted-center" style="margin-top:14px; display:none;">
            No picks yet for this week. Go to the Predict page to make your selections.
          </div>

          <div id="tableWrap" class="table-wrapper" style="margin-top: 14px; display:none;">
            <table class="table">
              <thead>
                <tr>
                  <th>Fixture</th>
                  <th>Your pick</th>
                  <th>Result</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="tbody">
                <tr>
                  <td colspan="4" class="muted-center">Loading your picks…</td>
                </tr>
              </tbody>
            </table>
          </div>

          <p id="lastUpdated" class="muted" style="margin-top:8px;font-size:0.8rem;"></p>
        </div>
      </section>

      <aside class="panel panel-side">
        <div class="panel-inner">
          <h2>Quick tips</h2>
          <ul class="bullet-list muted">
            <li>Use this page to double-check your scores before kick-off.</li>
            <li>“Locked” fixtures are in progress or finished – no changes allowed.</li>
            <li>Compare your picks with the actual results to spot patterns.</li>
          </ul>
        </div>
      </aside>
    </main>
  </div>

  <!-- Logout -->
  <script type="module">
    import { supabase } from './supabase-config.js';
    document.addEventListener('DOMContentLoaded', () => {
      const navLogout = document.getElementById('navLogout');
      navLogout?.addEventListener('click', async (e) => {
        e.preventDefault();
        try { await supabase.auth.signOut(); } catch {}
        window.location.replace('login.html');
      });
    });
  </script>

  <!-- Page logic: picks (picks) + fixture details (fixtures) -->
  <script type="module">
    import { supabase } from './supabase-config.js';

    const $ = (id) => document.getElementById(id);
    const tbody = $('tbody');
    const empty = $('empty');
    const wrap = $('tableWrap');
    const lastUpdated = $('lastUpdated');
    const navAdmin = $('navAdmin');
    const userEmailEl = $('userEmail');

    const pad = (n) => String(n).padStart(2, '0');
    const startOfWeek = (d = new Date()) => {
      const x = new Date(d);
      const day = x.getDay(); // 0 Sun, 1 Mon...
      x.setHours(0, 0, 0, 0);
      const diff = day === 0 ? -6 : 1 - day; // Monday start
      x.setDate(x.getDate() + diff);
      return x;
    };
    const isoDate = (d) =>
      `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}`;

    const bool = (v) =>
      v === true || v === 'true' || v === 1;

    const pickScore = (p) => {
      const hg =
        p.home ??
        p.home_goals ??
        p.home_score ??
        p.h ??
        p.pred_home ??
        null;
      const ag =
        p.away ??
        p.away_goals ??
        p.away_score ??
        p.a ??
        p.pred_away ??
        null;
      if (hg == null && ag == null) return '—';
      return `${hg ?? '–'} : ${ag ?? '–'}`;
    };

    const resultFromFixture = (f) => {
      const hs = f.home_score ?? f.hs ?? null;
      const as = f.away_score ?? f.as ?? null;
      if (hs == null && as == null) return '—';
      return `${hs ?? '–'} : ${as ?? '–'}`;
    };

    const lockedFromFixture = (f) => {
      const k =
        f.utc_date ??
        f.kickoff ??
        f.kickoff_at ??
        f.start_time ??
        f.datetime ??
        null;
      const t =
        typeof k === 'string' || k instanceof String
          ? Date.parse(k)
          : k instanceof Date
          ? k.getTime()
          : null;
      if (Number.isFinite(t)) return Date.now() >= t;
      return false;
    };

    function render(rows) {
      tbody.innerHTML = '';
      if (!rows?.length) {
        wrap.style.display = 'none';
        empty.style.display = '';
        lastUpdated.textContent = '';
        return;
      }
      wrap.style.display = '';
      empty.style.display = 'none';

      rows.forEach((r) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>
            ${r.fixtureHtml}
            ${
              r.subHtml
                ? `<div class="muted" style="font-size:.85rem">${r.subHtml}</div>`
                : ''
            }
          </td>
          <td class="center"><strong>${r.pick}</strong></td>
          <td class="center">${r.result}</td>
          <td class="right">
            <span class="pill ${r.locked ? 'locked' : 'open'}">
              ${r.locked ? 'Locked' : 'Open'}
            </span>
          </td>
        `;
        tbody.appendChild(tr);
      });
      lastUpdated.textContent = `Loaded ${rows.length} pick${
        rows.length === 1 ? '' : 's'
      }.`;
    }

    (async () => {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session?.user) {
        window.location.replace('login.html');
        return;
      }
      const uid = session.user.id;
      userEmailEl.textContent = session.user.email || '';

      // Admin link
      try {
        const { data } = await supabase
          .from('profiles')
          .select('is_admin')
          .eq('id', uid)
          .maybeSingle();
        if (data?.is_admin) navAdmin.style.display = '';
      } catch {}

      const weekStart = isoDate(startOfWeek(new Date()));

      // 1) Picks for this week
      const { data: picks, error: pkErr } = await supabase
        .from('picks')
        .select('fixture_id, week_start, home, away, user_id')
        .eq('user_id', uid)
        .eq('week_start', weekStart)
        .order('fixture_id', { ascending: true });

      if (pkErr || !picks?.length) {
        render([]);
        return;
      }

      // 2) Fixture details
      const ids = [...new Set(picks.map((p) => p.fixture_id))];
      const { data: fixtures } = await supabase
        .from('fixtures')
        .select(
          'id, utc_date, status, competition, matchday, home_team, away_team, home_score, away_score'
        )
        .in('id', ids);

      const byId = new Map((fixtures || []).map((f) => [String(f.id), f]));

      // 3) Compose rows
      const rows = picks.map((p) => {
        const fx = byId.get(String(p.fixture_id));
        const homeName = fx?.home_team ?? `Fixture #${p.fixture_id}`;
        const awayName = fx?.away_team ?? '';
        const fixtureHtml = awayName
          ? `<strong>${homeName}</strong> vs <strong>${awayName}</strong>`
          : homeName;

        const subBits = [];
        if (fx?.utc_date) {
          const dt = new Date(fx.utc_date);
          if (!isNaN(dt)) {
            subBits.push(
              `${dt.toLocaleDateString()} ${dt.toLocaleTimeString([], {
                hour: '2-digit',
                minute: '2-digit',
              })}`
            );
          }
        }
        if (fx?.status) {
          const s = String(fx.status).toUpperCase();
          subBits.push(
            s === 'IN_PLAY'
              ? 'Live'
              : s === 'FINISHED'
              ? 'FT'
              : s === 'SCHEDULED'
              ? 'Scheduled'
              : s
          );
        }

        return {
          fixtureHtml,
          subHtml: subBits.join(' • '),
          pick: pickScore(p),
          result: fx ? resultFromFixture(fx) : '—',
          locked: fx ? lockedFromFixture(fx) : false,
        };
      });

      render(rows);
    })();
  </script>
</body>
</html>
