<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>My Picks Â· Occy Weekend Football</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
  <link rel="stylesheet" href="brand.css" />
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>My Picks</h1>
      <p class="muted">Read-only view of your submitted predictions for the current weekend.</p>
    </div>

    <div class="card">
      <div id="who" class="muted">â€”</div>
      <p id="week" class="muted">â€”</p>

      <table id="tbl" style="display:none">
        <thead>
          <tr>
            <th class="left">Fixture</th>
            <th>Kickoff</th>
            <th>Your Pick</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>

      <p id="msg" class="muted">Loadingâ€¦</p>
      <div class="btn-row" style="margin-top:10px">
        <a class="btn btn-dark" href="index.html">â† Home</a>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase-config.js"></script>
  <script>
    const client = supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);

    function fmt(dt){ return new Date(dt).toLocaleString(undefined,{weekday:'short',month:'short',day:'2-digit',hour:'2-digit',minute:'2-digit'}); }

    async function load(){
      const { data: ur } = await client.auth.getUser();
      const u = ur?.user; if(!u){ location.replace('login.html'); return; }

      document.getElementById('who').textContent = `Signed in as ${u.email}`;

      // Find this weekendâ€™s featured fixtures (earliest date is our week key)
      const nowIso = new Date().toISOString();
      const { data: fixes } = await client.from('fixtures')
        .select('id,home_team,away_team,utc_date')
        .eq('featured', true)
        .gt('utc_date', nowIso)
        .order('utc_date');

      if (!fixes || !fixes.length){
        document.getElementById('msg').textContent = 'No upcoming featured fixtures yet.';
        return;
      }

      const weekStart = fixes[0].utc_date.slice(0,10);
      document.getElementById('week').textContent = `Weekend starting ${new Date(weekStart).toLocaleDateString()}`;

      // Pull my predictions for these fixtures
      const ids = fixes.map(f=>f.id);
      const { data: picks } = await client.from('predictions')
        .select('fixture_id,home_goals,away_goals')
        .eq('user_id', u.id)
        .in('fixture_id', ids);

      const pickByFx = Object.fromEntries((picks||[]).map(p=>[p.fixture_id, p]));
      const rows = document.getElementById('rows');
      rows.innerHTML='';

      fixes.forEach(f=>{
        const p = pickByFx[f.id];
        const tr = document.createElement('tr');
        const locked = Date.now() >= new Date(f.utc_date).getTime();
        tr.innerHTML = `
          <td class="left">${f.home_team} vs ${f.away_team}</td>
          <td>${fmt(f.utc_date)}</td>
          <td>${p ? `${p.home_goals} â€“ ${p.away_goals}` : '<span class="muted">â€”</span>'}</td>
          <td>${locked?'<span class="pill lock">Locked ğŸ”’</span>':'Open'}</td>
        `;
        rows.appendChild(tr);
      });

      document.getElementById('tbl').style.display='';
      document.getElementById('msg').textContent='';
    }
    load();
  </script>
</body>
</html>
