<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>My Picks â€¢ Weekend Predictor</title>
  <link rel="stylesheet" href="brand.css" />
  <script defer src="supabase-config.js"></script>
  <script>
    let currentUser = null;

    async function checkAuth() {
      const { data: { session } } = await supabase.auth.getSession();
      currentUser = session?.user || null;

      if (!currentUser) {
        window.location.href = 'login.html';
        return;
      }

      document.getElementById('user-email').textContent =
        currentUser.email || 'Logged in';

      loadMyPicks();
    }

    async function loadMyPicks() {
      const container = document.getElementById('picks');
      container.innerHTML = '<p class="muted">Loading your picks...</p>';

      const { data, error } = await supabase
        .from('user_picks_with_fixtures')
        .select('*')
        .eq('user_id', currentUser.id)
        .order('kickoff', { ascending: true });

      if (error) {
        console.error(error);
        container.innerHTML = '<p class="muted">Error loading picks.</p>';
        return;
      }

      if (!data || data.length === 0) {
        container.innerHTML = '<p class="muted">No picks yet. Go to the Predict page to make your selections.</p>';
        return;
      }

      container.innerHTML = '';
      data.forEach(row => {
        const card = document.createElement('div');
        card.className = 'fixture-row';

        const scoreString =
          row.pred_home_goals !== null && row.pred_away_goals !== null
            ? `${row.pred_home_goals} - ${row.pred_away_goals}`
            : 'Not set';

        const resultScore =
          row.actual_home_goals !== null && row.actual_away_goals !== null
            ? `${row.actual_home_goals} - ${row.actual_away_goals}`
            : 'TBC';

        card.innerHTML = `
          <div class="fixture-main-info">
            <div class="fixture-teams">
              <div class="fixture-team">
                <span class="fixture-team-name">${row.home_team}</span>
              </div>
              <span class="fixture-vs">vs</span>
              <div class="fixture-team">
                <span class="fixture-team-name">${row.away_team}</span>
              </div>
            </div>
            <div class="fixture-meta">
              <span>${new Date(row.kickoff).toLocaleString()}</span>
              <span class="fixture-venue">${row.venue || ''}</span>
            </div>
          </div>
          <div class="fixture-inputs">
            <div class="picks-line">
              <span class="label">Your pick</span>
              <span class="value">${scoreString}</span>
            </div>
            <div class="picks-line">
              <span class="label">Result</span>
              <span class="value">${resultScore}</span>
            </div>
            <div class="picks-line">
              <span class="label">Points</span>
              <span class="value">${row.points ?? '-'}</span>
            </div>
          </div>
        `;
        container.appendChild(card);
      });
    }

    document.addEventListener('DOMContentLoaded', checkAuth);
  </script>
</head>
<body>
  <div class="page-shell">
    <header class="top-nav">
      <div class="top-nav-left">
        <div class="nav-logo">
          <img src="assets/brand-logo.png" alt="Weekend Predictor logo" />
        </div>
        <div class="nav-text-group">
          <div class="nav-title">Weekend Predictor</div>
          <div class="nav-subtitle">Premier League prediction challenge</div>
        </div>
      </div>
      <nav class="top-nav-links">
        <a href="index.html">Home</a>
        <a href="leaderboard.html">Leaderboard</a>
        <a href="predict.html">Predict</a>
        <a href="profile.html">Profile</a>
        <a href="admin.html">Admin</a>
      </nav>
    </header>

    <main class="main-layout">
      <section class="panel panel-main">
        <div class="panel-inner">
          <h1>My picks</h1>
          <p class="muted">
            A quick view of all your predictions and how they performed once results are in.
          </p>

          <div class="user-banner">
            Signed in as: <span id="user-email"></span>
          </div>

          <div id="picks" class="fixtures-list"></div>
        </div>
      </section>

      <aside class="panel panel-side">
        <div class="panel-inner">
          <h2>What you can see</h2>
          <ul class="muted bullet-list">
            <li>Your predicted score for each fixture.</li>
            <li>The actual result once the match is played.</li>
            <li>Points earned for each prediction.</li>
          </ul>

          <div class="info-card">
            <div class="info-label">Note</div>
            <p class="info-text">
              Points will appear after results are entered into the system.
            </p>
          </div>
        </div>
      </aside>
    </main>
  </div>
</body>
</html>
