<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>My Picks • Weekend Predictor</title>
  <link rel="stylesheet" href="brand.css?v=105" />
  <style>
    /* Remove any hero/logo/wallpaper on this page */
    body { background: #f8fafc !important; background-image: none !important; }
    .hero, .page-hero, .wall, .wallpaper, .bg-hero, .brand-hero,
    .logo, .logo-wrap, img.logo, header img[alt*="logo"],
    .prem-hero, img[src*="prem-hero"], .prem-hero-img { display: none !important; }

    .wrap{max-width:1000px;margin:0 auto;padding:16px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;
          box-shadow:0 8px 20px rgba(0,0,0,.08);padding:16px;margin-bottom:16px}
    h1{margin:0 0 8px;color:#1f357a}
    .muted{color:#64748b}
    .top .bar{display:flex;align-items:center;justify-content:space-between;padding:12px 16px}
    .brand{display:flex;align-items:center;gap:8px;color:#1f357a;text-decoration:none;font-weight:900}
    .brand .badge{display:inline-flex;height:28px;align-items:center;padding:0 10px;border-radius:999px;background:#1f357a;color:#fff;border:1px solid #1f357a}
    .nav a{margin-left:14px;text-decoration:none;color:#334155;font-weight:700}
    .nav a.active{color:#1f357a}
    .nav .logout{color:#dc2626}
    .tools{display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin:8px 0 16px}
    .btn{display:inline-flex;align-items:center;justify-content:center;height:36px;padding:0 12px;border-radius:10px;border:1px solid #cbd5e1;background:#fff;color:#111827;font-weight:700;cursor:pointer;text-decoration:none}
    .btn.primary{background:#1f357a;color:#fff;border-color:#1f357a}
    table{width:100%;border-collapse:separate;border-spacing:0;border:1px solid #e5e7eb;border-radius:12px;overflow:hidden}
    thead th{background:#f8fafc;color:#334155;font-weight:800;text-align:left;padding:10px;border-bottom:1px solid #e5e7eb}
    tbody td{padding:10px;border-bottom:1px solid #eef2f7}
    tbody tr:last-child td{border-bottom:none}
    .right{text-align:right}
    .center{text-align:center}
    .pill{font-size:.75rem;padding:3px 8px;border-radius:999px;background:#eef2ff;color:#1f357a;border:1px solid #c7d2fe;display:inline-block}
    .pill.locked{background:#ecfdf5;color:#065f46;border-color:#a7f3d0}
    .pill.open{background:#fef3c7;color:#92400e;border-color:#fde68a}
    .empty{padding:16px;border:1px dashed #cbd5e1;border-radius:12px;text-align:center;color:#64748b}
    .meta{color:#475569;font-size:.9rem}
    .grid-2{display:grid;grid-template-columns:1fr 320px;gap:16px}
    @media (max-width: 960px){ .grid-2{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <header class="top">
    <div class="bar">
      <a class="brand" href="index.html">
        <div class="badge">WP</div>
        Weekend Predictor
      </a>
      <nav class="nav">
        <a href="predict.html" data-nav="predict">Predict</a>
        <a href="my-picks.html" data-nav="my-picks" class="active">My Picks</a>
        <a href="leaderboard.html" data-nav="leaderboard">Leaderboard</a>
        <a href="profile.html" data-nav="profile">Profile</a>
        <a href="rivals.html" data-nav="rivals">Rivals</a>
        <a href="admin.html" id="navAdmin" style="display:none">Admin</a>
        <a class="logout" id="navLogout" href="login.html">Logout</a>
      </nav>
    </div>
  </header>

  <main class="wrap grid-2">
    <section class="card">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:8px">
        <h1>My picks</h1>
        <div class="tools">
          <a class="btn" href="predict.html">Make / edit predictions</a>
          <button id="refresh" class="btn">Refresh</button>
        </div>
      </div>
      <div class="muted" style="margin-bottom:12px">Your selections for the current gameweek.</div>

      <div id="empty" class="empty" style="display:none">
        You haven’t made any picks for this week yet.<br/>
        <a href="predict.html" class="btn primary" style="margin-top:10px">Make predictions</a>
      </div>

      <div id="tableWrap" style="display:none">
        <table aria-label="Your picks">
          <thead>
            <tr>
              <th>Fixture</th>
              <th class="center">Your Pick</th>
              <th class="center">Result</th>
              <th class="right">Status</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
        <div class="meta" id="lastUpdated" style="margin-top:6px"></div>
      </div>
    </section>

    <aside class="card">
      <div class="meta"><strong>Tip:</strong> Once your picks are <em>locked</em>, they cannot be changed.</div>
      <div class="meta" style="margin-top:6px">Head-to-head: try the new <a href="rivals.html"><strong>Rivals</strong></a> page.</div>
    </aside>
  </main>

  <!-- Auth + logout wiring -->
  <script type="module">
    import { supabase } from './supabase-config.js';
    document.addEventListener('DOMContentLoaded', ()=>{
      const navLogout = document.getElementById('navLogout');
      navLogout?.addEventListener('click', async (e)=>{
        e.preventDefault();
        try{ await supabase.auth.signOut(); }catch{}
        window.location.replace('login.html');
      });
    });
  </script>

  <!-- Page logic (RPC first, with graceful fallbacks; no hero/logo) -->
  <script type="module">
    import { supabase } from './supabase-config.js';

    // --- Helpers ---
    const $ = (id)=> document.getElementById(id);
    const tbody = $('tbody');
    const empty = $('empty');
    const tableWrap = $('tableWrap');
    const lastUpdated = $('lastUpdated');
    const refreshBtn = $('refresh');
    const navAdmin = $('navAdmin');

    function pad(n){ return String(n).padStart(2,'0'); }
    function startOfWeek(d=new Date()){
      const x = new Date(d);
      const day = x.getDay(); // 0=Sun ... 1=Mon
      x.setHours(0,0,0,0);
      // Make Monday the start
      const diff = (day === 0 ? -6 : 1 - day);
      x.setDate(x.getDate() + diff);
      return x;
    }
    function isoDate(d){ return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }
    function fmt(n){ return n ?? '—'; }
    function pickScoreRow(r){
      // supports columns from common schemas
      const hg = (r.home_goals ?? r.home_score ?? r.h ?? null);
      const ag = (r.away_goals ?? r.away_score ?? r.a ?? null);
      return (hg ?? ag) !== null ? `${hg ?? '–'} : ${ag ?? '–'}` : '—';
    }
    function bool(v){ return v === true || v === 'true' || v === 1; }

    async function checkAdmin(uid){
      try{
        const { data, error } = await supabase.from('profiles').select('is_admin').eq('id', uid).maybeSingle();
        if (!error && data?.is_admin) navAdmin.style.display = '';
      }catch{}
    }

    // --- Data loaders ---
    async function loadMyPicks(uid){
      const ws = startOfWeek(new Date());
      const weekStartIso = isoDate(ws);

      // 1) Try RPC my_picks({ uid, week_start })
      try{
        const { data, error } = await supabase.rpc('my_picks', { uid, week_start: weekStartIso });
        if (!error && Array.isArray(data) && data.length) return data;
      }catch{}

      // 2) Fallback table: predictions (self rows)
      try{
        const { data, error } = await supabase
          .from('predictions')
          .select('fixture_id, home_team, away_team, home_goals, away_goals, result, locked, created_at, week_start')
          .eq('user_id', uid)
          .gte('week_start', weekStartIso)
          .order('created_at', { ascending: true });
        if (!error && Array.isArray(data) && data.length) return data;
      }catch{}

      // 3) Fallback table: picks (self rows)
      try{
        const { data, error } = await supabase
          .from('picks')
          .select('fixture_id, home_team, away_team, home_goals, away_goals, result, locked, created_at, week_start')
          .eq('user_id', uid)
          .gte('week_start', weekStartIso)
          .order('created_at', { ascending: true });
        if (!error && Array.isArray(data) && data.length) return data;
      }catch{}

      return [];
    }

    function renderRows(rows){
      tbody.innerHTML = '';
      if (!rows?.length){
        tableWrap.style.display = 'none';
        empty.style.display = '';
        return;
      }

      tableWrap.style.display = '';
      empty.style.display = 'none';

      rows.forEach(r=>{
        const tr = document.createElement('tr');
        const fixture = `${r.home_team ?? r.home ?? 'Home'} vs ${r.away_team ?? r.away ?? 'Away'}`;
        const you = pickScoreRow(r);
        const res = r.result ?? r.result_text ?? '—';
        const locked = bool(r.locked);
        tr.innerHTML = `
          <td>${fixture}</td>
          <td class="center"><strong>${you}</strong></td>
          <td class="center">${res}</td>
          <td class="right"><span class="pill ${locked?'locked':'open'}">${locked?'Locked':'Open'}</span></td>
        `;
        tbody.appendChild(tr);
      });
      lastUpdated.textContent = `Updated ${new Date().toLocaleTimeString()}`;
    }

    (async ()=>{
      // Require sign-in
      const { data:{ session } } = await supabase.auth.getSession();
      if (!session?.user){ window.location.replace('login.html'); return; }
      const uid = session.user.id;

      await checkAdmin(uid);

      // Load & render
      const rows = await loadMyPicks(uid);
      renderRows(rows);

      refreshBtn.addEventListener('click', async ()=>{
        const rows2 = await loadMyPicks(uid);
        renderRows(rows2);
      });
    })();
  </script>
</body>
</html>
