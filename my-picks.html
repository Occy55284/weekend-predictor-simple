<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>My Picks • Weekend Predictor</title>
  <link rel="stylesheet" href="brand.css?v=112" />
  <style>
    /* Nuke hero/logo/wallpaper */
    body { background: #f8fafc !important; background-image: none !important; }
    .hero,.page-hero,.wall,.wallpaper,.bg-hero,.brand-hero,
    .logo,.logo-wrap,img.logo,header img[alt*="logo"],
    .prem-hero,img[src*="prem-hero"],.prem-hero-img { display:none!important; }

    .wrap{max-width:1000px;margin:0 auto;padding:16px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;
      box-shadow:0 8px 20px rgba(0,0,0,.08);padding:16px;margin-bottom:16px}
    h1{margin:0 0 8px;color:#1f357a}
    .muted{color:#64748b}
    .top .bar{display:flex;align-items:center;justify-content:space-between;padding:12px 16px}
    .brand{display:flex;align-items:center;gap:8px;color:#1f357a;text-decoration:none;font-weight:900}
    .brand .badge{display:inline-flex;height:28px;align-items:center;padding:0 10px;border-radius:999px;background:#1f357a;color:#fff;border:1px solid #1f357a}
    .nav a{margin-left:14px;text-decoration:none;color:#334155;font-weight:700}
    .nav a.active{color:#1f357a}
    .nav .logout{color:#dc2626}

    table{width:100%;border-collapse:separate;border-spacing:0;border:1px solid #e5e7eb;border-radius:12px;overflow:hidden}
    thead th{background:#f8fafc;color:#334155;font-weight:800;text-align:left;padding:10px;border-bottom:1px solid #e5e7eb}
    tbody td{padding:10px;border-bottom:1px solid #eef2f7}
    tbody tr:last-child td{border-bottom:none}
    .right{text-align:right}
    .center{text-align:center}
    .pill{font-size:.75rem;padding:3px 8px;border-radius:999px;background:#eef2ff;color:#1f357a;border:1px solid #c7d2fe;display:inline-block}
    .pill.locked{background:#ecfdf5;color:#065f46;border-color:#a7f3d0}
    .pill.open{background:#fef3c7;color:#92400e;border-color:#fde68a}
    .empty{padding:16px;border:1px dashed #cbd5e1;border-radius:12px;text-align:center;color:#64748b}
    .meta{color:#475569;font-size:.9rem}
    .grid-2{display:grid;grid-template-columns:1fr 320px;gap:16px}
    @media (max-width: 960px){ .grid-2{grid-template-columns:1fr} }

    /* Debug (always visible) */
    details.debug{margin:10px 0 14px}
    .dbg{font-family:ui-monospace,Menlo,Consolas,monospace;white-space:pre-wrap;background:#0b1220;color:#d1e0ff;
      border-radius:12px;padding:12px;border:1px solid #1e293b;max-height:300px;overflow:auto}
    .dbg b{color:#93c5fd}
  </style>
</head>
<body>
  <header class="top">
    <div class="bar">
      <a class="brand" href="index.html">
        <div class="badge">WP</div>
        Weekend Predictor
      </a>
      <nav class="nav">
        <a href="predict.html" data-nav="predict">Predict</a>
        <a href="my-picks.html" data-nav="my-picks" class="active">My Picks</a>
        <a href="leaderboard.html" data-nav="leaderboard">Leaderboard</a>
        <a href="profile.html" data-nav="profile">Profile</a>
        <a href="rivals.html" data-nav="rivals">Rivals</a>
        <a href="admin.html" id="navAdmin" style="display:none">Admin</a>
        <a class="logout" id="navLogout" href="login.html">Logout</a>
      </nav>
    </div>
  </header>

  <main class="wrap grid-2">
    <section class="card">
      <h1>My picks</h1>
      <div class="muted" style="margin-bottom:6px">Your selections for the current gameweek.</div>

      <details class="debug" open>
        <summary><strong>Debug</strong> (what the server returned)</summary>
        <div class="dbg" id="debugBox">Loading…</div>
      </details>

      <div id="empty" class="empty" style="display:none">No picks found for your account.</div>

      <div id="tableWrap" style="display:none">
        <table aria-label="Your picks">
          <thead>
          <tr>
            <th>Fixture</th>
            <th class="center">Your Pick</th>
            <th class="center">Result</th>
            <th class="right">Status</th>
          </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
        <div class="meta" id="lastUpdated" style="margin-top:6px"></div>
      </div>
    </section>

    <aside class="card">
      <div class="meta"><strong>Tip:</strong> Once your picks are <em>locked</em>, they cannot be changed.</div>
      <div class="meta" style="margin-top:6px">Head-to-head: try the new <a href="rivals.html"><strong>Rivals</strong></a> page.</div>
    </aside>
  </main>

  <!-- Auth + logout wiring -->
  <script type="module">
    import { supabase } from './supabase-config.js';
    document.addEventListener('DOMContentLoaded', ()=>{
      const navLogout = document.getElementById('navLogout');
      navLogout?.addEventListener('click', async (e)=>{
        e.preventDefault();
        try{ await supabase.auth.signOut(); }catch{}
        window.location.replace('login.html');
      });
    });
  </script>

  <!-- Page logic: join picks with fixtures client-side -->
  <script type="module">
    import { supabase } from './supabase-config.js';

    const $ = id => document.getElementById(id);
    const tbody = $('tbody');
    const empty = $('empty');
    const wrap = $('tableWrap');
    const lastUpdated = $('lastUpdated');
    const dbg = $('debugBox');
    const navAdmin = $('navAdmin');

    // ---------- helpers ----------
    const pad = n => String(n).padStart(2,'0');
    const startOfWeek = (d=new Date())=>{
      const x = new Date(d);
      const day = x.getDay(); // 0 Sun, 1 Mon...
      x.setHours(0,0,0,0);
      const diff = (day === 0 ? -6 : 1 - day); // Monday start
      x.setDate(x.getDate() + diff);
      return x;
    };
    const isoDate = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    const bool = v => v === true || v === 'true' || v === 1;

    const log = (label, obj) => {
      const safe = v => (typeof v === 'string' ? v : JSON.stringify(v, null, 2));
      dbg.textContent += `\n\n=== ${label} ===\n` + safe(obj);
      console.log('[my-picks.debug]', label, obj);
    };

    function teamNamesFromFixture(f){
      const home = f.home_team ?? f.home_name ?? f.home ?? f.ht_name ?? f.homeTeam ?? f.ht ?? null;
      const away = f.away_team ?? f.away_name ?? f.away ?? f.at_name ?? f.awayTeam ?? f.at ?? null;
      return {
        home: home || `Fixture #${fixtureKey(f)}`,
        away: away || ''
      };
    }

    function fixtureKey(f){
      // common possibilities for the ID in fixture-like tables
      return f.fixture_id ?? f.id ?? f.match_id ?? f.game_id ?? f.event_id ?? null;
    }

    function kickoffMillis(f){
      const k = f.kickoff ?? f.kickoff_at ?? f.start_time ?? f.kickoff_time ?? f.date ?? f.datetime ?? null;
      const t = (typeof k === 'string' || k instanceof String) ? Date.parse(k) : (k instanceof Date ? k.getTime() : null);
      return Number.isFinite(t) ? t : null;
    }

    function lockedFromFixture(f){
      if (typeof f.locked !== 'undefined') return bool(f.locked);
      const ms = kickoffMillis(f);
      if (ms != null) return (Date.now() >= ms);
      return false;
    }

    function pickScore(p){
      const hg = p.home ?? p.home_goals ?? p.home_score ?? p.h ?? p.pred_home ?? null;
      const ag = p.away ?? p.away_goals ?? p.away_score ?? p.a ?? p.pred_away ?? null;
      if (hg == null && ag == null) return '—';
      return `${hg ?? '–'} : ${ag ?? '–'}`;
    }

    function render(rows){
      tbody.innerHTML = '';
      if (!rows?.length){ wrap.style.display='none'; empty.style.display=''; return; }
      wrap.style.display=''; empty.style.display='none';

      rows.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.fixtureText}</td>
          <td class="center"><strong>${r.pick}</strong></td>
          <td class="center">${r.result ?? '—'}</td>
          <td class="right"><span class="pill ${r.locked?'locked':'open'}">${r.locked?'Locked':'Open'}</span></td>
        `;
        tbody.appendChild(tr);
      });
      lastUpdated.textContent = `Loaded ${rows.length} pick${rows.length===1?'':'s'}.`;
    }

    // ---------- data loaders ----------
    async function loadPicks(uid, weekStart){
      // exact week (you already confirmed this returns rows)
      const { data, error } = await supabase
        .from('picks')
        .select('fixture_id, week_start, home, away, user_id, created_at')
        .eq('user_id', uid)
        .eq('week_start', weekStart)
        .order('fixture_id', { ascending:true });

      log('picks rows', { count: data?.length ?? 0, error: error?.message || null, keys: data?.[0] ? Object.keys(data[0]) : [] });
      return data || [];
    }

    async function loadFixturesForWeek(weekStart){
      // try several likely tables/views
      const candidates = ['fixtures','matches','games','schedule','vw_fixtures'];
      for (const table of candidates){
        try{
          const { data, error } = await supabase
            .from(table)
            .select('*')
            .eq('week_start', weekStart);
          if (!error && Array.isArray(data) && data.length){
            log(`fixtures source: ${table}`, { count: data.length, keys: Object.keys(data[0]) });
            return { table, rows: data };
          }else{
            if (error) log(`fixtures ${table} error`, error.message);
            else log(`fixtures ${table} empty`, { count: 0 });
          }
        }catch(e){
          log(`fixtures ${table} exception`, String(e));
        }
      }
      // As a fallback, try without week filter and just map by IDs (we’ll still match on fixture_id)
      for (const table of candidates){
        try{
          const { data, error } = await supabase.from(table).select('*').limit(200);
          if (!error && Array.isArray(data) && data.length){
            log(`fixtures fallback source: ${table}`, { count: data.length, keys: Object.keys(data[0]) });
            return { table, rows: data };
          }
        }catch(e){}
      }
      log('fixtures', 'No fixture table found.');
      return { table: null, rows: [] };
    }

    (async ()=>{
      dbg.textContent = '';

      const { data:{ session } } = await supabase.auth.getSession();
      if (!session?.user){ window.location.replace('login.html'); return; }
      const uid = session.user.id;

      // Admin link
      try{
        const { data } = await supabase.from('profiles').select('is_admin').eq('id', uid).maybeSingle();
        if (data?.is_admin) navAdmin.style.display = '';
      }catch{}

      const weekStart = isoDate(startOfWeek(new Date()));
      log('Computed week_start', weekStart);

      const picks = await loadPicks(uid, weekStart);

      // Build a lookup by fixture_id
      const wantIds = [...new Set(picks.map(p => p.fixture_id))];
      log('fixture ids', wantIds);

      const { table: fixtureTable, rows: fixtures } = await loadFixturesForWeek(weekStart);

      // Map fixtures by common id keys
      const byId = new Map();
      const idKeys = ['fixture_id','id','match_id','game_id','event_id'];
      for (const f of fixtures){
        const fidKey = idKeys.find(k => typeof f[k] !== 'undefined');
        if (fidKey) byId.set(String(f[fidKey]), f);
      }

      // Compose rows for display
      const out = picks.map(p => {
        const fx = byId.get(String(p.fixture_id)) || {};
        const names = teamNamesFromFixture(fx);
        const fixtureText = names.away
          ? `<strong>${names.home}</strong> vs <strong>${names.away}</strong>`
          : `Fixture #${p.fixture_id}`;
        const locked = lockedFromFixture(fx);
        // if fixture view has a result string, try to pick it up
        const result = fx.result_text ?? fx.result ?? null;

        return {
          fixtureText,
          pick: pickScore(p),
          result,
          locked
        };
      });

      if (!out.length){
        log('note', 'No rows to render — either no picks for this week, or fixture table not found / not joined by week_start. If you can tell me your fixture table name and its columns for team names + kickoff, I’ll wire it exactly.');
      }

      render(out);
    })();
  </script>
</body>
</html>
