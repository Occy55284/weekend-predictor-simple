<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>My Picks • Weekend Predictor</title>
  <link rel="stylesheet" href="brand.css?v=111" />
  <style>
    /* Nuke hero/logo/wallpaper */
    body { background: #f8fafc !important; background-image: none !important; }
    .hero,.page-hero,.wall,.wallpaper,.bg-hero,.brand-hero,
    .logo,.logo-wrap,img.logo,header img[alt*="logo"],
    .prem-hero,img[src*="prem-hero"],.prem-hero-img { display:none!important; }

    .wrap{max-width:1000px;margin:0 auto;padding:16px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;
      box-shadow:0 8px 20px rgba(0,0,0,.08);padding:16px;margin-bottom:16px}
    h1{margin:0 0 8px;color:#1f357a}
    .muted{color:#64748b}
    .top .bar{display:flex;align-items:center;justify-content:space-between;padding:12px 16px}
    .brand{display:flex;align-items:center;gap:8px;color:#1f357a;text-decoration:none;font-weight:900}
    .brand .badge{display:inline-flex;height:28px;align-items:center;padding:0 10px;border-radius:999px;background:#1f357a;color:#fff;border:1px solid #1f357a}
    .nav a{margin-left:14px;text-decoration:none;color:#334155;font-weight:700}
    .nav a.active{color:#1f357a}
    .nav .logout{color:#dc2626}

    table{width:100%;border-collapse:separate;border-spacing:0;border:1px solid #e5e7eb;border-radius:12px;overflow:hidden}
    thead th{background:#f8fafc;color:#334155;font-weight:800;text-align:left;padding:10px;border-bottom:1px solid #e5e7eb}
    tbody td{padding:10px;border-bottom:1px solid #eef2f7}
    tbody tr:last-child td{border-bottom:none}
    .right{text-align:right}
    .center{text-align:center}
    .pill{font-size:.75rem;padding:3px 8px;border-radius:999px;background:#eef2ff;color:#1f357a;border:1px solid #c7d2fe;display:inline-block}
    .pill.locked{background:#ecfdf5;color:#065f46;border-color:#a7f3d0}
    .pill.open{background:#fef3c7;color:#92400e;border-color:#fde68a}
    .empty{padding:16px;border:1px dashed #cbd5e1;border-radius:12px;text-align:center;color:#64748b}
    .meta{color:#475569;font-size:.9rem}
    .grid-2{display:grid;grid-template-columns:1fr 320px;gap:16px}
    @media (max-width: 960px){ .grid-2{grid-template-columns:1fr} }

    /* Debug (always visible) */
    details.debug{margin:10px 0 14px}
    .dbg{font-family:ui-monospace,Menlo,Consolas,monospace;white-space:pre-wrap;background:#0b1220;color:#d1e0ff;
      border-radius:12px;padding:12px;border:1px solid #1e293b;max-height:280px;overflow:auto}
    .dbg b{color:#93c5fd}
  </style>
</head>
<body>
  <header class="top">
    <div class="bar">
      <a class="brand" href="index.html">
        <div class="badge">WP</div>
        Weekend Predictor
      </a>
      <nav class="nav">
        <a href="predict.html" data-nav="predict">Predict</a>
        <a href="my-picks.html" data-nav="my-picks" class="active">My Picks</a>
        <a href="leaderboard.html" data-nav="leaderboard">Leaderboard</a>
        <a href="profile.html" data-nav="profile">Profile</a>
        <a href="rivals.html" data-nav="rivals">Rivals</a>
        <a href="admin.html" id="navAdmin" style="display:none">Admin</a>
        <a class="logout" id="navLogout" href="login.html">Logout</a>
      </nav>
    </div>
  </header>

  <main class="wrap grid-2">
    <section class="card">
      <h1>My picks</h1>
      <div class="muted" style="margin-bottom:6px">Your selections for the current gameweek.</div>

      <details class="debug" open>
        <summary><strong>Debug</strong> (what the server returned)</summary>
        <div class="dbg" id="debugBox">Loading…</div>
      </details>

      <div id="empty" class="empty" style="display:none">No picks found for your account.</div>

      <div id="tableWrap" style="display:none">
        <table aria-label="Your picks">
          <thead>
          <tr>
            <th>Fixture</th>
            <th class="center">Your Pick</th>
            <th class="center">Result</th>
            <th class="right">Status</th>
          </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
        <div class="meta" id="lastUpdated" style="margin-top:6px"></div>
      </div>
    </section>

    <aside class="card">
      <div class="meta"><strong>Tip:</strong> Once your picks are <em>locked</em>, they cannot be changed.</div>
      <div class="meta" style="margin-top:6px">Head-to-head: try the new <a href="rivals.html"><strong>Rivals</strong></a> page.</div>
    </aside>
  </main>

  <!-- Auth + logout wiring -->
  <script type="module">
    import { supabase } from './supabase-config.js';
    document.addEventListener('DOMContentLoaded', ()=>{
      const navLogout = document.getElementById('navLogout');
      navLogout?.addEventListener('click', async (e)=>{
        e.preventDefault();
        try{ await supabase.auth.signOut(); }catch{}
        window.location.replace('login.html');
      });
    });
  </script>

  <!-- Page logic (select *; robust rendering) -->
  <script type="module">
    import { supabase } from './supabase-config.js';

    const $ = id => document.getElementById(id);
    const tbody = $('tbody');
    const empty = $('empty');
    const wrap = $('tableWrap');
    const lastUpdated = $('lastUpdated');
    const dbg = $('debugBox');
    const navAdmin = $('navAdmin');

    const pad = n => String(n).padStart(2,'0');
    const startOfWeek = (d=new Date())=>{
      const x = new Date(d);
      const day = x.getDay(); // 0 Sun, 1 Mon...
      x.setHours(0,0,0,0);
      const diff = (day === 0 ? -6 : 1 - day); // Monday start
      x.setDate(x.getDate() + diff);
      return x;
    };
    const addDays = (d, n)=> { const x = new Date(d); x.setDate(x.getDate()+n); return x; };
    const isoDate = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    const bool = v => v === true || v === 'true' || v === 1;

    const FIRST_NAME_KEYS = ['home_team_name','home_name','homeclub','home_club','home_side','ht_name','homeTeam','home_team_short'];
    const SECOND_NAME_KEYS = ['away_team_name','away_name','awayclub','away_club','away_side','at_name','awayTeam','away_team_short'];

    function firstKey(o, keys){ return keys.find(k => o && Object.prototype.hasOwnProperty.call(o,k) && o[k] != null); }

    function teamNames(r){
      const hk = firstKey(r, FIRST_NAME_KEYS);
      const ak = firstKey(r, SECOND_NAME_KEYS);
      const home = hk ? r[hk] : 'Home';
      const away = ak ? r[ak] : 'Away';
      return { home, away };
    }

    function pickScore(r){
      const hg = r.home ?? r.home_goals ?? r.home_score ?? r.h ?? r.pred_home ?? r.home_prediction ?? null;
      const ag = r.away ?? r.away_goals ?? r.away_score ?? r.a ?? r.pred_away ?? r.away_prediction ?? null;
      if (hg == null && ag == null) return '—';
      return `${hg ?? '–'} : ${ag ?? '–'}`;
    }

    const log = (label, obj) => {
      const safe = v => (typeof v === 'string' ? v : JSON.stringify(v, null, 2));
      dbg.textContent += `\n\n=== ${label} ===\n` + safe(obj);
      console.log('[my-picks.debug]', label, obj);
    };

    async function selectAny(uid, filter){
      // select * so we learn the actual column names
      let q = supabase.from('picks').select('*');
      q = q.eq('user_id', uid);
      if (filter?.eq) q = q.eq('week_start', filter.eq);
      if (filter?.range){
        q = q.gte('week_start', filter.range[0]).lt('week_start', filter.range[1]);
      }
      if (filter?.recent) q = q.order('created_at', { ascending:false }).limit(30);
      return q;
    }

    function render(rows){
      tbody.innerHTML = '';
      if (!rows?.length){ wrap.style.display='none'; empty.style.display=''; return; }
      wrap.style.display=''; empty.style.display='none';

      rows.forEach(r=>{
        const tr = document.createElement('tr');
        const { home, away } = teamNames(r);
        const pick = pickScore(r);
        const res = r.result_text ?? r.result ?? '—';
        const locked = bool(r.locked);
        tr.innerHTML = `
          <td><strong>${home}</strong> vs <strong>${away}</strong></td>
          <td class="center"><strong>${pick}</strong></td>
          <td class="center">${res}</td>
          <td class="right"><span class="pill ${locked?'locked':'open'}">${locked?'Locked':'Open'}</span></td>
        `;
        tbody.appendChild(tr);
      });
      lastUpdated.textContent = `Loaded ${rows.length} pick${rows.length===1?'':'s'}.`;
    }

    (async ()=>{
      dbg.textContent = '';

      const { data:{ session } } = await supabase.auth.getSession();
      if (!session?.user){ window.location.replace('login.html'); return; }
      const uid = session.user.id;

      // Admin link
      try{
        const { data } = await supabase.from('profiles').select('is_admin').eq('id', uid).maybeSingle();
        if (data?.is_admin) navAdmin.style.display = '';
      }catch{}

      const ws = startOfWeek(new Date());
      const weekStart = isoDate(ws);
      const weekEnd = isoDate(addDays(ws, 7));
      log('Computed week bounds', { weekStart, weekEnd });

      // 1) exact week
      let { data: aData, error: aErr } = await selectAny(uid, { eq: weekStart });
      log('picks * eq(week_start)', { count: aData?.length ?? 0, error: aErr?.message || null, keys: aData?.[0] ? Object.keys(aData[0]) : [] });

      // 2) week range
      let bData = null, bErr = null;
      if (!aData?.length){
        const b = await selectAny(uid, { range: [weekStart, weekEnd] });
        bData = b.data; bErr = b.error;
        log('picks * week range', { count: bData?.length ?? 0, error: bErr?.message || null, keys: bData?.[0] ? Object.keys(bData[0]) : [] });
      }

      // 3) recent
      let cData = null, cErr = null;
      if (!aData?.length && !bData?.length){
        const c = await selectAny(uid, { recent: true });
        cData = c.data; cErr = c.error;
        log('picks * recent (no filter)', { count: cData?.length ?? 0, error: cErr?.message || null, keys: cData?.[0] ? Object.keys(cData[0]) : [] });
      }

      const rows = aData?.length ? aData : bData?.length ? bData : cData?.length ? cData : [];
      if (rows?.length){
        log('sample row', rows[0]);
      } else {
        log('note', 'No rows returned from picks for your user with any filter. If your data is in a different table/view, tell me its name.');
      }

      render(rows);
    })();
  </script>
</body>
</html>
