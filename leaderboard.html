<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Leaderboard • Weekend Predictor</title>
  <link rel="stylesheet" href="brand.css?v=81" />
  <style>
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;
          box-shadow:0 8px 20px rgba(0,0,0,.08);padding:16px;margin-bottom:16px}
    h1{margin:0 0 8px;color:#1f357a}
    .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .tabs{display:flex;gap:6px;flex-wrap:wrap}
    .tab{padding:6px 10px;border:1px solid #cbd5e1;border-radius:999px;background:#f8fafc;font-weight:700;cursor:pointer}
    .tab.active{background:#e0e7ff;border-color:#93c5fd;color:#1f357a}
    .meta{color:#475569;font-size:.9rem}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:10px;border-bottom:1px solid #e5e7eb;text-align:left}
    th{background:#f8fafc;text-transform:uppercase;font-size:.82rem;letter-spacing:.03em}
    .rank{width:60px;text-align:center;font-weight:800}
    .name{font-weight:700}
    .pts{font-weight:800}
    .ok{color:#16a34a}.err{color:#b91c1c}
    .ghost{background:transparent;border:1px solid #cbd5e1;border-radius:10px;height:38px;padding:0 12px;font-weight:700}
    .range{height:38px;border:1px solid #cbd5e1;border-radius:10px;background:#fff;padding:0 8px}
  </style>
  <script type="module" src="supabase-config.js"></script>
  <!-- Early logout wiring so it always works -->
  <script type="module">
    import { supabase } from './supabase-config.js';
    document.addEventListener('DOMContentLoaded', ()=>{
      const navLogout = document.getElementById('navLogout');
      navLogout?.addEventListener('click', async (e)=>{
        e.preventDefault();
        try{ await supabase.auth.signOut(); }catch{}
        window.location.replace('login.html');
      });
    });
  </script>
</head>
<body>
  <header class="top">
    <div class="inner">
      <a class="logo" href="index.html">WP</a>
      <nav class="topnav">
        <a href="predict.html" data-nav="predict">Predict</a>
        <a href="leaderboard.html" data-nav="leaderboard" class="active">Leaderboard</a>
        <a href="profile.html" data-nav="profile">Profile</a>
        <a href="admin.html" id="navAdmin" style="display:none">Admin</a>
        <a class="logout" id="navLogout" href="login.html">Logout</a>
      </nav>
    </div>
  </header>

  <main class="wrap">
    <section class="card">
      <h1>Leaderboard</h1>
      <div class="controls">
        <div class="tabs">
          <button id="tabWeek" class="tab active" type="button">This week</button>
          <button id="tabSeason" class="tab" type="button">Season</button>
        </div>
        <input id="range" class="range" type="week" />
        <button id="refreshBtn" class="ghost" type="button">Refresh</button>
        <div class="meta" id="lastUpdated">—</div>
      </div>
      <div class="meta" id="status">—</div>

      <table>
        <thead>
          <tr>
            <th class="rank">#</th>
            <th>Player</th>
            <th style="width:160px">Correct scores</th>
            <th style="width:170px">Correct results</th>
            <th style="width:110px">Points</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </section>
  </main>

  <script type="module">
    import { supabase } from './supabase-config.js';

    // Admin reveal (non-blocking)
    (async ()=>{
      try{
        const { data:{ session } } = await supabase.auth.getSession();
        if (!session?.user) return;
        const { data, error } = await supabase
          .from('profiles').select('is_admin').eq('id', session.user.id).single();
        if (!error && data?.is_admin) document.getElementById('navAdmin').style.display = '';
      }catch{}
    })();

    // Elements
    const tbody = document.getElementById('tbody');
    const statusEl = document.getElementById('status');
    const tabWeek = document.getElementById('tabWeek');
    const tabSeason = document.getElementById('tabSeason');
    const rangeEl = document.getElementById('range');
    const refreshBtn = document.getElementById('refreshBtn');
    const lastUpdatedEl = document.getElementById('lastUpdated');

    // Time helpers
    function startOfWeek(d=new Date()){
      const x=new Date(d);
      const day = x.getDay()===0?7:x.getDay(); // Mon=1..Sun=7
      x.setHours(0,0,0,0);
      x.setDate(x.getDate()-(day-1));
      return x;
    }
    function pad(n){return String(n).padStart(2,'0')}
    function isoDate(d){return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`}

    // State
    let currentTab = 'week';
    let timerId = null;

    function setTab(t){
      currentTab = t;
      tabWeek.classList.toggle('active', t==='week');
      tabSeason.classList.toggle('active', t==='season');
    }

    function fmt(n){ return new Intl.NumberFormat().format(n||0) }

    function renderRows(rows){
      tbody.innerHTML = '';
      rows.forEach((r,i)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="rank">${i+1}</td>
          <td class="name">${r.display_name || '—'}</td>
          <td>${fmt(r.correct_scores)}</td>
          <td>${fmt(r.correct_results)}</td>
          <td class="pts">${fmt(r.points)}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function fetchSeason(){
      // Prefer RPC if present (server computes with 3/5 scoring)
      const { data, error } = await supabase.rpc('leaderboard_v2');
      if (!error && Array.isArray(data)) return data;

      // Fallback: compute client-side if RPC not created yet
      // Requires: tables fixtures(id, week_start, home_score, away_score), picks(user_id, fixture_id, home, away)
      const { data: fixtures } = await supabase.from('fixtures').select('id,home_score,away_score');
      const { data: picks } = await supabase.from('picks').select('user_id,fixture_id,home,away');
      const { data: users } = await supabase.from('profiles').select('id,display_name');
      const name = new Map(users?.map(u=>[u.id,u.display_name]));
      const byUser = new Map();

      function outcome(h,a){ return h>a?'H':(h<a?'A':'D'); }
      function points(ph,pa,ah,aa){
        if (ph==null||pa==null||ah==null||aa==null) return 0;
        if (ph===ah && pa===aa) return 5; // exact score
        if (outcome(ph,pa) === outcome(ah,aa)) return 3; // correct result
        return 0;
      }

      (picks||[]).forEach(p=>{
        const fx = fixtures?.find(f=>f.id===p.fixture_id);
        const pts = fx?points(p.home,p.away,fx.home_score,fx.away_score):0;
        const isExact = fx && p.home===fx.home_score && p.away===fx.away_score;
        const isResult = fx && !isExact && outcome(p.home,p.away)===outcome(fx.home_score,fx.away_score);
        const acc = byUser.get(p.user_id) || { display_name: name.get(p.user_id)||'—', points:0, correct_scores:0, correct_results:0 };
        acc.points += pts;
        if (isExact) acc.correct_scores += 1;
        if (isResult) acc.correct_results += 1;
        byUser.set(p.user_id, acc);
      });

      const rows = [...byUser.values()].sort((a,b)=>b.points-a.points);
      return rows;
    }

    async function fetchWeek(weekStart){
      // Prefer RPC if present
      const { data, error } = await supabase.rpc('leaderboard_week_v2', { week_start: isoDate(weekStart) });
      if (!error && Array.isArray(data)) return data;

      // Fallback client compute for this week only
      const ws = isoDate(weekStart);
      const { data: fixtures } = await supabase.from('fixtures')
          .select('id,week_start,home_score,away_score').eq('week_start', ws);
      const ids = new Set((fixtures||[]).map(f=>f.id));
      const { data: picks } = await supabase.from('picks')
          .select('user_id,fixture_id,home,away').in('fixture_id',[...ids]);
      const { data: users } = await supabase.from('profiles').select('id,display_name');
      const name = new Map(users?.map(u=>[u.id,u.display_name]));

      function outcome(h,a){ return h>a?'H':(h<a?'A':'D'); }
      function points(ph,pa,ah,aa){
        if (ph==null||pa==null||ah==null||aa==null) return 0;
        if (ph===ah && pa===aa) return 5;
        if (outcome(ph,pa) === outcome(ah,aa)) return 3;
        return 0;
      }

      const byUser = new Map();
      (picks||[]).forEach(p=>{
        const fx = fixtures?.find(f=>f.id===p.fixture_id);
        const pts = fx?points(p.home,p.away,fx.home_score,fx.away_score):0;
        const isExact = fx && p.home===fx.home_score && p.away===fx.away_score;
        const isResult = fx && !isExact && outcome(p.home,p.away)===outcome(fx.home_score,fx.away_score);
        const acc = byUser.get(p.user_id) || { display_name: name.get(p.user_id)||'—', points:0, correct_scores:0, correct_results:0 };
        acc.points += pts;
        if (isExact) acc.correct_scores += 1;
        if (isResult) acc.correct_results += 1;
        byUser.set(p.user_id, acc);
      });

      return [...byUser.values()].sort((a,b)=>b.points-a.points);
    }

    function setStatus(text){ statusEl.textContent = text; }

    async function load(which){
      setTab(which);
      setStatus('Loading…');
      tbody.innerHTML = '';
      const now = new Date();
      const weekStart = startOfWeek(now);

      try{
        let rows = [];
        if (which==='week'){
          const userPickedWeek = rangeEl.valueAsDate;
          const ws = userPickedWeek ? startOfWeek(userPickedWeek) : weekStart;
          rows = await fetchWeek(ws);
        } else {
          rows = await fetchSeason();
        }
        renderRows(rows);
        setStatus(`Scoring: 5 pts exact • 3 pts correct result`);
        lastUpdatedEl.textContent = `Updated ${new Date().toLocaleTimeString()}`;
      } catch(e){
        console.error(e);
        setStatus('Could not load leaderboard.');
      }
    }

    function startAuto(){ if(!timerId){ timerId=setInterval(()=>load(currentTab), 60_000); } }
    function stopAuto(){ if(timerId){ clearInterval(timerId); timerId=null; } }
    document.addEventListener('visibilitychange', ()=>{ document.hidden ? stopAuto() : startAuto(); });
    window.addEventListener('beforeunload', stopAuto);

    refreshBtn.addEventListener('click', ()=>load(currentTab));
    tabWeek.addEventListener('click', ()=>load('week'));
    tabSeason.addEventListener('click', ()=>load('season'));

    await load('week'); startAuto();
  </script>
</body>
</html>

