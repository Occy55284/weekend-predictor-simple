<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Leaderboard â€¢ Weekend Predictor</title>
  <link rel="stylesheet" href="brand.css" />
  <style>
    .toolbar {
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      margin: 8px 0 12px;
    }
    .toolbar-left {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
    .tabs {
      display: inline-flex;
      gap: 8px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      border-radius: 999px;
      padding: 6px;
      background: rgba(2, 6, 23, 0.35);
    }
    .tab {
      border: 0;
      background: transparent;
      color: #e5e7eb;
      padding: 8px 10px;
      border-radius: 999px;
      font-weight: 800;
      cursor: pointer;
      opacity: 0.75;
    }
    .tab.active {
      opacity: 1;
      background: rgba(96,165,250,0.22);
      border: 1px solid rgba(96,165,250,0.55);
    }
    .date-input {
      border-radius: 14px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: rgba(2, 6, 23, 0.35);
      padding: 10px 12px;
      color: #e5e7eb;
      font-size: 0.8rem;
      outline: none;
    }
    .date-input:focus {
      border-color: #60a5fa;
      box-shadow: 0 0 0 1px rgba(96,165,250,0.5);
    }
    .muted-center {
      text-align: center;
      color: #9ca3af;
      font-size: 0.9rem;
    }
    .rank {
      width: 40px;
    }
    .badge-chip {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.7rem;
      font-weight: 800;
      border: 1px solid rgba(191, 219, 254, 0.9);
      background: rgba(30, 64, 175, 0.95);
      color: #e5f2ff;
      margin-left: 6px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }
  </style>
</head>
<body class="bg-hero">
  <div class="page-shell">
    <header class="top-nav">
      <div class="top-nav-left">
        <div class="nav-logo">
          <img src="assets/brand-logo.png" alt="Weekend Predictor logo" />
        </div>
        <nav class="nav-links">
          <a href="index.html">Home</a>
          <a href="predict.html">Predict</a>
          <a href="my-picks.html">My Picks</a>
          <a href="teams.html">Teams</a>
        <a href="all-picks.html">All Picks</a>
          <a class="active" href="leaderboard.html">Leaderboard</a>
          <a href="stats.html">Stats</a>
          <a href="wallet.html">Wallet</a>
          <a href="profile.html">Profile</a>
          <a id="navAdmin" href="admin.html" style="display:none;">Admin</a>
          <a id="navLogout" href="#">Logout</a>
        </nav>
      </div>
      <div class="top-nav-right">
        <span id="lastUpdated" class="muted"></span>
      </div>
    </header>

    <main class="main-layout">
      <section class="panel">
        <div class="panel-inner">
          <h1>Leaderboard</h1>
          <p class="muted">Week or Season totals (includes AI Predictor).</p>

          <div class="toolbar">
            <div class="toolbar-left">
              <div class="tabs">
                <button id="tabWeek" class="tab active" type="button">Week</button>
                <button id="tabSeason" class="tab" type="button">Season</button>
              </div>
              <input id="weekPicker" class="date-input" type="date" />
              <button id="refreshBtn" class="btn" type="button">Refresh</button>
            </div>
            <div id="status" class="muted"></div>
          </div>

          <table class="table">
            <thead>
              <tr>
                <th class="rank">#</th>
                <th>Player</th>
                <th>Exact</th>
                <th>Correct</th>
                <th>Points</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>

          <p id="summary" class="muted" style="margin-top:12px;"></p>
        </div>
      </section>

      <aside class="panel panel-side">
        <div class="panel-inner">
          <h2>Notes</h2>
          <ul class="bullet-list">
            <li>Week = points from fixtures in the selected week.</li>
            <li>Season = cumulative points for all finished fixtures.</li>
            <li>AI Predictor is displayed as a normal player.</li>
          </ul>
        </div>
      </aside>
    </main>
  </div>

  
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="./supabase-config.js"></script>
<script src="./app-auth.js"></script>
<script src="./app-week.js"></script>
<script>
(() => {
  const tbody = document.getElementById('tbody');
  const statusEl = document.getElementById('status');
  const weekPicker = document.getElementById('weekPicker');
  const tabWeek = document.getElementById('tabWeek');
  const tabSeason = document.getElementById('tabSeason');

  function esc(s){ return String(s ?? '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
  function outcome(h,a){ if (h===a) return 'D'; return h>a ? 'H' : 'A'; }
  function pointsForPick(pH,pA,fH,fA){
    // 3 = exact score, 1 = correct outcome, 0 otherwise
    if (pH === fH && pA === fA) return 3;
    if (outcome(pH,pA) === outcome(fH,fA)) return 1;
    return 0;
  }

  async function ensureSession() {
    const { data: { session } } = await supabase.auth.getSession();
    if (!session?.user) {
      window.location.replace('login.html');
      return null;
    }
    return session.user;
  }

  async function loadLeaderboard(mode){
    statusEl.textContent = 'Loading...';
    tbody.innerHTML = '';

    // Determine fixture set
    let fxQuery = supabase
      .from('fixtures')
      .select('id, utc_date, home_score, away_score, featured')
      .eq('featured', true)
      .not('home_score', 'is', null)
      .not('away_score', 'is', null);

    if (mode === 'week') {
      const ws = startOfWeek(new Date(weekPicker.value || new Date()));
      const we = addDays(ws, 7);
      weekPicker.value = isoDate(ws);
      fxQuery = fxQuery.gte('utc_date', isoDate(ws)).lt('utc_date', isoDate(we));
    }

    const { data: fx, error: fxErr } = await fxQuery;
    if (fxErr) {
      console.error(fxErr);
      statusEl.innerHTML = '<span class="err">Could not load leaderboard.</span>';
      return;
    }

    if (!fx || fx.length === 0) {
      statusEl.textContent = (mode === 'week')
        ? 'No results yet for this week. Leaderboard will populate once games finish.'
        : 'No completed featured fixtures found yet.';
      return;
    }

    const fixtureIds = fx.map(f => f.id);

    const { data: preds, error: pErr } = await supabase
      .from('predictions')
      .select('user_id, fixture_id, home_goals, away_goals')
      .in('fixture_id', fixtureIds);

    if (pErr) {
      console.error(pErr);
      statusEl.innerHTML = '<span class="err">Could not load leaderboard.</span>';
      return;
    }

    const { data: profs, error: prErr } = await supabase
      .from('profiles')
      .select('id, display_name');

    if (prErr) console.warn('profiles load error', prErr);

    const nameById = new Map((profs || []).map(p => [p.id, p.display_name || 'Player']));
    const fixtureById = new Map(fx.map(f => [f.id, f]));
    const scoreByUser = new Map();

    (preds || []).forEach(p => {
      const f = fixtureById.get(p.fixture_id);
      if (!f) return;
      const pts = pointsForPick(p.home_goals, p.away_goals, f.home_score, f.away_score);
      scoreByUser.set(p.user_id, (scoreByUser.get(p.user_id) || 0) + pts);
    });

    const rows = Array.from(nameById.keys()).map(uid => ({
      user_id: uid,
      name: nameById.get(uid),
      points: scoreByUser.get(uid) || 0
    }));

    rows.sort((a,b)=> b.points - a.points || a.name.localeCompare(b.name));

    statusEl.textContent = '';
    rows.forEach((r, idx) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${idx+1}</td><td>${esc(r.name)}</td><td><strong>${r.points}</strong></td>`;
      tbody.appendChild(tr);
    });
  }

  document.addEventListener('DOMContentLoaded', async () => {
    const user = await ensureSession();
    if (!user) return;

    // default to this week
    const ws = startOfWeek(new Date());
    weekPicker.value = isoDate(ws);

    let mode = 'week';
    tabWeek?.addEventListener('click', () => { mode='week'; loadLeaderboard('week'); });
    tabSeason?.addEventListener('click', () => { mode='season'; loadLeaderboard('season'); });
    weekPicker?.addEventListener('change', () => { if (mode==='week') loadLeaderboard('week'); });

    loadLeaderboard('week');
  });
})();
</script>

</body>
</html>