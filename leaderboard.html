<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Leaderboard • Weekend Predictor</title>
  <link rel="stylesheet" href="brand.css?v=82" />
  <style>
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;
          box-shadow:0 8px 20px rgba(0,0,0,.08);padding:16px;margin-bottom:16px}
    h1{margin:0 0 8px;color:#1f357a}
    .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .tabs{display:flex;gap:6px;flex-wrap:wrap}
    .tab{padding:6px 10px;border:1px solid #cbd5e1;border-radius:999px;background:#f8fafc;font-weight:700;cursor:pointer}
    .tab.active{background:#e0e7ff;border-color:#93c5fd;color:#1f357a}
    .meta{color:#475569;font-size:.9rem}
    .note{color:#1f2937;font-size:.9rem;margin-top:6px}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:10px;border-bottom:1px solid #e5e7eb;text-align:left}
    th{background:#f8fafc;text-transform:uppercase;font-size:.82rem;letter-spacing:.03em}
    .rank{width:60px;text-align:center;font-weight:800}
    .name{font-weight:700}
    .pts{font-weight:800}
    .ghost{background:transparent;border:1px solid #cbd5e1;border-radius:10px;height:38px;padding:0 12px;font-weight:700}
    .range{height:38px;border:1px solid #cbd5e1;border-radius:10px;background:#fff;padding:0 8px}
    .err{color:#b91c1c;font-weight:700}
    .ok{color:#16a34a;font-weight:700}
    .muted{color:#64748b}
    pre.errbox{white-space:pre-wrap;background:#fff7f7;border:1px solid #fecaca;border-radius:10px;padding:10px;margin-top:8px;color:#7f1d1d;font-size:.9rem}
  </style>

  <script type="module" src="supabase-config.js"></script>

  <!-- Early logout wiring -->
  <script type="module">
    import { supabase } from './supabase-config.js';
    document.addEventListener('DOMContentLoaded', ()=>{
      const navLogout = document.getElementById('navLogout');
      navLogout?.addEventListener('click', async (e)=>{
        e.preventDefault();
        try{ await supabase.auth.signOut(); }catch{}
        window.location.replace('login.html');
      });
    });
  </script>
</head>
<body>
  <header class="top">
    <div class="inner">
      <a class="logo" href="index.html">WP</a>
      <nav class="topnav">
        <a href="predict.html" data-nav="predict">Predict</a>
        <a href="leaderboard.html" data-nav="leaderboard" class="active">Leaderboard</a>
        <a href="profile.html" data-nav="profile">Profile</a>
        <a href="admin.html" id="navAdmin" style="display:none">Admin</a>
        <a class="logout" id="navLogout" href="login.html">Logout</a>
      </nav>
    </div>
  </header>

  <main class="wrap">
    <section class="card">
      <h1>Leaderboard</h1>

      <div class="controls">
        <div class="tabs">
          <button id="tabWeek" class="tab active" type="button">This week</button>
          <button id="tabSeason" class="tab" type="button">Season</button>
        </div>
        <input id="range" class="range" type="week" />
        <button id="refreshBtn" class="ghost" type="button">Refresh</button>
        <div class="meta" id="lastUpdated">—</div>
      </div>

      <div class="note">Scoring: <strong>5</strong> pts exact score • <strong>3</strong> pts correct result</div>
      <div id="status" class="meta" style="margin-top:6px;">—</div>
      <pre id="diag" class="errbox" style="display:none"></pre>

      <table>
        <thead>
          <tr>
            <th class="rank">#</th>
            <th>Player</th>
            <th style="width:160px">Correct scores</th>
            <th style="width:170px">Correct results</th>
            <th style="width:110px">Points</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </section>
  </main>

  <script type="module">
    import { supabase } from './supabase-config.js';

    // Utilities
    const $ = (sel)=>document.querySelector(sel);
    const tbody = $('#tbody');
    const statusEl = $('#status');
    const diagEl = $('#diag');
    const tabWeek = $('#tabWeek');
    const tabSeason = $('#tabSeason');
    const rangeEl = $('#range');
    const refreshBtn = $('#refreshBtn');
    const lastUpdatedEl = $('#lastUpdated');

    function showStatus(txt, cls=''){ statusEl.className = 'meta ' + (cls||''); statusEl.textContent = txt; }
    function showDiag(obj){
      if (!obj) { diagEl.style.display='none'; diagEl.textContent=''; return; }
      diagEl.style.display='block';
      try { diagEl.textContent = typeof obj==='string' ? obj : JSON.stringify(obj, null, 2); }
      catch { diagEl.textContent = String(obj); }
    }
    function pad(n){return String(n).padStart(2,'0')}
    function startOfWeek(d=new Date()){ const x=new Date(d); const day=x.getDay()===0?7:x.getDay(); x.setHours(0,0,0,0); x.setDate(x.getDate()-(day-1)); return x; }
    function isoDate(d){return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`}
    function fmt(n){ return new Intl.NumberFormat().format(n||0) }
    function renderRows(rows){
      tbody.innerHTML='';
      if (!rows || !rows.length){ tbody.innerHTML = `<tr><td colspan="5" class="muted">No data to show.</td></tr>`; return; }
      rows.forEach((r,i)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="rank">${i+1}</td>
          <td class="name">${r.display_name ?? '—'}</td>
          <td>${fmt(r.correct_scores ?? r.correct_score ?? 0)}</td>
          <td>${fmt(r.correct_results ?? r.correct_result ?? 0)}</td>
          <td class="pts">${fmt(r.points ?? 0)}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Admin reveal
    (async ()=>{
      try{
        const { data:{ session } } = await supabase.auth.getSession();
        if (!session?.user) return;
        const { data, error } = await supabase.from('profiles').select('is_admin').eq('id', session.user.id).single();
        if (!error && data?.is_admin) $('#navAdmin').style.display = '';
      }catch{}
    })();

    // Diagnostics: verify connectivity + simple read
    async function connectivityProbe(){
      try{
        const { data: { session }, error: sessErr } = await supabase.auth.getSession();
        if (sessErr) throw sessErr;
        showStatus('Connected. Checking data access…');
        const { count, error } = await supabase.from('profiles').select('*', { count:'exact', head:true });
        if (error) throw error;
        showStatus(`Connected. Profiles visible: ${count ?? 0}`, 'ok');
        showDiag(null);
      }catch(e){
        showStatus('Connection or RLS issue detected.', 'err');
        showDiag({ step:'connectivityProbe', error: e?.message || e });
      }
    }

    // Server calls
    async function fetchSeason(){
      try{
        showStatus('Loading season (RPC)…');
        const { data, error } = await supabase.rpc('leaderboard_v2');
        if (error) throw error;
        showStatus('Season data loaded.', 'ok');
        showDiag(null);
        return Array.isArray(data) ? data : [];
      }catch(e){
        showStatus('Season RPC failed. See details below.', 'err');
        showDiag({ step:'leaderboard_v2', error: e?.message || e });
        return [];
      }
    }

    async function fetchWeek(weekStart){
      try{
        showStatus(`Loading week ${isoDate(weekStart)} (RPC)…`);
        const { data, error } = await supabase.rpc('leaderboard_week_v2', { week_start: isoDate(weekStart) });
        if (error) throw error;
        showStatus('Week data loaded.', 'ok');
        showDiag(null);
        return Array.isArray(data) ? data : [];
      }catch(e){
        showStatus('Weekly RPC failed. See details below.', 'err');
        showDiag({ step:'leaderboard_week_v2', error: e?.message || e, arg: isoDate(weekStart) });
        return [];
      }
    }

    // State & wiring
    let currentTab = 'week';
    let timerId = null;
    function setTab(t){
      currentTab = t;
      tabWeek.classList.toggle('active', t==='week');
      tabSeason.classList.toggle('active', t==='season');
    }

    async function load(which){
      setTab(which);
      tbody.innerHTML = '';
      const now = new Date();
      const ws = rangeEl.valueAsDate ? startOfWeek(rangeEl.valueAsDate) : startOfWeek(now);

      await connectivityProbe();

      const rows = which==='week'
        ? await fetchWeek(ws)
        : await fetchSeason();

      renderRows(rows);
      lastUpdatedEl.textContent = `Updated ${new Date().toLocaleTimeString()}`;
    }

    refreshBtn.addEventListener('click', ()=>load(currentTab));
    tabWeek.addEventListener('click', ()=>load('week'));
    tabSeason.addEventListener('click', ()=>load('season'));

    function startAuto(){ if(!timerId){ timerId = setInterval(()=>load(currentTab), 60_000); } }
    function stopAuto(){ if(timerId){ clearInterval(timerId); timerId=null; } }
    document.addEventListener('visibilitychange', ()=>{ document.hidden ? stopAuto() : startAuto(); });
    window.addEventListener('beforeunload', stopAuto);

    await load('week'); startAuto();
  </script>
</body>
</html>
