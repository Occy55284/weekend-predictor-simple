<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Leaderboard ¬∑ Occy Weekend Football</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="assets/brand-logo.png" />
  <link rel="stylesheet" href="brand.css" />
  <style>.wrap{max-width:1000px;margin:0 auto}</style>
</head>
<body>
  <div class="brand-header"><img src="assets/brand-logo.png" alt="Occy Weekend Football"></div>

  <div class="container wrap">
    <div class="card">
      <div class="tabs">
        <button id="tabWeek" class="tab active">This Weekend</button>
        <button id="tabSeason" class="tab">Season</button>
      </div>

      <section id="paneWeek" class="pane active">
        <h2 style="margin:0 0 4px 0;">This Weekend</h2>
        <p id="weekRange" class="muted">‚Äî</p>
        <table id="tblWeek" style="display:none"><thead>
          <tr><th>#</th><th class="left">Name</th><th>Points</th><th>Played</th><th>Exact</th><th>GD</th><th>Result</th></tr>
        </thead><tbody></tbody></table>
        <p id="msgWeek" class="muted">Loading‚Ä¶</p>
      </section>

      <section id="paneSeason" class="pane">
        <h2 style="margin:0 0 4px 0;">Season Standings</h2>
        <p class="muted">Aug 1 ‚Üí Jun 30</p>
        <table id="tblSeason" style="display:none"><thead>
          <tr><th>#</th><th class="left">Name</th><th>Rank</th><th>Points</th><th>Played</th><th>Exact</th><th>GD</th><th>Result</th></tr>
        </thead><tbody></tbody></table>
        <p id="msgSeason" class="muted">Loading‚Ä¶</p>
      </section>

      <p class="muted" style="margin-top:10px"><a href="index.html">‚Üê Back to home</a></p>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase-config.js"></script>
  <script>
    const client = supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
    const tabWeek=document.getElementById('tabWeek'), tabSeason=document.getElementById('tabSeason');
    const paneWeek=document.getElementById('paneWeek'), paneSeason=document.getElementById('paneSeason');
    function setTab(w){ tabWeek.classList.toggle('active',w==='week'); tabSeason.classList.toggle('active',w==='season'); paneWeek.classList.toggle('active',w==='week'); paneSeason.classList.toggle('active',w==='season'); }
    tabWeek.onclick=()=>setTab('week'); tabSeason.onclick=()=>setTab('season');

    function pointsFor(pred, actual){
      if(!actual) return { pts:0, exact:0, gd:0, res:0, played:0 };
      const ph=+pred.home_goals, pa=+pred.away_goals, ah=+actual.home, aa=+actual.away;
      const pRes = ph===pa?'D':ph>pa?'H':'A'; const aRes = ah===aa?'D':ah>aa?'H':'A';
      const correctRes = pRes===aRes?1:0; const correctGD = (ph-pa)===(ah-aa)?1:0; const exact=(ph===ah&&pa===aa)?1:0;
      let pts = (correctRes?3:0)+(correctGD?1:0)+(exact?1:0); if(pts>5) pts=5;
      return { pts, exact, gd:correctGD, res:correctRes, played:1 };
    }
    function rankFor(exact){ if (exact>=30) return 'üêê GOAT'; if (exact>=25) return 'üèÜ Pro'; if (exact>=10) return 'üéñÔ∏è Amateur'; return 'üå± Rookie'; }

    async function load(){
      // predictions
      const { data: preds, error:pErr } = await client.from('predictions').select('user_id,fixture_id,home_goals,away_goals');
      if (pErr){ document.getElementById('msgWeek').textContent=document.getElementById('msgSeason').textContent='Error: '+pErr.message; return; }
      // fixtures with scores
      const ids = [...new Set((preds||[]).map(p=>p.fixture_id))];
      const { data: fx, error:fErr } = await client.from('fixtures').select('id,utc_date,home_score,away_score').in('id', ids);
      if (fErr){ document.getElementById('msgWeek').textContent=document.getElementById('msgSeason').textContent='Error loading fixtures: '+fErr.message; return; }
      const fxById = Object.fromEntries((fx||[]).map(f=>[f.id, f]));
      // profiles
      const userIds = [...new Set((preds||[]).map(p=>p.user_id).filter(Boolean))];
      let profById={}; if (userIds.length){ const { data: profs } = await client.from('profiles').select('id,display_name'); (profs||[]).forEach(p=>profById[p.id]=p); }

      function accumulate(rows){
        const totals={};
        rows.forEach(r=>{
          const f = fxById[r.fixture_id];
          const finished = f && f.home_score!==null && f.away_score!==null;
          if (!finished) return;
          const s = pointsFor(r, { home:f.home_score, away:f.away_score });
          const key = r.user_id || 'anon';
          if (!totals[key]) totals[key] = { user_id:r.user_id, label:'(no name set)', pts:0,played:0,exact:0,gd:0,res:0 };
          const t=totals[key]; t.pts+=s.pts; t.played+=s.played; t.exact+=s.exact; t.gd+=s.gd; t.res+=s.res;
        });
        Object.values(totals).forEach(t=>{ const p=profById[t.user_id]; if (p?.display_name) t.label=p.display_name; });
        return Object.values(totals).sort((a,b)=> b.pts-a.pts || b.exact-a.exact || a.label.localeCompare(b.label));
      }

      // weekly
      const finishedPreds = (preds||[]).filter(r=>{ const f=fxById[r.fixture_id]; return f && f.home_score!==null && f.away_score!==null; });
      if (!finishedPreds.length){ document.getElementById('msgWeek').textContent='No finished, predicted fixtures yet.'; }
      else{
        const latestMs = Math.max(...finishedPreds.map(r=> new Date(fxById[r.fixture_id].utc_date).getTime()));
        const start = new Date(latestMs - 4*24*60*60*1000), end = new Date(latestMs + 1*24*60*60*1000);
        document.getElementById('weekRange').textContent =
          start.toLocaleString(undefined,{weekday:'short',month:'short',day:'2-digit'})+' ‚Üí '+
          end.toLocaleString(undefined,{weekday:'short',month:'short',day:'2-digit'});

        const weekRows = finishedPreds.filter(r=>{ const t=new Date(fxById[r.fixture_id].utc_date); return t>=start && t<=end; });
        const weekly = accumulate(weekRows);
        const msgW=document.getElementById('msgWeek'); const tblW=document.getElementById('tblWeek'); const tbW=tblW.querySelector('tbody');
        if (!weekly.length){ msgW.textContent='No scored predictions in the current block yet.'; }
        else{ msgW.textContent=''; tbW.innerHTML=''; weekly.forEach((r,i)=>{ tbW.innerHTML+=`<tr><td>${i+1}</td><td class="left">${r.label}</td><td><b>${r.pts}</b></td><td>${r.played}</td><td>${r.exact}</td><td>${r.gd}</td><td>${r.res}</td></tr>`; }); tblW.style.display=''; }
      }

      // season
      function seasonBoundsNow(){ const now=new Date(); const y=now.getUTCFullYear(); const m=now.getUTCMonth()+1; const startY=(m>=8)?y:y-1; const endY=(m>=8)?y+1:y; return { from:new Date(Date.UTC(startY,7,1,0,0,0)), to:new Date(Date.UTC(endY,5,30,23,59,59)) }; }
      const { from:seaFrom, to:seaTo } = seasonBoundsNow();
      const seasonRows = (preds||[]).filter(r=>{ const f=fxById[r.fixture_id]; if (!f) return false; const t=new Date(f.utc_date); const fin=f.home_score!==null&&f.away_score!==null; return fin && t>=seaFrom && t<=seaTo; });
      const season = accumulate(seasonRows).map(r=>({ ...r, rk:rankFor(r.exact) }));
      const msgS=document.getElementById('msgSeason'); const tblS=document.getElementById('tblSeason'); const tbS=tblS.querySelector('tbody');
      if (!season.length){ msgS.textContent='No scored predictions in season yet.'; }
      else{ msgS.textContent=''; tbS.innerHTML=''; season.forEach((r,i)=>{ tbS.innerHTML+=`<tr><td>${i+1}</td><td class="left">${r.label}</td><td>${r.rk}</td><td><b>${r.pts}</b></td><td>${r.played}</td><td>${r.exact}</td><td>${r.gd}</td><td>${r.res}</td></tr>`; }); tblS.style.display=''; }
    }
    load();
    setInterval(load, 20000);
  </script>
</body>
</html>

