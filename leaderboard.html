<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Occy Weekend Football ‚Äî Leaderboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
  <meta name="theme-color" content="#0f172a" />
  <style>
    :root{ --bg1:#0f172a; --bg2:#1e3a8a; --gold:#facc15; --card:#fffffff2; --muted:#6b7280; }
    *{ box-sizing:border-box }
    body{ font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; margin:0; padding:16px; min-height:100vh;
      background:linear-gradient(135deg,var(--bg1),var(--bg2),var(--bg1)); color:#fff; }
    header{ text-align:center; margin:28px 0 14px }
    header h1{ margin:6px 0; color:var(--gold) }
    header p{ color:#e5e7eb; margin:0 }
    .card{ background:var(--card); color:#111; border-radius:16px; padding:16px; margin:14px auto; max-width:1000px;
      box-shadow:0 4px 12px rgba(0,0,0,.3) }
    .tabs{ display:flex; gap:8px; border-bottom:1px solid #e5e7eb; margin:4px 0 12px; flex-wrap:wrap }
    .tab{ padding:10px 14px; border:1px solid #e5e7eb; border-bottom:none; border-top-left-radius:10px; border-top-right-radius:10px;
      background:#f9fafb; cursor:pointer; }
    .tab.active{ background:#fff; font-weight:700 }
    .pane{ display:none }
    .pane.active{ display:block }
    .muted{ color:var(--muted); font-size:14px }
    table{ border-collapse:collapse; width:100%; margin-top:10px }
    th,td{ border:1px solid #e5e7eb; padding:8px; text-align:center }
    th{ background:#fde68a; color:#111 }
    td.left{ text-align:left }
    .pname{ display:flex; align-items:center; gap:8px }
    .crest{ width:18px; height:18px; object-fit:contain }
    .rank{ display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; font-size:12px; white-space:nowrap }
    .rank.rookie{ background:#e5f6ff; color:#064e66 }
    .rank.amateur{ background:#fff7ed; color:#7c2d12 }
    .rank.pro{ background:#ecfdf5; color:#065f46 }
    .rank.goat{ background:#fef3c7; color:#92400e; font-weight:700 }
    a{ color:#0f172a }
  </style>
</head>
<body>
  <header>
    <h1>‚öΩ Occy Weekend Football ¬∑ Leaderboard</h1>
    <p class="muted">Weekly winner & Season standings</p>
  </header>

  <div class="card">
    <div class="tabs">
      <button id="tabWeek" class="tab active">This Weekend</button>
      <button id="tabSeason" class="tab">Season</button>
    </div>

    <!-- WEEKLY -->
    <section id="paneWeek" class="pane active">
      <h2 style="margin:0 0 4px 0;">This Weekend</h2>
      <p id="weekRange" class="muted">‚Äî</p>
      <table id="tblWeek" style="display:none">
        <thead>
          <tr>
            <th>#</th>
            <th class="left">Name</th>
            <th>Points</th>
            <th>Played</th>
            <th>Exact</th>
            <th>GD</th>
            <th>Result</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <p id="msgWeek" class="muted">Loading‚Ä¶</p>
    </section>

    <!-- SEASON -->
    <section id="paneSeason" class="pane">
      <h2 style="margin:0 0 4px 0;">Season Standings</h2>
      <p class="muted">Aug 1 ‚Üí Jun 30</p>
      <table id="tblSeason" style="display:none">
        <thead>
          <tr>
            <th>#</th>
            <th class="left">Name</th>
            <th>Rank</th>
            <th>Points</th>
            <th>Played</th>
            <th>Exact</th>
            <th>GD</th>
            <th>Result</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <p id="msgSeason" class="muted">Loading‚Ä¶</p>
    </section>

    <p class="muted" style="margin-top:10px"><a href="index.html">‚Üê Back to home</a></p>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase-config.js"></script>
  <script>
    // --- Small helpers ---
    function pointsFor(pred, actual){
      if(!actual) return { pts:0, exact:0, gd:0, res:0, played:0 };
      const ph=+pred.home_goals, pa=+pred.away_goals, ah=+actual.home, aa=+actual.away;
      const pRes = ph===pa?'D':ph>pa?'H':'A'; const aRes = ah===aa?'D':ah>aa?'H':'A';
      const correctRes = pRes===aRes?1:0; const correctGD = (ph-pa)===(ah-aa)?1:0; const exact=(ph===ah&&pa===aa)?1:0;
      let pts = (correctRes?3:0)+(correctGD?1:0)+(exact?1:0); if(pts>5) pts=5;
      return { pts, exact, gd:correctGD, res:correctRes, played:1 };
    }
    function rankFor(exactCount){
      if (exactCount >= 30) return { key:'goat', label:'üêê GOAT' };
      if (exactCount >= 25) return { key:'pro', label:'üèÜ Pro' };
      if (exactCount >= 10) return { key:'amateur', label:'üéñÔ∏è Amateur' };
      return { key:'rookie', label:'üå± Rookie' };
    }
    const CRESTS = {
      'Arsenal':'https://resources.premierleague.com/premierleague/badges/70/t3.png',
      'Aston Villa':'https://resources.premierleague.com/premierleague/badges/70/t7.png',
      'AFC Bournemouth':'https://resources.premierleague.com/premierleague/badges/70/t91.png',
      'Brentford':'https://resources.premierleague.com/premierleague/badges/70/t94.png',
      'Brighton & Hove Albion':'https://resources.premierleague.com/premierleague/badges/70/t36.png',
      'Chelsea':'https://resources.premierleague.com/premierleague/badges/70/t8.png',
      'Crystal Palace':'https://resources.premierleague.com/premierleague/badges/70/t31.png',
      'Everton':'https://resources.premierleague.com/premierleague/badges/70/t11.png',
      'Fulham':'https://resources.premierleague.com/premierleague/badges/70/t54.png',
      'Ipswich Town':'https://resources.premierleague.com/premierleague/badges/70/t40.png',
      'Leicester City':'https://resources.premierleague.com/premierleague/badges/70/t13.png',
      'Liverpool':'https://resources.premierleague.com/premierleague/badges/70/t14.png',
      'Manchester City':'https://resources.premierleague.com/premierleague/badges/70/t43.png',
      'Manchester United':'https://resources.premierleague.com/premierleague/badges/70/t1.png',
      'Newcastle United':'https://resources.premierleague.com/premierleague/badges/70/t4.png',
      'Nottingham Forest':'https://resources.premierleague.com/premierleague/badges/70/t17.png',
      'Southampton':'https://resources.premierleague.com/premierleague/badges/70/t20.png',
      'Tottenham Hotspur':'https://resources.premierleague.com/premierleague/badges/70/t6.png',
      'West Ham United':'https://resources.premierleague.com/premierleague/badges/70/t21.png',
      'Wolverhampton Wanderers':'https://resources.premierleague.com/premierleague/badges/70/t39.png',
    };
    function crestFor(team){ return CRESTS[team] || ''; }

    // --- Tabs ---
    const tabWeek=document.getElementById('tabWeek');
    const tabSeason=document.getElementById('tabSeason');
    const paneWeek=document.getElementById('paneWeek');
    const paneSeason=document.getElementById('paneSeason');
    function setTab(which){
      tabWeek.classList.toggle('active', which==='week');
      tabSeason.classList.toggle('active', which==='season');
      paneWeek.classList.toggle('active', which==='week');
      paneSeason.classList.toggle('active', which==='season');
    }
    tabWeek.onclick=()=>setTab('week');
    tabSeason.onclick=()=>setTab('season');

    // --- Data load ---
    const client = supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);

    async function load(){
      // 1) All predictions
      const { data: preds, error:pErr } = await client
        .from('predictions')
        .select('user_id,fixture_id,home_goals,away_goals');
      if (pErr){ document.getElementById('msgWeek').textContent=document.getElementById('msgSeason').textContent='Error: '+pErr.message; return; }
      if (!preds?.length){ document.getElementById('msgWeek').textContent=document.getElementById('msgSeason').textContent='No predictions yet.'; return; }

      // 2) Fixtures referenced by those predictions (for kickoff time + results)
      const ids = [...new Set(preds.map(p=>p.fixture_id))];
      const { data: fx, error:fErr } = await client
        .from('fixtures')
        .select('id,utc_date,home_score,away_score')
        .in('id', ids);
      if (fErr){ document.getElementById('msgWeek').textContent=document.getElementById('msgSeason').textContent='Error loading fixtures: '+fErr.message; return; }
      const fxById = Object.fromEntries((fx||[]).map(f=>[f.id, f]));

      // 3) Profiles for display names + teams
      const userIds = [...new Set(preds.map(p=>p.user_id).filter(Boolean))];
      let profById = {};
      if (userIds.length){
        const { data: profs } = await client.from('profiles')
          .select('id,display_name,favorite_team')
          .in('id', userIds);
        (profs||[]).forEach(p=> profById[p.id]=p);
      }

      // Helper to totalise
      function accumulate(rows){
        const totals={};
        rows.forEach(r=>{
          const f = fxById[r.fixture_id];
          const finished = f && f.home_score!==null && f.away_score!==null;
          if (!finished) return; // score only if the game has a result

          const s = pointsFor(r, { home:f.home_score, away:f.away_score });
          const key = r.user_id || 'anon';
          if (!totals[key]) totals[key] = { user_id:r.user_id, label:'(no name set)', crest:'', pts:0,played:0,exact:0,gd:0,res:0 };
          const t = totals[key];
          t.pts+=s.pts; t.played+=s.played; t.exact+=s.exact; t.gd+=s.gd; t.res+=s.res;
        });

        // Enrich labels/crests
        Object.values(totals).forEach(t=>{
          const p = t.user_id ? profById[t.user_id] : null;
          t.label = p?.display_name || t.label;
          if (p?.favorite_team) t.crest = crestFor(p.favorite_team);
        });

        return Object.values(totals)
          .sort((a,b)=> b.pts-a.pts || b.exact-a.exact || a.label.localeCompare(b.label));
      }

      // --- WEEKLY: auto-detect most recent finished block users predicted in ---
      const finishedPreds = preds.filter(r=>{
        const f = fxById[r.fixture_id];
        return f && f.home_score!==null && f.away_score!==null;
      });
      if (!finishedPreds.length){
        document.getElementById('msgWeek').textContent='No finished, predicted fixtures yet.';
      } else {
        // Find the most recent finished fixture datetime among predicted ones
        const latestMs = Math.max(...finishedPreds.map(r=> new Date(fxById[r.fixture_id].utc_date).getTime()));
        // Define a ‚Äúweekend window‚Äù: latest - 4 days .. latest + 1 day
        const start = new Date(latestMs - 4*24*60*60*1000);
        const end   = new Date(latestMs + 1*24*60*60*1000);

        document.getElementById('weekRange').textContent =
          start.toLocaleString(undefined,{weekday:'short',month:'short',day:'2-digit'})+' ‚Üí '+
          end.toLocaleString(undefined,{weekday:'short',month:'short',day:'2-digit'});

        const weekRows = finishedPreds.filter(r=>{
          const t = new Date(fxById[r.fixture_id].utc_date);
          return t>=start && t<=end;
        });

        const weekly = accumulate(weekRows);
        const msgW=document.getElementById('msgWeek');
        const tblW=document.getElementById('tblWeek'); const tbW=tblW.querySelector('tbody');

        if (!weekly.length){ msgW.textContent='No scored predictions in the current block yet.'; }
        else{
          msgW.textContent=''; tbW.innerHTML='';
          weekly.forEach((r,i)=>{
            const tr=document.createElement('tr');
            tr.innerHTML = `
              <td>${i+1}</td>
              <td class="left">${r.label}</td>
              <td><b>${r.pts}</b></td>
              <td>${r.played}</td>
              <td>${r.exact}</td>
              <td>${r.gd}</td>
              <td>${r.res}</td>`;
            tbW.appendChild(tr);
          });
          tblW.style.display='';
        }
      }

      // --- SEASON totals (Aug 1 ‚Üí Jun 30) ---
      function seasonBoundsNow(){
        const now=new Date(); const y=now.getUTCFullYear(); const m=now.getUTCMonth()+1;
        const startY = (m>=8)? y : y-1; const endY = (m>=8)? y+1 : y;
        return { from:new Date(Date.UTC(startY,7,1,0,0,0)), to:new Date(Date.UTC(endY,5,30,23,59,59)) };
      }
      const { from:seaFrom, to:seaTo } = seasonBoundsNow();
      const seasonRows = preds.filter(r=>{
        const f = fxById[r.fixture_id]; if (!f) return false;
        const t = new Date(f.utc_date);
        const finished = f.home_score!==null && f.away_score!==null;
        return finished && t>=seaFrom && t<=seaTo;
      });

      const season = accumulate(seasonRows).map(r=>{
        return { ...r, rank: rankFor(r.exact) };
      });

      const msgS=document.getElementById('msgSeason');
      const tblS=document.getElementById('tblSeason'); const tbS=tblS.querySelector('tbody');
      if (!season.length){ msgS.textContent='No scored predictions in season yet.'; }
      else{
        msgS.textContent=''; tbS.innerHTML='';
        season.forEach((r,i)=>{
          const crest = r.crest ? `<img class="crest" src="${r.crest}" alt="crest">` : '';
          const tr=document.createElement('tr');
          tr.innerHTML = `
            <td>${i+1}</td>
            <td class="left"><div class="pname">${crest}<span>${r.label}</span></div></td>
            <td><span class="rank ${r.rank.key}">${r.rank.label}</span></td>
            <td><b>${r.pts}</b></td>
            <td>${r.played}</td>
            <td>${r.exact}</td>
            <td>${r.gd}</td>
            <td>${r.res}</td>`;
          tbS.appendChild(tr);
        });
        tblS.style.display='';
      }
    }

    load();
    // Optional light auto-refresh
    setInterval(load, 20000);
  </script>
</body>
</html>














