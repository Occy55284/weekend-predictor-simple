<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Leaderboard • Weekend Predictor</title>
  <link rel="stylesheet" href="brand.css" />
  
  <!-- Auth gate (standard) -->
  <script type="module">
    import { requireSession } from './app-auth.js';
    await requireSession();
  </script>
<style>
    /* Landscape like All Picks / Stats */
    .main-layout { grid-template-columns: 1fr !important; }

    .toolbar {
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      flex-wrap:wrap; margin: 10px 0 14px;
    }
    .toolbar-left{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }

    .tabs{
      display:inline-flex; gap:8px; border:1px solid rgba(148,163,184,0.35);
      border-radius:999px; padding:6px; background: rgba(2,6,23,0.35);
    }
    .tab{
      border:0; background:transparent; color:#e5e7eb; padding:8px 10px;
      border-radius:999px; font-weight:800; cursor:pointer; opacity:0.75;
    }
    .tab.active{
      opacity:1; background: rgba(96,165,250,0.22); border:1px solid rgba(96,165,250,0.55);
    }
    .date-input{
      border-radius:14px; border:1px solid rgba(148,163,184,0.35);
      background: rgba(2,6,23,0.35); padding:10px 12px; color:#e5e7eb;
      font-size:0.85rem; outline:none;
    }
    .date-input:focus{ border-color:#60a5fa; box-shadow: 0 0 0 1px rgba(96,165,250,0.5); }

    .status-line{ margin: 0 0 14px; color:#cbd5e1; }

    .table-wrap { overflow:auto; border-radius:16px; border:1px solid rgba(148,163,184,0.28); }
    table.lb { width:100%; border-collapse:collapse; min-width: 980px; }
    .lb th, .lb td{ padding:10px; border-bottom:1px solid rgba(148,163,184,0.18); text-align:center; }
    .lb thead th{ position:sticky; top:0; background: rgba(2,6,23,0.78); z-index:2; }

    .lb td.name, .lb th.name{ text-align:left; min-width: 280px; }
    .player-name{ font-weight:800; white-space:nowrap; }

    .rank-badge{
      display:inline-flex; align-items:center; justify-content:center;
      width:44px; height:28px; border-radius:999px;
      font-weight:900; font-size:0.8rem;
      border:1px solid rgba(148,163,184,0.35);
      background: rgba(2,6,23,0.35);
      color: rgba(229,231,235,0.95);
      margin-right:10px;
      flex: 0 0 auto;
    }
    .rank-1{ border-color: rgba(253,224,71,0.6); background: rgba(161,98,7,0.22); }
    .rank-2{ border-color: rgba(203,213,225,0.55); background: rgba(51,65,85,0.32); }
    .rank-3{ border-color: rgba(244,114,182,0.55); background: rgba(131,24,67,0.20); }

    .panel-side{ margin-top:18px; }
    .muted-center{ text-align:center; color:#9ca3af; }
    .err{ color:#fecaca; }
  </style>
</head>
<body class="bg-hero">
  <div class="page-shell">
    <header class="top-nav">
      <div class="top-nav-left">
        <div class="nav-logo">
          <img src="assets/brand-logo.png" alt="Weekend Predictor logo" />
        </div>
        <nav class="nav-links">
          <a href="index.html">Home</a>
          <a href="predict.html">Predict</a>
          <a href="my-picks.html">My Picks</a>
          <a href="all-picks.html">All Picks</a>
          <a class="active" href="leaderboard.html">Leaderboard</a>
          <a href="stats.html">Stats</a>
          <a href="wallet.html">Wallet</a>
          <a href="profile.html">Profile</a>
          <a id="navAdmin" href="admin.html" style="display:none;">Admin</a>
          <a id="navLogout" href="#">Logout</a>
        </nav>
      </div>
      <div class="top-nav-right">
        <span id="modeLabel" class="muted">Week</span>
      </div>
    </header>

    <main class="main-layout">
      <section class="panel">
        <div class="panel-inner">
          <h1>Leaderboard</h1>
          <div id="weekRange" class="muted"></div>

          <div class="toolbar">
            <div class="toolbar-left">
              <div class="tabs">
                <button id="tabWeek" class="tab active" type="button">Week</button>
                <button id="tabSeason" class="tab" type="button">Season</button>
              </div>
              <input id="weekPicker" class="date-input" type="date" />
              <button id="refreshBtn" class="btn" type="button">Refresh</button>
            </div>
            <div id="status" class="muted"></div>
          </div>

          <div id="statusLine" class="status-line">Loading…</div>

          <div id="tableWrapper" class="table-wrap" style="display:none;">
            <table class="lb">
              <thead>
                <tr>
                  <th class="name">Player</th>
                  <th>Exact</th>
                  <th>Correct</th>
                  <th>Points</th>
                </tr>
              </thead>
              <tbody id="tbody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <aside class="panel panel-side">
        <div class="panel-inner">
          <h2>Notes</h2>
          <ul class="bullet-list">
            <li><strong>Week</strong> = selected week (Mon–Sun).</li>
            <li><strong>Season</strong> = all finished fixtures.</li>
            <li>Points: 5 exact score, 3 correct result.</li>
            <li>AI Predictor appears as a normal player.</li>
          </ul>
        </div>
      </aside>
    </main>
  </div>

  <script type="module">
    import { supabase } from './supabase-config.js';

import { startOfWeekMonday, addDays as addDaysLocal, isoDate as isoDateLocal, parseISODate, formatWeekRange } from './app-week.js';
    const navAdmin = document.getElementById('navAdmin');
    const navLogout = document.getElementById('navLogout');

    const tabWeek = document.getElementById('tabWeek');
    const tabSeason = document.getElementById('tabSeason');
    const weekPicker = document.getElementById('weekPicker');
    const refreshBtn = document.getElementById('refreshBtn');

    const modeLabel = document.getElementById('modeLabel');
    const weekRange = document.getElementById('weekRange');
    const status = document.getElementById('status');
    const statusLine = document.getElementById('statusLine');

    const wrapper = document.getElementById('tableWrapper');
    const tbody = document.getElementById('tbody');

    let currentTab = 'week';

    function escapeHtml(s) {
      return String(s ?? '').replace(/[&<>"']/g, c => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      }[c]));
    }

    function startOfWeek(d = new Date()) {
      return startOfWeekMonday(d);
    }

    function addDays(d, n) {
      return addDaysLocal(d, n);
    }

    function isoDateOnly(d) {
      return isoDateLocal(d);
    }

    function isoStart(d) {
      const x = new Date(d);
      x.setHours(0,0,0,0);
      return x.toISOString();
    }

    function outcome(h,a) {
      if (h>a) return 'H';
      if (h<a) return 'A';
      return 'D';
    }

    function setTab(which) {
      currentTab = which;
      if (which === 'week') {
        tabWeek.classList.add('active');
        tabSeason.classList.remove('active');
        modeLabel.textContent = 'Week';
      } else {
        tabSeason.classList.add('active');
        tabWeek.classList.remove('active');
        modeLabel.textContent = 'Season';
      }
    }

    function renderRows(rows) {
      tbody.innerHTML = '';
      if (!rows.length) {
        tbody.innerHTML = '<tr><td colspan="4" class="muted-center">No data to show.</td></tr>';
        return;
      }

      rows.forEach((r, idx) => {
        const rank = idx + 1;
        const rankClass =
          rank === 1 ? 'rank-badge rank-1' :
          rank === 2 ? 'rank-badge rank-2' :
          rank === 3 ? 'rank-badge rank-3' :
          'rank-badge';

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="name">
            <span class="${rankClass}">#${rank}</span>
            <span class="player-name">${escapeHtml(r.name)}${r.is_ai ? ' <span class="ai-badge ai-inline">AI</span>' : ''}</span>
          </td>
          <td>${r.exact}</td>
          <td>${r.correct}</td>
          <td>${r.points}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function ensureSession() {
      const { data: { session } } = await supabase.auth.getSession();
      const user = session?.user;
      if (!user) {
        window.location.replace('login.html');
        return null;
      }

      try {
        const { data: prof } = await supabase
          .from('profiles')
          .select('is_admin')
          .eq('id', user.id)
          .maybeSingle();
        if (prof?.is_admin) navAdmin.style.display = '';
      } catch {}

      navLogout?.addEventListener('click', async (e)=>{
        e.preventDefault();
        try { await supabase.auth.signOut(); } catch {}
        window.location.replace('login.html');
      });

      return user;
    }

    async function loadLeaderboard(which) {
      setTab(which);
      status.textContent = 'Loading…';
      statusLine.textContent = 'Loading…';
      wrapper.style.display = 'none';
      tbody.innerHTML = '';

      // week window (for Week tab)
      const base = weekPicker.value ? new Date(weekPicker.value) : new Date();
      const ws = startOfWeek(base);
      const we = addDays(ws, 7);

      weekRange.textContent = `${ws.toLocaleDateString()} – ${addDays(ws,6).toLocaleDateString()} (Mon–Sun)`;

      // Load ALL players (so leaderboard always shows everyone)
      const { data: profiles, error: pfErr } = await supabase
        .from('profiles')
        .select('id, display_name, is_ai')
        .order('display_name', { ascending: true });

      if (pfErr) {
        console.error(pfErr);
        status.textContent = '';
        statusLine.innerHTML = '<span class="err">Could not load players.</span>';
        return;
      }

      const players = (profiles || [])
        .map(p => ({ id: p.id, name: p.display_name || 'Player', is_ai: !!p.is_ai }))
        .sort((a,b)=>{
          if (a.is_ai !== b.is_ai) return a.is_ai ? 1 : -1;
          return a.name.localeCompare(b.name);
        });

      // Load finished fixtures (week or season)
      let fxQuery = supabase
        .from('fixtures')
        .select('id, utc_date, home_score, away_score, status')
        .eq('status', 'FINISHED')
        .not('home_score', 'is', null)
        .not('away_score', 'is', null);

      if (which === 'week') {
        fxQuery = fxQuery.gte('utc_date', isoStart(ws)).lt('utc_date', isoStart(we));
      }

      const { data: fixtures, error: fxErr } = await fxQuery;

      if (fxErr) {
        console.error(fxErr);
        status.textContent = '';
        statusLine.innerHTML = '<span class="err">Could not load finished fixtures.</span>';
        return;
      }

      if (!fixtures || fixtures.length === 0) {
        // show everyone with zeros
        const rowsZero = players.map(p => ({ ...p, points:0, exact:0, correct:0 }));
        renderRows(rowsZero);
        status.textContent = '';
        statusLine.textContent = which === 'week'
          ? 'No finished fixtures yet this week (showing zeros).'
          : 'No finished fixtures yet (showing zeros).';
        wrapper.style.display = '';
        return;
      }

      const fxMap = new Map(fixtures.map(f => [f.id, f]));
      const fixtureIds = fixtures.map(f => f.id);

      // Predictions for those fixtures
      const { data: preds, error: prErr } = await supabase
        .from('predictions')
        .select('user_id, fixture_id, home_goals, away_goals')
        .in('fixture_id', fixtureIds);

      if (prErr) {
        console.error(prErr);
        status.textContent = '';
        statusLine.innerHTML = '<span class="err">Could not load predictions.</span>';
        return;
      }

      // Aggregate
      const statsByUser = new Map(players.map(p => [p.id, { points:0, exact:0, correct:0 }]));

      for (const p of (preds || [])) {
        const fx = fxMap.get(p.fixture_id);
        if (!fx) continue;

        const ah = fx.home_score, aa = fx.away_score;
        const ph = p.home_goals, pa = p.away_goals;
        if (ph == null || pa == null) continue;

        if (!statsByUser.has(p.user_id)) statsByUser.set(p.user_id, { points:0, exact:0, correct:0 });
        const s = statsByUser.get(p.user_id);

        if (ph === ah && pa === aa) { s.points += 5; s.exact += 1; s.correct += 1; }
        else if (outcome(ph, pa) === outcome(ah, aa)) { s.points += 3; s.correct += 1; }
      }

      const rows = players.map(pl => {
        const s = statsByUser.get(pl.id) || { points:0, exact:0, correct:0 };
        return { ...pl, points: s.points, exact: s.exact, correct: s.correct };
      });

      // Sort: AI at bottom, then points desc
      rows.sort((a,b)=>{
        if (a.is_ai !== b.is_ai) return a.is_ai ? 1 : -1;
        if (b.points !== a.points) return b.points - a.points;
        if (b.exact !== a.exact) return b.exact - a.exact;
        if (b.correct !== a.correct) return b.correct - a.correct;
        return a.name.localeCompare(b.name);
      });

      renderRows(rows);
      status.textContent = '';
      statusLine.textContent = which === 'week' ? 'Loaded week leaderboard.' : 'Loaded season leaderboard.';
      wrapper.style.display = '';
    }

    (async () => {
      await ensureSession();

      // Default week = this Monday
      const ws = startOfWeek(new Date());
      weekPicker.value = isoDateOnly(ws);

      refreshBtn.addEventListener('click', () => loadLeaderboard(currentTab));
      tabWeek.addEventListener('click', () => loadLeaderboard('week'));
      tabSeason.addEventListener('click', () => loadLeaderboard('season'));

      await loadLeaderboard('week');
    })();
  </script>
</body>
</html>
