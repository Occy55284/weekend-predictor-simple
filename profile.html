<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Your Profile • Weekend Predictor</title>
  <link rel="stylesheet" href="brand.css?v=91" />
  <style>
    /* Page-only light styles that sit on top of brand.css */
    .wrap { max-width: 1100px; margin: 0 auto; padding: 16px; }
    .grid { display: grid; grid-template-columns: 1fr; gap: 18px; }
    @media (min-width: 900px) { .grid { grid-template-columns: 1fr 1fr; } }

    .card {
      background: #fff; border: 1px solid #e5e7eb; border-radius: 20px;
      box-shadow: 0 12px 30px rgba(0,0,0,.08); padding: 18px;
    }
    .h1 { font-size: 28px; line-height: 1.15; margin: 0 0 12px; }
    .sub { color: #475569; margin-bottom: 16px; }

    .label { font-weight: 700; margin: 12px 0 6px; }
    .input, .select {
      width: 100%; padding: 14px 16px; border: 1px solid #e5e7eb;
      border-radius: 12px; background: #f8fafc;
      font-size: 16px; outline: none;
    }
    .input:focus, .select:focus { border-color: #94a3b8; background:#fff; }

    .btnrow { display: flex; flex-wrap: wrap; gap: 12px; margin-top: 16px; }
    .btn { padding: 12px 16px; border-radius: 12px; border: 1px solid #2d3df7; cursor: pointer; font-weight: 700; }
    .btn--primary { background: #2d3df7; color: #fff; }
    .btn--ghost { background: transparent; color: #2d3df7; }
    .small { font-size: 12px; letter-spacing: .06em; color: #475569; text-transform: uppercase; }

    .ok-text { color: #0e9f6e; margin-top: 8px; }
    .error-text { color: #e11d48; margin-top: 8px; }

    .stats-strip { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 18px; }
    .stats-pill {
      border: 1px dashed #e5e7eb; border-radius: 14px; padding: 14px;
      background: #f8fafc;
    }
    .stat-title { font-size: 12px; letter-spacing:.05em; color:#64748b; text-transform: uppercase; }
    .stat-value { font-size: 22px; font-weight: 800; color:#0f172a; }

    .badge-row { display: flex; align-items: center; gap: 10px; }
    .badge { border-radius: 999px; padding: 8px 12px; background:#eef2ff; color:#1e3a8a; font-weight:700; }
    .progress { height: 10px; border-radius: 999px; background:#e5e7eb; overflow:hidden; margin: 16px 0; }
    .progress > span { display:block; height:100%; width: 10%; background:#4f46e5; }

    .list { padding-left: 18px; }
    .list li { margin: 8px 0; color:#475569; }

    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
    @media (max-width: 640px) { .row { grid-template-columns: 1fr; } }

    /* Favourite team card */
    #fav-team-card { display:none; align-items:center; gap:12px; padding:14px; }
    #fav-team-crest { border-radius:12px; width:54px; height:54px; object-fit:contain; background:#f8fafc; }
  </style>
</head>
<body>
  <header class="wrap" style="padding-bottom:0;">
    <nav style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
      <a href="index.html" class="small" style="text-decoration:none;">← Home</a>
      <div style="display:flex; gap:10px; align-items:center;">
        <a href="predict.html" class="small" style="text-decoration:none;">Predictions</a>
        <a href="leaderboard.html" class="small" style="text-decoration:none;">Leaderboard</a>
        <a href="profile.html" class="small" style="text-decoration:underline;">Profile</a>
      </div>
    </nav>
  </header>

  <main class="wrap">
    <div class="grid">
      <!-- LEFT: Profile form -->
      <section class="card">
        <h1 class="h1">Your profile</h1>
        <p class="sub">Signed in as <span id="signed-in-email" style="font-weight:700;"></span></p>

        <label class="label" for="email">Email</label>
        <input id="email" class="input" type="email" placeholder="your@email.com" disabled />

        <label class="label" for="display-name">Display name</label>
        <input id="display-name" class="input" type="text" placeholder="e.g. Mark" />

        <label class="label" for="favorite-team">Favourite team</label>
        <select id="favorite-team" class="select"></select>

        <div class="btnrow">
          <button id="save-profile-btn" class="btn btn--primary">Save changes</button>
          <a class="btn btn--ghost" href="predict.html">Go to predictions</a>
          <a class="btn btn--ghost" href="rivals.html">Open rivals</a>
        </div>

        <p id="profile-ok" class="ok-text"></p>
        <p id="profile-error" class="error-text"></p>

        <div class="stats-strip">
          <div class="stats-pill">
            <div class="stat-title">Total picks</div>
            <div id="stat-picks" class="stat-value">—</div>
          </div>
          <div class="stats-pill">
            <div class="stat-title">Accuracy</div>
            <div id="stat-accuracy" class="stat-value">—</div>
          </div>
        </div>
      </section>

      <!-- RIGHT: Status & badges -->
      <section class="card">
        <h2 class="h1" style="font-size:24px;">Status &amp; Badges</h2>

        <div class="badge-row">
          <div class="badge">— none yet</div>
        </div>

        <div class="progress" aria-label="Progress to next badge">
          <span style="width: 10%;"></span>
        </div>
        <p class="small">Next milestone: ROOKIE (10) — <span id="to-go">9</span> to go</p>

        <div class="row" style="margin-top:8px;">
          <div>
            <h3 class="h1" style="font-size:22px;">Your Numbers</h3>
            <p style="color:#475569;">
              Exact scores: <span id="num-exact">—</span> •
              Correct results: <span id="num-correct">—</span> •
              Points: <span id="num-points">—</span> •
              Season rank: <span id="num-rank">—</span>
            </p>

            <!-- Favourite Team preview block -->
            <div id="fav-team-wrap" style="margin-top:20px;">
              <div id="fav-team-card" class="card">
                <img id="fav-team-crest" alt="Team crest">
                <div>
                  <div style="font-weight:700;">Your favourite team</div>
                  <div id="fav-team-name" style="opacity:.8;"></div>
                </div>
              </div>
            </div>
          </div>

          <div>
            <h3 class="h1" style="font-size:22px;">How badges work</h3>
            <ul class="list">
              <li>Badge tiers by <strong>Exact Scores</strong>: Rookie (10), Amateur (15), Pro (20), GOAT (30)</li>
              <li>Badges appear next to your name on the Leaderboard</li>
              <li>Scoring: 5 pts exact score • 3 pts correct result</li>
            </ul>
          </div>
        </div>
      </section>
    </div>
  </main>

  <!-- Supabase + page logic -->
  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'
    import { SUPABASE_URL, SUPABASE_ANON_KEY } from './supabase-config.js'

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

    // ====== Team list (add crests in assets/crests/<slug>.png) ======
    const TEAMS = [
      { slug: 'arsenal', label: 'Arsenal' },
      { slug: 'aston-villa', label: 'Aston Villa' },
      { slug: 'bournemouth', label: 'Bournemouth' },
      { slug: 'brentford', label: 'Brentford' },
      { slug: 'brighton', label: 'Brighton' },
      { slug: 'chelsea', label: 'Chelsea' },
      { slug: 'crystal-palace', label: 'Crystal Palace' },
      { slug: 'everton', label: 'Everton' },
      { slug: 'fulham', label: 'Fulham' },
      { slug: 'ipswich', label: 'Ipswich Town' },
      { slug: 'leicester', label: 'Leicester City' },
      { slug: 'liverpool', label: 'Liverpool' },
      { slug: 'man-city', label: 'Manchester City' },
      { slug: 'man-united', label: 'Manchester United' },
      { slug: 'newcastle', label: 'Newcastle United' },
      { slug: 'nottingham-forest', label: 'Nottingham Forest' },
      { slug: 'southampton', label: 'Southampton' },
      { slug: 'spurs', label: 'Tottenham Hotspur' },
      { slug: 'west-ham', label: 'West Ham United' },
      { slug: 'wolves', label: 'Wolves' },
      // Requested:
      { slug: 'watford', label: 'Watford' },
    ]

    // ====== Helpers ======
    const $ = (id) => document.getElementById(id)
    const emailEl = $('email')
    const signedInEmail = $('signed-in-email')
    const displayNameEl = $('display-name')
    const teamSelect = $('favorite-team')
    const crestImg = $('fav-team-crest')
    const crestName = $('fav-team-name')
    const crestCard = $('fav-team-card')

    function renderTeamOptions () {
      teamSelect.innerHTML = '<option value=\"\">— Choose your team —</option>'
      TEAMS.forEach(t => {
        const opt = document.createElement('option')
        opt.value = t.slug
        opt.textContent = t.label
        teamSelect.appendChild(opt)
      })
    }

    function crestUrlFor (slug) {
      return slug ? `assets/crests/${slug}.png` : ''
    }

    function showCrest (slug) {
      if (!slug) { crestCard.style.display = 'none'; return }
      const t = TEAMS.find(x => x.slug === slug)
      crestImg.src = crestUrlFor(slug)
      crestImg.onerror = () => { crestImg.src = 'assets/crests/_placeholder.png' } // optional fallback
      crestName.textContent = t ? t.label : slug
      crestCard.style.display = 'flex'
    }

    // ====== Load profile ======
    async function loadProfile () {
      const { data: { user } } = await supabase.auth.getUser()
      if (!user) {
        window.location.href = 'login.html'
        return
      }

      signedInEmail.textContent = user.email || ''
      if (emailEl) emailEl.value = user.email || ''

      const { data, error } = await supabase
        .from('profiles')
        .select('email, display_name, favorite_team, total_picks, accuracy, exact_scores, correct_results, points, season_rank')
        .eq('id', user.id)
        .single()

      if (error && error.code !== 'PGRST116') {
        console.error('Load profile error:', error)
      }

      if (data?.display_name) displayNameEl.value = data.display_name
      if (data?.favorite_team) {
        teamSelect.value = data.favorite_team
        showCrest(data.favorite_team)
      } else {
        showCrest('')
      }

      // Optional numbers (only if your table has these columns):
      if (data?.total_picks != null) $('stat-picks').textContent = data.total_picks
      if (data?.accuracy != null) $('stat-accuracy').textContent = `${data.accuracy}%`
      if (data?.exact_scores != null) $('num-exact').textContent = data.exact_scores
      if (data?.correct_results != null) $('num-correct').textContent = data.correct_results
      if (data?.points != null) $('num-points').textContent = data.points
      if (data?.season_rank != null) $('num-rank').textContent = `#${data.season_rank}`
    }

    // ====== Save profile ======
    async function saveProfile () {
      const okEl = $('profile-ok')
      const errEl = $('profile-error')
      okEl.textContent = ''; errEl.textContent = ''

      const { data: { user } } = await supabase.auth.getUser()
      if (!user) { window.location.href = 'login.html'; return }

      const displayName = (displayNameEl.value || '').trim()
      const favoriteTeam = teamSelect.value || null

      const { error } = await supabase
        .from('profiles')
        .upsert({
          id: user.id,
          email: user.email,
          display_name: displayName || null,
          favorite_team: favoriteTeam,     // IMPORTANT: consistent field name
          updated_at: new Date().toISOString()
        }, { onConflict: 'id' })

      if (error) {
        console.error(error)
        errEl.textContent = 'Could not save your profile.'
        return
      }

      okEl.textContent = 'Profile saved.'
      showCrest(favoriteTeam)
    }

    // ====== Wire up ======
    renderTeamOptions()
    teamSelect.addEventListener('change', () => showCrest(teamSelect.value))
    $('save-profile-btn').addEventListener('click', (e) => { e.preventDefault(); saveProfile() })

    // Kick off
    loadProfile()
  </script>
</body>
</html>
