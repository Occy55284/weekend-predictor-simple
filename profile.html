<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>My Profile • Weekend Predictor</title>
  <link rel="stylesheet" href="brand.css?v=96" />

  <!-- ✅ Early auth gate -->
  <script type="module">
    import { supabase } from './supabase-config.js'
    const { data: { session } } = await supabase.auth.getSession()
    if (!session) {
      window.location.replace('login.html')
      throw new Error('Redirecting to login')
    }
  </script>

  <style>
    :root{
      --ink:#0f1a37;
      --ink-2:#26335d;
      --muted:#6b7aa6;
      --card: #ffffff;
      --ring:#cfd6f2;
      --accent:#3049d1;
      --accent-2:#5b7cff;
      --good:#14b85a;
      --warn:#f59e0b;
      --bad:#ef4444;
      --bg-grad: radial-gradient(1200px 700px at 90% -10%, rgba(48,73,209,.08), transparent 40%),
                 radial-gradient(900px 600px at -10% 120%, rgba(91,124,255,.10), transparent 40%),
                 linear-gradient(180deg, #0b1220, #0e1630);
    }

    body.bg-hero{background:var(--bg-grad)}

    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media (min-width:980px){ .grid{grid-template-columns:1fr 1fr} }

    /* Cards with subtle premium gradient + ring */
    .card{
      position:relative;
      background:var(--card);
      border:1px solid var(--ring);
      border-radius:20px;
      box-shadow: 0 12px 30px rgba(0,0,0,.10);
      padding:18px;
      overflow:hidden;
      isolation:isolate;
    }
    .card::before{
      content:"";
      position:absolute; inset:0;
      background: radial-gradient(500px 320px at -10% -20%, rgba(91,124,255,.10), transparent 40%),
                  radial-gradient(420px 280px at 110% 120%, rgba(20,184,90,.10), transparent 40%);
      pointer-events:none; z-index:-1;
    }
    .card h2{margin:0 0 12px;color:var(--ink);font-size:1.5rem;letter-spacing:.2px}

    /* Profile top */
    .profile-top{display:flex;gap:16px;align-items:center;margin-bottom:12px}
    .avatar{
      width:64px;height:64px;border-radius:16px;background:#0f152c;color:#eaf0ff;
      display:grid;place-items:center;font-weight:900;font-size:1.25rem;
      border:1px solid rgba(255,255,255,.12); box-shadow: inset 0 0 30px rgba(91,124,255,.15);
    }
    .who{color:var(--muted);font-size:.95rem}

    /* Form */
    .row{display:flex;flex-direction:column;gap:6px;margin:10px 0}
    label{font-weight:800;color:var(--ink)}
    input[type="text"], input[type="email"], select{
      padding:12px 14px;border:1px solid #d8def8;border-radius:12px;font-size:16px;background:#fff;
      outline:none; transition:.15s border-color ease, .15s box-shadow ease;
    }
    input[type="text"]:focus, select:focus{
      border-color:#a6b3f7; box-shadow:0 0 0 4px rgba(166,179,247,.25)
    }
    input[readonly]{background:#f7f9ff;color:#7c87b2}

    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .btn{padding:12px 16px;border:1px solid var(--accent);background:var(--accent);color:#fff;border-radius:12px;font-weight:800;cursor:pointer}
    .btn:hover{filter:brightness(1.05)}
    .btn.secondary{background:#fff;color:var(--accent)}
    .btn.ghost{background:#fff;border-color:#d8def8;color:var(--ink)}

    .status{margin-top:10px;font-weight:800}
    .ok{color:var(--good)} .err{color:var(--bad)} .muted{color:var(--muted)}

    /* Stat blocks */
    .stats{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
    .stat{
      border:1px dashed #d8def8;border-radius:12px;padding:10px 12px;
      background:linear-gradient(180deg, #ffffff, #fbfdff);
    }
    .stat .k{font-size:.8rem;color:var(--muted);text-transform:uppercase;letter-spacing:.08em}
    .stat .v{font-weight:900;color:var(--ink);font-size:1.15rem}

    /* Progress / badges */
    .badge-pill{
      display:inline-flex;align-items:center;gap:8px;
      background:#eef3ff;border:1px solid #dbe4ff;color:#22316b;
      padding:8px 12px;border-radius:999px;font-weight:800
    }
    .badge-pill .emoji{font-size:1.1rem}

    .bar{
      position:relative;height:10px;border-radius:999px;background:#edf1ff;border:1px solid #d8def8;overflow:hidden;margin:10px 0 6px;
    }
    .bar > .fill{
      height:100%; width:0%;
      background:linear-gradient(90deg, var(--accent), var(--accent-2));
      box-shadow:0 4px 14px rgba(48,73,209,.35) inset;
      transition: width .9s cubic-bezier(.2,.8,.2,1);
    }
    .legend{font-size:.9rem;color:var(--muted)}

    /* Two-column lower area */
    .lower{display:grid;grid-template-columns:1fr;gap:16px;margin-top:8px}
    @media (min-width:980px){ .lower{grid-template-columns:1fr 1fr} }

    /* Header nav is already in brand.css; just keep */
  </style>
</head>
<body class="bg-hero">
  <header class="top">
    <div class="inner">
      <a class="logo" href="index.html">WP</a>
      <nav class="topnav">
        <a href="predict.html" data-nav="predict">Predict</a>
        <a href="leaderboard.html" data-nav="leaderboard">Leaderboard</a>
        <a href="profile.html" data-nav="profile" class="active">Profile</a>
        <a href="admin.html" id="navAdmin" style="display:none">Admin</a>
        <a class="logout" id="navLogout" href="login.html">Logout</a>
      </nav>
    </div>
  </header>

  <main class="wrap">
    <div class="grid">
      <!-- LEFT: Profile editor / identity -->
      <section class="card">
        <div class="profile-top">
          <div class="avatar" id="avatar">U</div>
          <div>
            <h2>Your profile</h2>
            <div class="who" id="who">—</div>
          </div>
        </div>

        <div class="row">
          <label for="email">Email</label>
          <input id="email" type="email" readonly />
        </div>

        <div class="row">
          <label for="display_name">Display name</label>
          <input id="display_name" type="text" placeholder="Your name as shown on the leaderboard" />
        </div>

        <div class="row">
          <label for="team">Favourite team</label>
          <select id="team">
            <option value="">— Select a team —</option>
          </select>
        </div>

        <div class="actions">
          <button id="saveBtn" class="btn" type="button">Save changes</button>
          <a class="btn ghost" href="predict.html">Go to predictions</a>
          <a class="btn secondary" href="leaderboard.html">Open rivals</a>
        </div>
        <div id="status" class="status muted">Loading your profile…</div>

        <div class="stats">
          <div class="stat">
            <div class="k">Total Picks</div>
            <div class="v" id="stat_total">—</div>
          </div>
          <div class="stat">
            <div class="k">Accuracy</div>
            <div class="v"><span id="stat_acc">—</span><span style="font-weight:700;color:var(--muted);font-size:.95rem">%</span></div>
          </div>
        </div>
      </section>

      <!-- RIGHT: Status / badges / progress -->
      <section class="card">
        <h2>Status & Badges</h2>

        <div id="badgePill" class="badge-pill" style="margin-bottom:8px">
          <span class="emoji">🎯</span>
          <span id="badgeLabel">— none yet</span>
        </div>

        <div class="bar"><div class="fill" id="barFill"></div></div>
        <div class="legend" id="nextMilestone">Next milestone: —</div>

        <div class="lower">
          <div>
            <h3 style="margin:12px 0 6px;color:var(--ink)">Your Numbers</h3>
            <div class="legend" id="nums">—</div>
          </div>
          <div>
            <h3 style="margin:12px 0 6px;color:var(--ink)">How badges work</h3>
            <ul class="legend" style="margin:0 0 0 18px">
              <li>Badge tiers by <strong>Exact Scores</strong>: Rookie (10), Amateur (15), Pro (20), GOAT (30)</li>
              <li>Badges appear next to your name on the Leaderboard</li>
              <li>Scoring: 5 pts exact score • 3 pts correct result</li>
            </ul>
          </div>
        </div>
      </section>
    </div>
  </main>

  <!-- 🚪 Logout wiring -->
  <script type="module">
    import { supabase } from './supabase-config.js'
    document.addEventListener('DOMContentLoaded', ()=>{
      const navLogout = document.getElementById('navLogout');
      navLogout?.addEventListener('click', async (e)=>{
        e.preventDefault();
        try { await supabase.auth.signOut(); } catch {}
        window.location.replace('login.html');
      });
    });
  </script>

  <!-- 🧠 Page logic -->
  <script type="module">
    import { supabase } from './supabase-config.js'

    // Elements
    const avatar = document.getElementById('avatar')
    const emailEl = document.getElementById('email')
    const nameEl  = document.getElementById('display_name')
    const teamEl  = document.getElementById('team')
    const whoEl   = document.getElementById('who')
    const status  = document.getElementById('status')
    const saveBtn = document.getElementById('saveBtn')

    const badgePill = document.getElementById('badgePill')
    const badgeLabel= document.getElementById('badgeLabel')
    const barFill   = document.getElementById('barFill')
    const nextMs    = document.getElementById('nextMilestone')
    const nums      = document.getElementById('nums')

    const statTotal = document.getElementById('stat_total')
    const statAcc   = document.getElementById('stat_acc')

    // Session
    const { data: { session} } = await supabase.auth.getSession()
    const user = session.user

    // Show admin link if applicable
    ;(async ()=>{
      try{
        const { data, error } = await supabase
          .from('profiles').select('is_admin').eq('id', user.id).single()
        if (!error && data?.is_admin) document.getElementById('navAdmin').style.display = ''
      }catch{}
    })();

    // Basics
    emailEl.value = user.email || ''
    whoEl.textContent = `Signed in as ${user.email || '—'}`
    avatar.textContent = initialsFrom(nameEl.value || user.email || 'User')

    // Helpers
    function initialsFrom(s){
      s = (s||'').trim()
      if (!s) return 'U'
      const parts = s.split(/\s+/).slice(0,2)
      return parts.map(p=>p[0].toUpperCase()).join('')
    }
    function escapeHtml(s='') {
      return String(s)
        .replaceAll('&','&amp;').replaceAll('<','&lt;')
        .replaceAll('>','&gt;').replaceAll('"','&quot;')
        .replaceAll("'",'&#39;')
    }

    // Teams list
    async function populateTeams() {
      let teams = []
      try {
        const { data, error } = await supabase
          .from('teams')
          .select('name')
          .order('name', { ascending: true })
        if (!error && data?.length) {
          teams = data.map(r => r.name).filter(Boolean)
        }
      } catch {}
      if (!teams.length) {
        teams = [
          'Arsenal','Aston Villa','Bournemouth','Brentford','Brighton',
          'Chelsea','Crystal Palace','Everton','Fulham','Ipswich',
          'Leicester','Liverpool','Man City','Man United','Newcastle',
          'Nottingham Forest','Southampton','Spurs','West Ham','Wolves'
        ]
      }
      const current = teamEl.value
      teamEl.innerHTML = '<option value="">— Select a team —</option>' +
        teams.map(t => `<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`).join('')
      if (current) teamEl.value = current
    }

    // Load profile row (display_name, team)
    async function loadProfile() {
      status.textContent = 'Loading your profile…'
      const { data, error } = await supabase
        .from('profiles')
        .select('display_name, team')
        .eq('id', user.id)
        .maybeSingle()

      if (error) {
        console.error(error)
        status.innerHTML = '<span class="err">Could not load profile.</span>'
        return
      }
      if (data) {
        nameEl.value = data.display_name ?? ''
        teamEl.value = data.team ?? ''
        avatar.textContent = initialsFrom(nameEl.value || user.email || 'User')
      }
      status.textContent = ''
    }

    // Load headline numbers (points, rank, exacts, results)
    async function loadNumbers() {
      let points = 0, rank = '—', exacts = 0, results = 0

      // Prefer the leaderboard view for exacts/results if present
      try {
        const { data: lb } = await supabase
          .from('leaderboard')
          .select('points, rank, exacts, results')
          .eq('user_id', user.id)
          .maybeSingle()
        if (lb) {
          points  = Number(lb.points ?? 0)
          rank    = lb.rank ?? '—'
          exacts  = Number(lb.exacts ?? 0)
          results = Number(lb.results ?? 0)
        } else {
          // fallback to RPC for points/rank
          const { data: rp } = await supabase.rpc('season_progress', { uid: user.id })
          if (Array.isArray(rp) && rp.length) {
            points = Number(rp[0].points ?? 0)
            rank   = rp[0].rank ?? '—'
          } else if (rp && typeof rp === 'object') {
            points = Number(rp.points ?? 0)
            rank   = rp.rank ?? '—'
          }
        }
      } catch (e) { console.warn(e) }

      // Mini stats: total picks & accuracy
      let totalPicks = 0
      try {
        const { count } = await supabase
          .from('predictions')
          .select('fixture_id', { count: 'exact', head: true })
          .eq('user_id', user.id)
        totalPicks = Number(count ?? 0)
      } catch {}

      const totalCorrect = exacts + results
      const accuracy = totalPicks ? Math.round((totalCorrect / totalPicks) * 100) : 0

      // Update UI
      document.getElementById('stat_total').textContent = String(totalPicks)
      document.getElementById('stat_acc').textContent = String(accuracy)
      nums.innerHTML = `
        Exact scores: <strong>${exacts}</strong> •
        Correct results: <strong>${results}</strong> •
        Points: <strong>${points}</strong> •
        Season rank: <strong>#${escapeHtml(String(rank))}</strong>
      `

      // Badges by exacts
      const tiers = [
        { name:'— none yet', emoji:'🎯', need:0 },
        { name:'Rookie', emoji:'🥇', need:10 },
        { name:'Amateur', emoji:'🥈', need:15 },
        { name:'Pro', emoji:'🏆', need:20 },
        { name:'GOAT', emoji:'🐐', need:30 },
      ]
      let current = tiers[0], next = tiers[1]
      for (let i=tiers.length-1;i>=0;i--){
        if (exacts >= tiers[i].need){ current = tiers[i]; next = tiers[i+1] || null; break }
      }
      badgeLabel.textContent = `${current.name}${current.need?` • ${exacts}/${current.need}`:''}`
      badgePill.querySelector('.emoji').textContent = current.emoji

      // Progress calc: percent toward next tier (or full if GOAT)
      let pct = 100
      if (next) {
        const base = current.need
        const span = next.need - base
        pct = Math.max(0, Math.min(100, Math.round(((exacts - base) / span) * 100)))
        nextMs.textContent = `Next milestone: ${next.name.toUpperCase()} (${next.need}) — ${Math.max(0,next.need-exacts)} to go`
      } else {
        nextMs.textContent = `Max tier reached: GOAT`
      }
      // animate bar fill (small delay so transition runs)
      requestAnimationFrame(()=>{ barFill.style.width = pct + '%' })

      // Confetti if you’ve just hit an exact-tier boundary (simple celebration when on a tier number)
      if ([10,15,20,30].includes(exacts)) fireConfetti(400)
    }

    async function saveProfile() {
      const display_name = nameEl.value.trim()
      const team = teamEl.value.trim()
      if (!display_name) {
        status.innerHTML = '<span class="err">Please enter a display name.</span>'
        return
      }
      saveBtn.disabled = true
      status.textContent = 'Saving…'
      const { error } = await supabase
        .from('profiles')
        .upsert({ id: user.id, display_name, team }, { onConflict: 'id' })

      if (error) {
        console.error(error)
        status.innerHTML = '<span class="err">Could not save your profile.</span>'
        saveBtn.disabled = false
        return
      }
      status.innerHTML = '<span class="ok">Profile saved.</span>'
      avatar.textContent = initialsFrom(display_name || user.email || 'User')
      saveBtn.disabled = false
    }

    // Tiny confetti (no libraries)
    function fireConfetti(count=300){
      const colors = ['#5b7cff','#3049d1','#14b85a','#f59e0b','#ef4444']
      for (let i=0;i<count;i++){
        const s = document.createElement('span')
        s.style.position='fixed'
        s.style.left = Math.random()*100+'vw'
        s.style.top = '-10px'
        s.style.width=s.style.height= (6+Math.random()*6)+'px'
        s.style.background = colors[i%colors.length]
        s.style.opacity = .9
        s.style.transform = `rotate(${Math.random()*360}deg)`
        s.style.borderRadius = '2px'
        s.style.zIndex = 9999
        s.style.pointerEvents = 'none'
        document.body.appendChild(s)
        const dur = 1200 + Math.random()*1200
        const dx = (Math.random()*2-1)*200
        s.animate([
          { transform:`translate(0,0) rotate(0deg)`, opacity:1 },
          { transform:`translate(${dx}px, 100vh) rotate(720deg)`, opacity:.9 }
        ], { duration: dur, easing:'cubic-bezier(.2,.8,.2,1)'})
        setTimeout(()=>s.remove(), dur+50)
      }
    }

    // Wire + boot
    saveBtn.addEventListener('click', saveProfile)

    await populateTeams()
    await loadProfile()
    await loadNumbers()
  </script>
</body>
</html>
