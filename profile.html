<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Your Profile â€¢ Weekend Predictor</title>
  <link rel="stylesheet" href="brand.css?v=96" />

  <!-- Redirect if not logged in -->
  <script type="module">
    import { supabase } from './supabase-config.js';
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) {
      window.location.replace('login.html');
      throw new Error('Redirectingâ€¦');
    }
  </script>

  <style>
    .msg {
      margin-top: 10px;
      min-height: 1.1em;
      font-size: 0.9rem;
    }
    .ok { color: #22c55e; }
    .err { color: #ef4444; }
  </style>
</head>
<body class="bg-hero">
  <div class="page-shell">

    <!-- NAV -->
    <header class="top-nav">
      <div class="top-nav-left">
        <div class="nav-logo">
          <img src="assets/brand-logo.png" alt="Logo" />
        </div>
        <div class="nav-text-group">
          <div class="nav-title">Weekend Predictor</div>
          <div class="nav-subtitle">Your account & profile</div>
        </div>
      </div>

      <nav class="top-nav-links">
        <a href="index.html">Home</a>
        <a href="predict.html">Predict</a>
        <a href="leaderboard.html">Leaderboard</a>
        <a href="my-picks.html">My Picks</a>
        <a href="profile.html" class="active">Profile</a>
        <a href="admin.html" id="navAdmin" style="display:none">Admin</a>
        <a href="#" id="logoutBtn">Logout</a>
      </nav>
    </header>

    <!-- MAIN LAYOUT -->
    <main class="main-layout">

      <!-- LEFT PANEL -->
      <section class="panel panel-main">
        <div class="panel-inner">
          <h1>Your Profile</h1>
          <p class="muted">
            Update how you appear across the game. These details show on leaderboards and picks.
          </p>

          <div class="user-banner">
            Signed in as: <span id="userEmail"></span>
          </div>

          <form id="profileForm" class="form">
            <label class="form-label" for="displayName">Display name</label>
            <input
              id="displayName"
              class="input"
              type="text"
              placeholder="Your leaderboard name"
            />

            <label class="form-label" for="teamName">Team name (optional)</label>
            <input
              id="teamName"
              class="input"
              type="text"
              placeholder="E.g. The Predictors FC"
            />

            <label class="form-label" for="favClub">Favourite club</label>
            <input
              id="favClub"
              class="input"
              type="text"
              placeholder="Who do you support?"
            />

            <button class="btn-primary" type="submit">Save changes</button>
            <div id="msg" class="msg"></div>
          </form>

          <button id="logoutBtn2" class="btn-ghost" style="margin-top:16px;">
            Log out
          </button>
        </div>
      </section>

      <!-- RIGHT PANEL -->
      <aside class="panel panel-side">
        <div class="panel-inner">
          <h2>Why update your profile?</h2>
          <ul class="bullet-list">
            <li>Appear on the leaderboard with a proper name.</li>
            <li>Add a team name for fun rivalry.</li>
            <li>Your favourite club may be used in future features.</li>
          </ul>
        </div>
      </aside>

    </main>
  </div>

  <!-- PROFILE LOGIC -->
  <script type="module">
    import { supabase } from './supabase-config.js';

    const userEmailEl  = document.getElementById('userEmail');
    const displayName  = document.getElementById('displayName');
    const teamName     = document.getElementById('teamName');
    const favClub      = document.getElementById('favClub');
    const msg          = document.getElementById('msg');
    const navAdmin     = document.getElementById('navAdmin');

    const logoutBtn    = document.getElementById('logoutBtn');
    const logoutBtn2   = document.getElementById('logoutBtn2');

    // Logout (both buttons)
    [logoutBtn, logoutBtn2].forEach(btn => {
      btn?.addEventListener('click', async (e) => {
        e.preventDefault();
        try { await supabase.auth.signOut(); } catch {}
        window.location.replace('login.html');
      });
    });

    async function loadProfile() {
      const { data: { session } } = await supabase.auth.getSession();
      const user = session?.user;
      if (!user) {
        window.location.replace('login.html');
        return;
      }

      userEmailEl.textContent = user.email || '';

      // Check admin flag (optional)
      try {
        const { data: profileAdmin } = await supabase
          .from('profiles')
          .select('is_admin')
          .eq('id', user.id)
          .maybeSingle();

        if (profileAdmin?.is_admin) {
          navAdmin.style.display = '';
        }
      } catch {
        // ignore
      }

      // Load profile values
      try {
        const { data: profile, error } = await supabase
          .from('profiles')
          .select('display_name, team_name, favourite_club')
          .eq('id', user.id)
          .maybeSingle();

        if (error) {
          console.error('load profile error', error);
          msg.innerHTML = '<span class="err">Could not load profile.</span>';
          return;
        }

        if (profile) {
          displayName.value = profile.display_name || '';
          teamName.value    = profile.team_name || '';
          favClub.value     = profile.favourite_club || '';
        }
      } catch (e) {
        console.error(e);
        msg.innerHTML = '<span class="err">Could not load profile.</span>';
      }
    }

    async function saveProfile(e) {
      e.preventDefault();
      msg.textContent = 'Savingâ€¦';
      msg.className = 'msg';

      const { data: { session } } = await supabase.auth.getSession();
      const user = session?.user;
      if (!user) {
        window.location.replace('login.html');
        return;
      }

      try {
        // ðŸ”‘ Use UPDATE instead of UPSERT to avoid constraint issues
        const { error, data } = await supabase
          .from('profiles')
          .update({
            display_name: displayName.value.trim() || null,
            team_name:    teamName.value.trim() || null,
            favourite_club: favClub.value.trim() || null,
          })
          .eq('id', user.id)
          .select();

        // If no row updated, fall back to insert with id + email
        if (!error && (!data || data.length === 0)) {
          const { error: insErr } = await supabase
            .from('profiles')
            .insert({
              id: user.id,
              email: user.email,
              display_name: displayName.value.trim() || null,
              team_name:    teamName.value.trim() || null,
              favourite_club: favClub.value.trim() || null,
            });
          if (insErr) throw insErr;
        } else if (error) {
          throw error;
        }

        msg.innerHTML = '<span class="ok">Profile updated successfully.</span>';
      } catch (e) {
        console.error('save profile error', e);
        msg.innerHTML =
          '<span class="err">Could not save profile. ' +
          (e?.message ? e.message : '') +
          '</span>';
      }
    }

    document.getElementById('profileForm').addEventListener('submit', saveProfile);
    loadProfile();
  </script>
</body>
</html>
