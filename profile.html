<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Profile â€¢ Weekend Predictor</title>
  <link rel="stylesheet" href="brand.css" />
  <script defer src="supabase-config.js"></script>
  <script>
    let currentUser = null;

    async function loadProfile() {
      const { data: { session } } = await supabase.auth.getSession();
      currentUser = session?.user || null;

      if (!currentUser) {
        window.location.href = 'login.html';
        return;
      }

      document.getElementById('email').textContent = currentUser.email || '';

      const { data, error } = await supabase
        .from('profiles')
        .select('*')
        .eq('id', currentUser.id)
        .single();

      if (error && error.code !== 'PGRST116') {
        console.error(error);
      }

      if (data) {
        document.getElementById('display-name').value = data.display_name || '';
        document.getElementById('team-name').value = data.team_name || '';
        document.getElementById('favourite-club').value = data.favourite_club || '';
      }
    }

    async function saveProfile(e) {
      e.preventDefault();
      if (!currentUser) return;

      const displayName = document.getElementById('display-name').value.trim();
      const teamName = document.getElementById('team-name').value.trim();
      const favouriteClub = document.getElementById('favourite-club').value.trim();
      const message = document.getElementById('message');

      const { error } = await supabase.from('profiles').upsert({
        id: currentUser.id,
        display_name: displayName,
        team_name: teamName,
        favourite_club: favouriteClub,
      });

      if (error) {
        console.error(error);
        message.textContent = 'Error saving profile.';
      } else {
        message.textContent = 'Profile updated!';
      }
    }

    async function handleLogout() {
      await supabase.auth.signOut();
      window.location.href = 'index.html';
    }

    document.addEventListener('DOMContentLoaded', () => {
      loadProfile();
      document
        .getElementById('profile-form')
        .addEventListener('submit', saveProfile);
      document
        .getElementById('logout-button')
        .addEventListener('click', handleLogout);
    });
  </script>
</head>
<body>
  <div class="page-shell">
    <header class="top-nav">
      <div class="top-nav-left">
        <div class="nav-logo">
          <img src="assets/brand-logo.png" alt="Weekend Predictor logo" />
        </div>
        <div class="nav-text-group">
          <div class="nav-title">Weekend Predictor</div>
          <div class="nav-subtitle">Premier League prediction challenge</div>
        </div>
      </div>
      <nav class="top-nav-links">
        <a href="index.html">Home</a>
        <a href="predict.html">Predict</a>
        <a href="my-picks.html">My Picks</a>
        <a href="leaderboard.html">Leaderboard</a>
        <a href="admin.html">Admin</a>
      </nav>
    </header>

    <main class="main-layout">
      <section class="panel panel-main">
        <div class="panel-inner">
          <h1>Your profile</h1>
          <p class="muted">
            Update your display name and other details shown on the leaderboard.
          </p>

          <div class="user-banner">
            Signed in as: <span id="email"></span>
          </div>

          <form id="profile-form" class="form">
            <label class="form-label" for="display-name">Display name</label>
            <input id="display-name" class="input" type="text" placeholder="How you appear on the leaderboard" />

            <label class="form-label" for="team-name">Team name</label>
            <input id="team-name" class="input" type="text" placeholder="Optional fun team name" />

            <label class="form-label" for="favourite-club">Favourite club</label>
            <input id="favourite-club" class="input" type="text" placeholder="Who do you support?" />

            <button type="submit" class="btn-primary">Save profile</button>
            <p id="message" class="form-message"></p>
          </form>

          <button id="logout-button" class="btn-ghost" style="margin-top:16px;">
            Log out
          </button>
        </div>
      </section>

      <aside class="panel panel-side">
        <div class="panel-inner">
          <h2>Why it matters</h2>
          <p class="muted">
            Your display name will appear on the leaderboard and in any summary views.
          </p>
        </div>
      </aside>
    </main>
  </div>
</body>
</html>
