<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Your Profile • Weekend Predictor</title>
  <link rel="stylesheet" href="brand.css?v=81" />
  <style>
    .wrap{max-width:820px;margin:0 auto;padding:16px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;
          box-shadow:0 8px 20px rgba(0,0,0,.08);padding:16px;margin-bottom:16px}
    h1{margin:0 0 10px;color:#1f357a}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media (max-width:760px){ .row{grid-template-columns:1fr} }
    .field{display:flex;flex-direction:column;gap:6px}
    .field label{font-weight:700;color:#1f2937}
    .field input{
      height:44px;border:1px solid #cbd5e1;border-radius:10px;padding:0 12px;font-size:1rem
    }
    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .msg{margin-top:10px;font-weight:700}
    .ok{color:#16a34a}.err{color:#b91c1c}
    .preview{display:flex;align-items:center;gap:12px;margin-top:10px}
    .badge{width:48px;height:48px;border-radius:12px;background:#eef2ff;display:grid;place-items:center;font-weight:800;color:#1f357a}
  </style>

  <script type="module" src="supabase-config.js"></script>

  <!-- Early logout wiring -->
  <script type="module">
    import { supabase } from './supabase-config.js';
    document.addEventListener('DOMContentLoaded', ()=>{
      const navLogout = document.getElementById('navLogout');
      navLogout?.addEventListener('click', async (e)=>{
        e.preventDefault();
        try{ await supabase.auth.signOut(); }catch{}
        window.location.replace('login.html');
      });
    });
  </script>
</head>
<body>
  <header class="top">
    <div class="inner">
      <a class="logo" href="index.html">WP</a>
      <nav class="topnav">
        <a href="predict.html" data-nav="predict">Predict</a>
        <a href="leaderboard.html" data-nav="leaderboard">Leaderboard</a>
        <a href="profile.html" data-nav="profile" class="active">Profile</a>
        <a href="admin.html" id="navAdmin" style="display:none">Admin</a>
        <a class="logout" id="navLogout" href="login.html">Logout</a>
      </nav>
    </div>
  </header>

  <main class="wrap">
    <section class="card">
      <h1>Your profile</h1>

      <form id="form">
        <div class="row">
          <div class="field">
            <label for="name">Display name</label>
            <input id="name" type="text" placeholder="Your name" required />
          </div>
          <div class="field">
            <label for="team">Favourite team (optional)</label>
            <input id="team" type="text" placeholder="e.g., Arsenal" />
          </div>
        </div>

        <div class="preview">
          <div class="badge" id="badge">WP</div>
          <div>
            <div class="meta">Preview</div>
            <div id="badgeName" style="font-weight:800;color:#1f357a">—</div>
          </div>
        </div>

        <div class="actions">
          <button id="save" type="submit" class="btn primary">Save changes</button>
          <a class="btn" href="predict.html">Go to predictions</a>
        </div>
      </form>
      <div id="message" class="msg"></div>
    </section>
  </main>

  <script type="module">
    import { supabase } from './supabase-config.js';

    const nameEl = document.getElementById('name');
    const teamEl = document.getElementById('team');
    const badgeName = document.getElementById('badgeName');
    const saveBtn = document.getElementById('save');
    const msg = document.getElementById('message');

    function updatePreview(){ badgeName.textContent = nameEl.value || '—'; }

    // Prefill profile + show Admin link if applicable
    async function prefill(){
      const { data: { session } } = await supabase.auth.getSession();
      if (!session?.user){ window.location.replace('login.html'); return; }
      const uid = session.user.id;

      // Try to fetch favourite_team if present; otherwise only display_name
      let prof = null;
      try{
        const r = await supabase.from('profiles')
          .select('display_name, favourite_team, is_admin').eq('id', uid).maybeSingle();
        prof = r.data || null;
      }catch{
        const r2 = await supabase.from('profiles')
          .select('display_name, is_admin').eq('id', uid).maybeSingle();
        prof = r2.data || null;
      }

      if (prof){
        nameEl.value = prof.display_name || '';
        teamEl.value = prof.favourite_team || '';
        updatePreview();
        if (prof.is_admin) document.getElementById('navAdmin').style.display = '';
      }
    }

    document.getElementById('form').addEventListener('input', updatePreview);

    document.getElementById('form').addEventListener('submit', async (e)=>{
      e.preventDefault();
      saveBtn.disabled = true; msg.textContent = 'Saving…';
      try{
        const { data: { session } } = await supabase.auth.getSession();
        if (!session?.user) throw new Error('Not signed in');
        const uid = session.user.id;

        // Try to save both fields. If favourite_team column doesn't exist, retry with display_name only.
        let errorOut = null;
        try{
          const { error } = await supabase.from('profiles')
            .update({ display_name: nameEl.value.trim(), favourite_team: teamEl.value.trim() || null })
            .eq('id', uid);
          if (error) errorOut = error;
        }catch(err){ errorOut = err; }

        if (errorOut){
          // retry without favourite_team (compat for your current schema)
          const { error: err2 } = await supabase.from('profiles')
            .update({ display_name: nameEl.value.trim() })
            .eq('id', uid);
          if (err2) throw err2;
        }

        msg.innerHTML = '<span class="ok">Saved.</span>';
      }catch(err){
        console.error(err);
        msg.innerHTML = '<span class="err">Could not save.</span>';
      }finally{
        saveBtn.disabled = false;
      }
    });

    await prefill();
  </script>
</body>
</html>
