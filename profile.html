<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>My Profile</title>
  <link rel="stylesheet" href="brand.css?v=11" />
</head>
<body>
  <main class="landing">
    <!-- Logo -->
    <svg class="logo" viewBox="0 0 64 64" aria-hidden="true">
      <rect x="2" y="2" width="60" height="60" rx="12" fill="#1E824C"></rect>
      <circle cx="32" cy="32" r="16" fill="#FFF" stroke="#0E3E2A" stroke-width="3"></circle>
      <path d="M32 16 l6 6 -6 4 -6-4z M32 48 l6-6 -6-4 -6 4z M16 32 l6-6 4 6 -4 6z M48 32 l-6-6 -4 6 4 6z"
            fill="#0E3E2A"></path>
    </svg>

    <div class="card">
      <h2>My Profile</h2>
      <form id="profile-form">
        <label>
          Nickname:<br />
          <input type="text" id="nickname" required />
        </label>
        <br /><br />
        <label>
          Favourite Team:<br />
          <select id="team" required>
            <option value="">Select your team</option>
            <!-- Premier League (current) -->
            <option>Arsenal</option>
            <option>Aston Villa</option>
            <option>Bournemouth</option>
            <option>Brentford</option>
            <option>Brighton</option>
            <option>Chelsea</option>
            <option>Crystal Palace</option>
            <option>Everton</option>
            <option>Fulham</option>
            <option>Ipswich Town</option>
            <option>Leicester City</option>
            <option>Liverpool</option>
            <option>Manchester City</option>
            <option>Manchester United</option>
            <option>Newcastle United</option>
            <option>Nottingham Forest</option>
            <option>Southampton</option>
            <option>Tottenham Hotspur</option>
            <option>West Ham United</option>
            <option>Wolverhampton Wanderers</option>
          </select>
        </label>
        <br /><br />
        <button type="submit">Save Profile</button>
      </form>
      <button id="logout" style="margin-top:15px;background:#999;color:#fff;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;">
        Logout
      </button>
      <p id="status" style="margin-top:10px;font-size:.9rem;color:#1f357a;"></p>
    </div>
  </main>

  <script type="module" src="supabase-config.js"></script>
  <script type="module">
    import { supabase } from './supabase-config.js';

    const form = document.getElementById('profile-form');
    const nicknameEl = document.getElementById('nickname');
    const teamEl = document.getElementById('team');
    const statusEl = document.getElementById('status');
    const logoutBtn = document.getElementById('logout');

    // 1) Get session (Supabase auto-parses #access_token on first load)
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) {
      window.location.replace('login.html');
    }
    const user = session.user;

    // 2) Load profile (+ auto-redirects)
    async function loadProfile() {
      const { data, error } = await supabase
        .from('profiles')
        .select('display_name, favorite_team, is_admin')
        .eq('id', user.id)
        .single();

      if (error && error.code !== 'PGRST116') {
        console.error(error);
        statusEl.textContent = 'Error loading profile';
        return;
      }

      const display_name = data?.display_name ?? '';
      const favorite_team = data?.favorite_team ?? '';
      const is_admin = !!data?.is_admin;

      // Admins go straight to admin
      if (is_admin) {
        window.location.replace('admin.html');
        return;
      }

      // If profile exists & looks complete, go predict
      if (display_name && favorite_team) {
        window.location.replace('predict.html');
        return;
      }

      // Otherwise, fill the fields so user can complete and save
      nicknameEl.value = display_name;
      if ([...teamEl.options].some(o => o.value === favorite_team)) {
        teamEl.value = favorite_team;
      }
    }

    // 3) Save profile -> go to predict.html
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      statusEl.textContent = 'Saving...';

      const updates = {
        id: user.id,
        display_name: nicknameEl.value.trim(),
        favorite_team: teamEl.value
      };

      const { error } = await supabase
        .from('profiles')
        .upsert(updates, { onConflict: 'id' });

      if (error) {
        console.error(error);
        statusEl.textContent = 'Error saving profile';
      } else {
        window.location.replace('predict.html');
      }
    });

    // 4) Logout
    logoutBtn.addEventListener('click', async () => {
      await supabase.auth.signOut();
      window.location.replace('login.html');
    });

    loadProfile();
  </script>
</body>
  <!-- Mini top-right nav -->
<nav class="topnav">
  <a href="predict.html" data-nav="predict">Predict</a>
  <a href="my-picks.html" data-nav="mypicks">My Picks</a>
  <a href="leaderboard.html" data-nav="leaderboard">Leaderboard</a>
  <a href="profile.html" data-nav="profile">Profile</a>
  <a href="admin.html" id="navAdmin" data-nav="admin" style="display:none">Admin</a>
  <button class="logout" id="navLogout" title="Sign out">Logout</button>
</nav>

<script type="module">
  import { supabase } from './supabase-config.js';

  // Highlight the current page
  const path = location.pathname.toLowerCase();
  const markActive = (key) => {
    const el = document.querySelector(`.topnav [data-nav="${key}"]`);
    if (el) el.classList.add('active');
  };
  if (path.endsWith('/predict.html')) markActive('predict');
  else if (path.endsWith('/my-picks.html')) markActive('mypicks');
  else if (path.endsWith('/leaderboard.html')) markActive('leaderboard');
  else if (path.endsWith('/profile.html')) markActive('profile');
  else if (path.endsWith('/admin.html')) markActive('admin');

  // Show Admin link for admins
  try {
    const { data: { session } } = await supabase.auth.getSession();
    if (session) {
      const { data, error } = await supabase
        .from('profiles')
        .select('is_admin')
        .eq('id', session.user.id)
        .single();
      if (!error && data?.is_admin) {
        document.getElementById('navAdmin').style.display = '';
      }
    }
  } catch (e) {
    console.warn('Nav init warning:', e?.message || e);
  }

  // Logout
  document.getElementById('navLogout').addEventListener('click', async () => {
    await supabase.auth.signOut();
    location.replace('login.html');
  });
</script>

</html>
