<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Your Profile • Weekend Predictor</title>
  <link rel="stylesheet" href="brand.css?v=96" />
  <!-- Auth gate (standard) -->
  <script type="module">
    import { requireSession } from './app-auth.js';
    await requireSession();
  </script>
<style>
    .msg {
      margin-top: 10px;
      min-height: 1.1em;
      font-size: 0.9rem;
    }
    .ok { color: #22c55e; }
    .err { color: #ef4444; }
  </style>
</head>
<body class="bg-hero">
  <div class="page-shell">

    <!-- NAV -->
    <header class="top-nav">
      <div class="top-nav-left">
        <div class="nav-logo">
          <img src="assets/brand-logo.png" alt="Logo" />
        </div>
        <div class="nav-text-group">
          <div class="nav-title">Weekend Predictor</div>
          <div class="nav-subtitle">Your account & profile</div>
        </div>
      </div>

      <nav class="nav-links">
        <a href="index.html">Home</a>
        <a href="predict.html">Predict</a>
        <a href="leaderboard.html">Leaderboard</a>
        <a href="my-picks.html">My Picks</a>
        <a href="profile.html" class="active">Profile</a>
        <a href="admin.html" id="navAdmin" style="display:none">Admin</a>
        <a href="#" id="logoutBtn">Logout</a>
      </nav>
    </header>

    <!-- MAIN LAYOUT -->
    <main class="main-layout">

      <!-- LEFT PANEL -->
      <section class="panel panel-main">
        <div class="panel-inner">
          <h1>Your Profile</h1>
          <p class="muted">
            Update how you appear across the game. This name shows on leaderboards and picks.
          </p>

          <div class="user-banner">
            Signed in as: <span id="userEmail"></span>
          </div>

          <form id="profileForm" class="form">
            <label class="form-label" for="displayName">Display name</label>
            <input
              id="displayName"
              class="input"
              type="text"
              placeholder="Your leaderboard name"
            />
            <button class="btn-primary" type="submit">Save changes</button>
            <div id="msg" class="msg"></div>
          </form>

          <button id="logoutBtn2" class="btn-ghost" style="margin-top:16px;">
            Log out
          </button>
        </div>
      </section>

      <!-- RIGHT PANEL -->
      <aside class="panel panel-side">
        <div class="panel-inner">
          <h2>Why update your profile?</h2>
          <ul class="bullet-list">
            <li>Appear on the leaderboard with a proper name.</li>
            <li>Helps others recognise you in the game.</li>
          </ul>
        </div>
      </aside>
    </main>
  </div>

  <!-- PROFILE LOGIC -->
  <script type="module">
    import { supabase } from './supabase-config.js';

    const userEmailEl   = document.getElementById('userEmail');
    const displayNameEl = document.getElementById('displayName');
    const msg           = document.getElementById('msg');
    const navAdmin      = document.getElementById('navAdmin');
    const logoutBtn     = document.getElementById('logoutBtn');
    const logoutBtn2    = document.getElementById('logoutBtn2');

    [logoutBtn, logoutBtn2].forEach(btn => {
      btn?.addEventListener('click', async (e) => {
        e.preventDefault();
        try { await supabase.auth.signOut(); } catch {}
        window.location.replace('login.html');
      });
    });

    async function ensureProfileExists(user) {
      try {
        const { data, error } = await supabase
          .from('profiles')
          .select('id')
          .eq('id', user.id)
          .maybeSingle();

        if (error) {
          console.warn('ensureProfileExists select error', error);
          // if RLS blocks select, we still try insert and ignore conflict
        }

        if (!data) {
          await supabase
            .from('profiles')
            .insert({ id: user.id, display_name: null, is_admin: false });
        }
      } catch (e) {
        console.warn('ensureProfileExists insert error', e);
      }
    }

    async function loadProfile() {
      const { data: { session } } = await supabase.auth.getSession();
      const user = session?.user;
      if (!user) {
        window.location.replace('login.html');
        return;
      }

      userEmailEl.textContent = user.email || '';

      await ensureProfileExists(user);

      try {
        const { data: profileAdmin } = await supabase
          .from('profiles')
          .select('is_admin')
          .eq('id', user.id)
          .maybeSingle();
        if (profileAdmin?.is_admin) navAdmin.style.display = '';
      } catch {}

      try {
        const { data: profile, error } = await supabase
          .from('profiles')
          .select('display_name')
          .eq('id', user.id)
          .maybeSingle();

        if (error) {
          console.error('load profile error', error);
          msg.innerHTML = '<span class="err">Could not load profile.</span>';
          return;
        }

        if (profile) {
          displayNameEl.value = profile.display_name || '';
        }
      } catch (e) {
        console.error(e);
        msg.innerHTML = '<span class="err">Could not load profile.</span>';
      }
    }

    async function saveProfile(e) {
      e.preventDefault();
      msg.textContent = 'Saving…';
      msg.className = 'msg';

      const { data: { session } } = await supabase.auth.getSession();
      const user = session?.user;
      if (!user) {
        window.location.replace('login.html');
        return;
      }

      await ensureProfileExists(user);

      const nameVal = displayNameEl.value.trim() || null;

      try {
        const { error } = await supabase
          .from('profiles')
          .upsert(
            {
              id: user.id,
              display_name: nameVal,
            },
            { onConflict: 'id' }
          );

        if (error) throw error;
        msg.innerHTML = '<span class="ok">Profile updated successfully.</span>';
      } catch (e) {
        console.error('save profile error', e);
        msg.innerHTML =
          '<span class="err">Could not save profile. ' +
          (e?.message ? e.message : '') +
          '</span>';
      }
    }

    document.getElementById('profileForm').addEventListener('submit', saveProfile);
    loadProfile();
  </script>
</body>
</html>
