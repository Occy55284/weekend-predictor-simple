<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>My Profile â€¢ Weekend Predictor</title>
  <link rel="stylesheet" href="brand.css?v=96" />

  <!-- âœ… Early auth gate: redirect signed-out users before paint -->
  <script type="module">
    import { supabase } from './supabase-config.js'
    const { data: { session } } = await supabase.auth.getSession()
    if (!session) {
      window.location.replace('login.html')
      throw new Error('Redirecting to login')
    }
  </script>

  <style>
    .wrap{max-width:960px;margin:0 auto;padding:16px}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media (min-width:900px){ .grid{grid-template-columns:1fr 1fr} }

    .card{
      background:#fff;border:1px solid #e5e7eb;border-radius:16px;
      box-shadow:0 8px 20px rgba(0,0,0,.08);padding:16px;margin:16px 0
    }
    .card h2{margin:0 0 10px;color:#1f357a}

    .row{display:flex;flex-direction:column;gap:6px;margin:10px 0}
    label{font-weight:700;color:#0f172a}
    input[type="text"], input[type="email"], select{
      padding:10px 12px;border:1px solid #cbd5e1;border-radius:10px; font-size:16px; background:#fff
    }
    input[readonly]{background:#f8fafc;color:#64748b}

    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .btn{padding:10px 14px;border:1px solid #1f357a;background:#1f357a;color:#fff;border-radius:10px;font-weight:700;cursor:pointer}
    .btn.secondary{background:#fff;color:#1f357a}

    .status{margin-top:10px;font-weight:700}
    .ok{color:#16a34a}.err{color:#b91c1c}.muted{color:#64748b}

    .meta{color:#475569;font-size:.92rem;margin:6px 0 0}
    ul.kv{list-style:none;padding:0;margin:0}
    ul.kv li{display:flex;justify-content:space-between;border-bottom:1px dashed #e5e7eb;padding:8px 0}
    .k{color:#64748b}
    .v{font-weight:700}
  </style>
</head>
<body class="bg-hero">
  <header class="top">
    <div class="inner">
      <a class="logo" href="index.html">WP</a>
      <nav class="topnav">
        <a href="predict.html" data-nav="predict">Predict</a>
        <a href="leaderboard.html" data-nav="leaderboard">Leaderboard</a>
        <a href="profile.html" data-nav="profile" class="active">Profile</a>
        <a href="admin.html" id="navAdmin" style="display:none">Admin</a>
        <a class="logout" id="navLogout" href="login.html">Logout</a>
      </nav>
    </div>
  </header>

  <main class="wrap">
    <div class="grid">
      <!-- Profile editor -->
      <section class="card">
        <h2>My Profile</h2>
        <div class="meta" id="who">â€”</div>

        <div class="row">
          <label for="email">Email</label>
          <input id="email" type="email" readonly />
        </div>

        <div class="row">
          <label for="display_name">Display name</label>
          <input id="display_name" type="text" placeholder="Your name as shown on the leaderboard" />
        </div>

        <div class="row">
          <label for="team">Favourite team</label>
          <select id="team">
            <option value="">â€” Select a team â€”</option>
          </select>
        </div>

        <div class="actions">
          <button id="saveBtn" class="btn" type="button">Save changes</button>
          <button id="resetBtn" class="btn secondary" type="button">Reset</button>
        </div>
        <div id="status" class="status muted">Loading your profileâ€¦</div>
      </section>

      <!-- At-a-glance panel -->
      <section class="card">
        <h2>Account Overview</h2>
        <ul class="kv">
          <li><span class="k">User ID</span><span class="v" id="uid">â€”</span></li>
          <li><span class="k">Season points</span><span class="v" id="points">â€”</span></li>
          <li><span class="k">Season rank</span><span class="v" id="rank">â€”</span></li>
        </ul>
        <div class="meta">Tip: Your <strong>Display name</strong> and <strong>Team</strong> appear on the leaderboard.</div>
      </section>
    </div>
  </main>

  <!-- ðŸšª Logout wiring -->
  <script type="module">
    import { supabase } from './supabase-config.js'
    document.addEventListener('DOMContentLoaded', ()=>{
      const navLogout = document.getElementById('navLogout');
      navLogout?.addEventListener('click', async (e)=>{
        e.preventDefault();
        try { await supabase.auth.signOut(); } catch {}
        window.location.replace('login.html');
      });
    });
  </script>

  <!-- ðŸ§  Page logic -->
  <script type="module">
    import { supabase } from './supabase-config.js'

    // Elements
    const emailEl = document.getElementById('email')
    const nameEl  = document.getElementById('display_name')
    const teamEl  = document.getElementById('team')
    const whoEl   = document.getElementById('who')
    const status  = document.getElementById('status')
    const saveBtn = document.getElementById('saveBtn')
    const resetBtn= document.getElementById('resetBtn')

    const uidEl   = document.getElementById('uid')
    const ptsEl   = document.getElementById('points')
    const rankEl  = document.getElementById('rank')

    // Session (safe because of early gate)
    const { data: { session } } = await supabase.auth.getSession()
    const user = session.user

    // Show email/uid immediately
    emailEl.value = user.email || ''
    uidEl.textContent = user.id
    whoEl.textContent = `Signed in as ${user.email || 'â€”'}`

    // Show Admin link if applicable
    ;(async ()=>{
      try{
        const { data, error } = await supabase
          .from('profiles').select('is_admin').eq('id', user.id).single()
        if (!error && data?.is_admin) document.getElementById('navAdmin').style.display = ''
      }catch{}
    })();

    // Try to load teams from DB, fallback to a static list
    async function populateTeams() {
      let teams = []
      try {
        const { data, error } = await supabase
          .from('teams')
          .select('name')
          .order('name', { ascending: true })
        if (!error && data?.length) {
          teams = data.map(r => r.name).filter(Boolean)
        }
      } catch {}
      if (!teams.length) {
        teams = [
          'Arsenal','Aston Villa','Bournemouth','Brentford','Brighton',
          'Chelsea','Crystal Palace','Everton','Fulham','Ipswich',
          'Leicester','Liverpool','Man City','Man United','Newcastle',
          'Nottingham Forest','Southampton','Spurs','West Ham','Wolves'
        ]
      }
      // Fill the select
      const current = teamEl.value
      teamEl.innerHTML = '<option value="">â€” Select a team â€”</option>' +
        teams.map(t => `<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`).join('')
      if (current) teamEl.value = current
    }

    function escapeHtml(s='') {
      return String(s)
        .replaceAll('&','&amp;').replaceAll('<','&lt;')
        .replaceAll('>','&gt;').replaceAll('"','&quot;')
        .replaceAll("'",'&#39;')
    }

    async function loadProfile() {
      status.textContent = 'Loading your profileâ€¦'
      const { data, error } = await supabase
        .from('profiles')
        .select('display_name, team')
        .eq('id', user.id)
        .maybeSingle()

      if (error) {
        console.error(error)
        status.innerHTML = '<span class="err">Could not load profile.</span>'
        return
      }

      if (data) {
        nameEl.value = data.display_name ?? ''
        teamEl.value = data.team ?? ''
      } else {
        // no row yet â€” keep empty form
      }

      status.textContent = ''
    }

    async function loadOverview() {
      try {
        // Prefer an RPC if you have it
        const { data } = await supabase.rpc('season_progress', { uid: user.id })
        if (Array.isArray(data) && data.length) {
          ptsEl.textContent = data[0].points ?? 0
          rankEl.textContent = data[0].rank ?? 'â€”'
        } else if (data && typeof data === 'object') {
          ptsEl.textContent = data.points ?? 0
          rankEl.textContent = data.rank ?? 'â€”'
        } else {
          // Fallback: try a view called leaderboard for this user
          const { data: lb } = await supabase
            .from('leaderboard')
            .select('points, rank')
            .eq('user_id', user.id)
            .maybeSingle()
          ptsEl.textContent = lb?.points ?? 'â€”'
          rankEl.textContent = lb?.rank ?? 'â€”'
        }
      } catch {
        ptsEl.textContent = 'â€”'
        rankEl.textContent = 'â€”'
      }
    }

    async function saveProfile() {
      const display_name = nameEl.value.trim()
      const team = teamEl.value.trim()

      if (!display_name) {
        status.innerHTML = '<span class="err">Please enter a display name.</span>'
        return
      }

      saveBtn.disabled = true
      status.textContent = 'Savingâ€¦'

      const { error } = await supabase
        .from('profiles')
        .upsert(
          { id: user.id, display_name, team },
          { onConflict: 'id' }
        )

      if (error) {
        console.error(error)
        status.innerHTML = '<span class="err">Could not save your profile.</span>'
        saveBtn.disabled = false
        return
      }

      status.innerHTML = '<span class="ok">Profile saved.</span>'
      saveBtn.disabled = false
    }

    // Wire up
    saveBtn.addEventListener('click', saveProfile)
    resetBtn.addEventListener('click', loadProfile)

    // Boot
    await populateTeams()
    await loadProfile()
    await loadOverview()
  </script>
</body>
</html>
