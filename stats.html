<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Stats • Weekend Predictor</title>
  <link rel="stylesheet" href="brand.css" />
  <style>
    /* Force landscape-style layout: one full-width column (matches All Picks) */
    .main-layout { grid-template-columns: 1fr !important; }

    .table-wrap { overflow: auto; border-radius: 16px; border: 1px solid rgba(148,163,184,0.28); }
    table.stats { width: 100%; border-collapse: collapse; min-width: 980px; }
    .stats th, .stats td { padding: 10px; border-bottom: 1px solid rgba(148,163,184,0.18); text-align: center; }
    .stats thead th { position: sticky; top: 0; background: rgba(2,6,23,0.78); z-index: 2; }

    .stats td.name, .stats th.name { text-align: left; min-width: 260px; }
    .player-name { font-weight: 800; white-space: nowrap; }

    .status-line { margin: 10px 0 14px; color: #cbd5e1; }
    .week-title { margin: 0 0 8px; }

    .rank-badge {
      display:inline-flex; align-items:center; justify-content:center;
      width: 44px; height: 28px; border-radius: 999px;
      font-weight: 900; font-size: 0.8rem;
      border: 1px solid rgba(148,163,184,0.35);
      background: rgba(2,6,23,0.35);
      color: rgba(229,231,235,0.95);
      margin-right: 10px;
      flex: 0 0 auto;
    }
    .rank-1 { border-color: rgba(253,224,71,0.6); background: rgba(161,98,7,0.22); }
    .rank-2 { border-color: rgba(203,213,225,0.55); background: rgba(51,65,85,0.32); }
    .rank-3 { border-color: rgba(244,114,182,0.55); background: rgba(131,24,67,0.20); }

    /* Under-table info box styling (matches All Picks behaviour) */
    .panel-side { margin-top: 18px; }

    .kpi-row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin: 10px 0 14px;
    }
    .kpi {
      border-radius: 16px;
      border: 1px solid rgba(148,163,184,0.28);
      background: rgba(2,6,23,0.35);
      padding: 10px 12px;
      min-width: 190px;
    }
    .kpi .label { color: #9ca3af; font-size: 0.78rem; }
    .kpi .val { font-weight: 900; font-size: 1.05rem; }
  </style>
</head>
<body class="bg-hero">
  <div class="page-shell">
    <header class="top-nav">
      <div class="top-nav-left">
        <div class="nav-logo">
          <img src="assets/brand-logo.png" alt="Weekend Predictor logo" />
        </div>
        <nav class="nav-links">
          <a href="index.html">Home</a>
          <a href="predict.html">Predict</a>
          <a href="my-picks.html">My Picks</a>
          <a href="all-picks.html">All Picks</a>
          <a href="leaderboard.html">Leaderboard</a>
          <a class="active" href="stats.html">Stats</a>
          <a href="wallet.html">Wallet</a>
          <a href="profile.html">Profile</a>
          <a id="navAdmin" href="admin.html" style="display:none;">Admin</a>
          <a id="navLogout" href="#">Logout</a>
        </nav>
      </div>
      <div class="top-nav-right">
        <span class="muted">Current week stats</span>
      </div>
    </header>

    <main class="main-layout">
      <section class="panel">
        <div class="panel-inner">
          <h1 class="week-title">Stats</h1>
          <div id="weekRange" class="muted"></div>
          <div id="statusLine" class="status-line">Loading…</div>

          <div class="kpi-row" id="kpis" style="display:none;">
            <div class="kpi">
              <div class="label">Finished fixtures</div>
              <div class="val" id="kpiFinished">—</div>
            </div>
            <div class="kpi">
              <div class="label">Players shown</div>
              <div class="val" id="kpiPlayers">—</div>
            </div>
            <div class="kpi">
              <div class="label">Total predictions processed</div>
              <div class="val" id="kpiPreds">—</div>
            </div>
          </div>

          <div id="tableWrapper" class="table-wrap" style="display:none;">
            <table class="stats">
              <thead>
                <tr>
                  <th class="name">Player</th>
                  <th>Points</th>
                  <th>Exact</th>
                  <th>Correct</th>
                  <th>Total Picks</th>
                  <th>Accuracy</th>
                </tr>
              </thead>
              <tbody id="statsBody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <aside class="panel panel-side">
        <div class="panel-inner">
          <h2>How this page works</h2>
          <ul class="bullet-list">
            <li>This is the <strong>current week</strong> only (Mon–Sun).</li>
            <li>Points: <strong>5</strong> exact score, <strong>3</strong> correct result.</li>
            <li>Accuracy: correct results ÷ total predictions.</li>
            <li>AI Predictor is shown as a normal player.</li>
          </ul>
        </div>
      </aside>
    </main>
  </div>

  <script type="module">
    import { supabase } from './supabase-config.js';

    const navAdmin   = document.getElementById('navAdmin');
    const navLogout  = document.getElementById('navLogout');

    const weekRange  = document.getElementById('weekRange');
    const statusLine = document.getElementById('statusLine');

    const wrapper    = document.getElementById('tableWrapper');
    const bodyEl     = document.getElementById('statsBody');

    const kpisEl     = document.getElementById('kpis');
    const kpiFinished= document.getElementById('kpiFinished');
    const kpiPlayers = document.getElementById('kpiPlayers');
    const kpiPreds   = document.getElementById('kpiPreds');

    function escapeHtml(s) {
      return String(s ?? '').replace(/[&<>"']/g, c => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      }[c]));
    }

    function startOfWeek(d) {
      const x = new Date(d);
      x.setHours(0,0,0,0);
      const day = x.getDay(); // Sun=0
      const diff = day === 0 ? -6 : 1 - day; // Monday start
      x.setDate(x.getDate() + diff);
      return x;
    }

    function addDays(d, n) {
      const x = new Date(d);
      x.setDate(x.getDate() + n);
      return x;
    }

    function isoDate(d) {
      const x = new Date(d);
      x.setHours(0,0,0,0);
      return x.toISOString();
    }

    function outcome(h,a) {
      if (h>a) return 'H';
      if (h<a) return 'A';
      return 'D';
    }

    const weekStart = startOfWeek(new Date());
    const weekEnd = addDays(weekStart, 7); // exclusive
    weekRange.textContent =
      `${weekStart.toLocaleDateString()} – ${addDays(weekStart,6).toLocaleDateString()} (Mon–Sun)`;

    (async () => {
      const { data: { session } } = await supabase.auth.getSession();
      const user = session?.user;
      if (!user) {
        window.location.replace('login.html');
        return;
      }

      // admin
      try {
        const { data: prof } = await supabase
          .from('profiles')
          .select('is_admin')
          .eq('id', user.id)
          .maybeSingle();
        if (prof?.is_admin) navAdmin.style.display = '';
      } catch {}

      navLogout?.addEventListener('click', async (e)=>{
        e.preventDefault();
        try { await supabase.auth.signOut(); } catch {}
        window.location.replace('login.html');
      });

      await loadStats();
    })();

    async function loadStats() {
      statusLine.textContent = 'Loading current week finished fixtures…';
      wrapper.style.display = 'none';
      kpisEl.style.display = 'none';
      bodyEl.innerHTML = '';

      // 1) Load ALL players (so everyone appears even if they have no picks)
      const { data: profiles, error: pfErr } = await supabase
        .from('profiles')
        .select('id, display_name, is_ai')
        .order('display_name', { ascending: true });

      if (pfErr) {
        console.error(pfErr);
        statusLine.textContent = 'Could not load players.';
        return;
      }

      const players = (profiles || [])
        .map(p => ({
          id: p.id,
          name: p.display_name || 'Player',
          is_ai: !!p.is_ai
        }))
        .sort((a,b)=>{
          if (a.is_ai !== b.is_ai) return a.is_ai ? 1 : -1; // AI at end
          return a.name.localeCompare(b.name);
        });

      // 2) Finished fixtures in the current week window
      const { data: fixtures, error: fxErr } = await supabase
        .from('fixtures')
        .select('id, home_score, away_score, status, utc_date')
        .gte('utc_date', isoDate(weekStart))
        .lt('utc_date', isoDate(weekEnd))
        .eq('status', 'FINISHED')
        .not('home_score', 'is', null)
        .not('away_score', 'is', null);

      if (fxErr) {
        console.error(fxErr);
        statusLine.textContent = 'Could not load finished fixtures.';
        return;
      }

      const finishedCount = fixtures?.length || 0;
      if (!fixtures || fixtures.length === 0) {
        // Still show all players with zeros
        renderTable(players.map(p => ({
          ...p,
          points: 0, exact: 0, correct: 0, total: 0, accuracy: 0
        })));
        statusLine.textContent = 'No finished fixtures yet this week (showing zeros).';
        kpiFinished.textContent = '0';
        kpiPlayers.textContent = String(players.length);
        kpiPreds.textContent = '0';
        kpisEl.style.display = '';
        wrapper.style.display = '';
        return;
      }

      const fixtureIds = fixtures.map(f => f.id);
      const fxMap = new Map(fixtures.map(f => [f.id, f]));

      statusLine.textContent = 'Loading predictions for finished fixtures…';

      // 3) Predictions for finished fixtures (all users)
      const { data: preds, error: prErr } = await supabase
        .from('predictions')
        .select('user_id, fixture_id, home_goals, away_goals')
        .in('fixture_id', fixtureIds);

      if (prErr) {
        console.error(prErr);
        statusLine.textContent = 'Could not load predictions.';
        return;
      }

      // 4) Aggregate per user (initialize all players to 0)
      const statsByUser = new Map(players.map(p => [p.id, {
        user_id: p.id,
        points: 0,
        exact: 0,
        correct: 0,
        total: 0
      }]));

      let processedPreds = 0;

      for (const p of (preds || [])) {
        const fx = fxMap.get(p.fixture_id);
        if (!fx) continue;

        const ah = fx.home_score;
        const aa = fx.away_score;

        const ph = p.home_goals;
        const pa = p.away_goals;

        if (ph == null || pa == null) continue;

        processedPreds++;

        if (!statsByUser.has(p.user_id)) {
          // In case there are predictions from users who don't have a profile row yet
          statsByUser.set(p.user_id, { user_id: p.user_id, points: 0, exact: 0, correct: 0, total: 0 });
        }

        const s = statsByUser.get(p.user_id);
        s.total += 1;

        if (ph === ah && pa === aa) {
          s.points += 5;
          s.exact += 1;
          s.correct += 1;
        } else if (outcome(ph, pa) === outcome(ah, aa)) {
          s.points += 3;
          s.correct += 1;
        }
      }

      // 5) Build rows for table (ensure every profile is shown)
      const rows = players.map(pl => {
        const s = statsByUser.get(pl.id) || { points:0, exact:0, correct:0, total:0 };
        const acc = s.total ? (s.correct / s.total) * 100 : 0;
        return {
          ...pl,
          points: s.points,
          exact: s.exact,
          correct: s.correct,
          total: s.total,
          accuracy: acc
        };
      });

      // 6) Sort: AI at bottom, then points desc
      rows.sort((a,b)=>{
        if (a.is_ai !== b.is_ai) return a.is_ai ? 1 : -1;
        if (b.points !== a.points) return b.points - a.points;
        if (b.exact !== a.exact) return b.exact - a.exact;
        if (b.correct !== a.correct) return b.correct - a.correct;
        return a.name.localeCompare(b.name);
      });

      renderTable(rows);

      statusLine.textContent = `Loaded current week stats.`;
      kpiFinished.textContent = String(finishedCount);
      kpiPlayers.textContent = String(players.length);
      kpiPreds.textContent = String(processedPreds);
      kpisEl.style.display = '';
      wrapper.style.display = '';
    }

    function renderTable(rows) {
      bodyEl.innerHTML = '';

      rows.forEach((p, idx) => {
        const rank = idx + 1;
        const rankClass =
          rank === 1 ? 'rank-badge rank-1' :
          rank === 2 ? 'rank-badge rank-2' :
          rank === 3 ? 'rank-badge rank-3' :
          'rank-badge';

        const tr = document.createElement('tr');

        const tdName = document.createElement('td');
        tdName.className = 'name';
        tdName.innerHTML =
          `<span class="${rankClass}">#${rank}</span>` +
          `<span class="player-name">${escapeHtml(p.name)}${p.is_ai ? ' <span class="ai-badge ai-inline">AI</span>' : ''}</span>`;
        tr.appendChild(tdName);

        const tdPoints = document.createElement('td');
        tdPoints.textContent = String(p.points ?? 0);
        tr.appendChild(tdPoints);

        const tdExact = document.createElement('td');
        tdExact.textContent = String(p.exact ?? 0);
        tr.appendChild(tdExact);

        const tdCorrect = document.createElement('td');
        tdCorrect.textContent = String(p.correct ?? 0);
        tr.appendChild(tdCorrect);

        const tdTotal = document.createElement('td');
        tdTotal.textContent = String(p.total ?? 0);
        tr.appendChild(tdTotal);

        const tdAcc = document.createElement('td');
        tdAcc.textContent = `${Number(p.accuracy ?? 0).toFixed(1)}%`;
        tr.appendChild(tdAcc);

        bodyEl.appendChild(tr);
      });
    }
  </script>
</body>
</html>
