<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Weekend Predictor</title>
  <link rel="stylesheet" href="brand.css?v=70" />
  <style>
    /* landing hero layout from your new theme */
    :root{ --ink:#0f172a; --muted:#475569; --brand:#2643B3; --accent:#16a34a; }
    .hero{max-width:900px;margin:40px auto 0;padding:0 16px;text-align:center}
    .hero h1{font-weight:800;font-size:clamp(28px,4.6vw,48px);margin:0;color:#1f357a}
    .hero p{color:#475569;font-size:clamp(16px,2.4vw,18px);margin:10px 0 18px}
    .cta{display:inline-flex;gap:10px;align-items:center}
    .cta a{display:inline-block;background:linear-gradient(135deg,var(--brand),#1b3186);color:#fff;
      padding:14px 20px;border-radius:12px;font-weight:900;text-decoration:none;box-shadow:0 8px 20px rgba(38,67,179,.28)}
    .logo{display:block;margin:14px auto 18px;width:64px;height:64px}
  </style>
</head>
<body>
  <!-- Top nav kept minimal for landing -->
  <nav class="topnav">
    <a href="login.html" class="active">Get Started</a>
  </nav>

  <main class="landing">
    <!-- brand icon -->
    <svg class="logo" viewBox="0 0 64 64" aria-hidden="true">
      <rect x="2" y="2" width="60" height="60" rx="12" fill="#1E824C"></rect>
      <circle cx="32" cy="32" r="16" fill="#FFF" stroke="#0E3E2A" stroke-width="3"></circle>
      <path d="M32 16 l6 6 -6 4 -6-4z M32 48 l6-6 -6-4 -6 4z M16 32 l6-6 4 6 -4 6z M48 32 l-6-6 -4 6 4 6z" fill="#0E3E2A"></path>
    </svg>

    <section class="hero">
      <h1>Predict the weekend. Beat your friends.</h1>
      <p>Pick scores for the five featured fixtures. Lock in, watch the drama, and climb the leaderboard.</p>
      <div class="cta">
        <a href="login.html">Get started</a>
      </div>
    </section>
  </main>

  <script type="module" src="supabase-config.js"></script>
  <script type="module">
    import { supabase } from './supabase-config.js';

    async function routeAfterLogin(userId){
      try {
        const { data: prof } = await supabase
          .from('profiles')
          .select('display_name,is_admin')
          .eq('id', userId).maybeSingle();

        if (prof?.is_admin) { window.location.replace('admin.html'); return; }
        if (prof?.display_name) { window.location.replace('predict.html'); return; }
        window.location.replace('profile.html');
      } catch {
        window.location.replace('predict.html');
      }
    }

    async function handleAuthRedirectHere(){
      // New style ?code=
      const code = new URL(location.href).searchParams.get('code');
      if (code) {
        try {
          const { data, error } = await supabase.auth.exchangeCodeForSession(code);
          if (error) throw error;
          await routeAfterLogin(data.user.id);
          return;
        } catch (e) {
          console.error('index: exchangeCode error', e);
        }
      }
      // Legacy #access_token
      if (location.hash && location.hash.includes('access_token')) {
        const params = new URLSearchParams(location.hash.substring(1));
        const access_token = params.get('access_token');
        const refresh_token = params.get('refresh_token');
        if (access_token && refresh_token) {
          try {
            const { data, error } = await supabase.auth.setSession({ access_token, refresh_token });
            if (error) throw error;
            history.replaceState({}, document.title, location.pathname);
            await routeAfterLogin(data.user.id);
          } catch (e) {
            console.error('index: setSession error', e);
          }
        }
      }
    }

    // If a magic link drops us on Home, finish sign-in and route.
    handleAuthRedirectHere();

    // If already signed in and they hit Home, take them straight in.
    (async ()=>{
      const { data: { session } } = await supabase.auth.getSession();
      if (session?.user) routeAfterLogin(session.user.id);
    })();
  </script>
</body>
</html>
