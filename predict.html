<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Predict • Weekend Predictor</title>
  <link rel="stylesheet" href="brand.css" />
  <script defer src="supabase-config.js"></script>
  <script>
    let currentUser = null;

    async function checkAuth() {
      const { data: { session } } = await supabase.auth.getSession();
      currentUser = session?.user || null;

      if (!currentUser) {
        window.location.href = 'login.html';
        return;
      }

      document.getElementById('user-email').textContent =
        currentUser.email || 'Logged in';
      loadFixtures();
    }

    async function loadFixtures() {
      const container = document.getElementById('fixtures');
      container.innerHTML = '<p class="muted">Loading fixtures...</p>';

      const { data, error } = await supabase
        .from('fixtures')
        .select('*')
        .order('kickoff', { ascending: true });

      if (error) {
        console.error(error);
        container.innerHTML = '<p class="muted">Error loading fixtures.</p>';
        return;
      }

      if (!data || data.length === 0) {
        container.innerHTML = '<p class="muted">No fixtures found.</p>';
        return;
      }

      const { data: picks } = await supabase
        .from('picks')
        .select('*')
        .eq('user_id', currentUser.id);

      const picksMap = {};
      (picks || []).forEach(p => {
        picksMap[p.fixture_id] = p;
      });

      container.innerHTML = '';
      data.forEach(fix => {
        const pick = picksMap[fix.id] || {};
        const home = pick.home_goals ?? '';
        const away = pick.away_goals ?? '';

        const card = document.createElement('div');
        card.className = 'fixture-row';
        card.innerHTML = `
          <div class="fixture-main-info">
            <div class="fixture-teams">
              <div class="fixture-team">
                <span class="fixture-team-name">${fix.home_team}</span>
              </div>
              <span class="fixture-vs">vs</span>
              <div class="fixture-team">
                <span class="fixture-team-name">${fix.away_team}</span>
              </div>
            </div>
            <div class="fixture-meta">
              <span>${new Date(fix.kickoff).toLocaleString()}</span>
              <span class="fixture-venue">${fix.venue || ''}</span>
            </div>
          </div>
          <div class="fixture-inputs">
            <input
              type="number"
              min="0"
              max="9"
              class="score-input"
              value="${home}"
              data-fixture-id="${fix.id}"
              data-side="home"
            />
            <span class="fixture-dash">-</span>
            <input
              type="number"
              min="0"
              max="9"
              class="score-input"
              value="${away}"
              data-fixture-id="${fix.id}"
              data-side="away"
            />
          </div>
        `;
        container.appendChild(card);
      });
    }

    async function savePicks() {
      if (!currentUser) return;

      const inputs = document.querySelectorAll('.score-input');
      const updates = {};

      inputs.forEach(input => {
        const fixtureId = input.dataset.fixtureId;
        const side = input.dataset.side;
        const value = input.value !== '' ? parseInt(input.value, 10) : null;

        if (!updates[fixtureId]) {
          updates[fixtureId] = { home_goals: null, away_goals: null };
        }
        if (side === 'home') updates[fixtureId].home_goals = value;
        if (side === 'away') updates[fixtureId].away_goals = value;
      });

      const rows = Object.entries(updates)
        .filter(([, v]) => v.home_goals !== null && v.away_goals !== null)
        .map(([fixtureId, v]) => ({
          user_id: currentUser.id,
          fixture_id: parseInt(fixtureId, 10),
          home_goals: v.home_goals,
          away_goals: v.away_goals
        }));

      if (rows.length === 0) {
        alert('No complete predictions to save yet.');
        return;
      }

      const { error } = await supabase
        .from('picks')
        .upsert(rows, { onConflict: 'user_id,fixture_id' });

      if (error) {
        console.error(error);
        alert('Error saving predictions.');
      } else {
        alert('Predictions saved!');
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      checkAuth();
      document
        .getElementById('save-button')
        .addEventListener('click', savePicks);
    });
  </script>
</head>
<body>
  <div class="page-shell">
    <header class="top-nav">
      <div class="top-nav-left">
        <div class="nav-logo">
          <img src="assets/brand-logo.png" alt="Weekend Predictor logo" />
        </div>
        <div class="nav-text-group">
          <div class="nav-title">Weekend Predictor</div>
          <div class="nav-subtitle">Premier League prediction challenge</div>
        </div>
      </div>
      <nav class="top-nav-links">
        <a href="index.html">Home</a>
        <a href="leaderboard.html">Leaderboard</a>
        <a href="my-picks.html">My Picks</a>
        <a href="profile.html">Profile</a>
        <a href="admin.html">Admin</a>
      </nav>
    </header>

    <main class="main-layout">
      <section class="panel panel-main">
        <div class="panel-inner">
          <h1>Make your predictions</h1>
          <p class="muted">
            Enter your score predictions for each fixture. You can come back
            and update them until kick-off.
          </p>

          <div class="user-banner">
            Signed in as: <span id="user-email"></span>
          </div>

          <div id="fixtures" class="fixtures-list"></div>

          <button id="save-button" class="btn-primary">
            Save predictions
          </button>
        </div>
      </section>

      <aside class="panel panel-side">
        <div class="panel-inner">
          <h2>Scoring overview</h2>
          <ul class="muted bullet-list">
            <li>Exact score: high points.</li>
            <li>Correct result (win/draw/loss): smaller points.</li>
            <li>Missed completely: zero.</li>
          </ul>

          <div class="info-card">
            <div class="info-label">Tip</div>
            <p class="info-text">
              Don’t forget to hit “Save predictions” after updating your scores.
            </p>
          </div>
        </div>
      </aside>
    </main>
  </div>
</body>
</html>
