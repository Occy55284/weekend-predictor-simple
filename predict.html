<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Make Predictions ¬∑ Occy Weekend Football</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
  <link rel="stylesheet" href="brand.css" />
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Make Predictions</h1>
      <p class="muted">Only upcoming, featured fixtures are shown. Games lock at kickoff.</p>
    </div>

    <!-- Profile Required Gate -->
    <div id="gate" class="card" style="display:none">
      <div class="error" style="display:block">
        You need to complete your profile before predicting.
        <ul style="margin:8px 0 0 18px; color:var(--muted-ink);">
          <li>Set a <b>display name</b></li>
          <li>Pick your <b>favourite team</b></li>
        </ul>
      </div>
      <div class="btn-row" style="margin-top:10px">
        <a class="btn" href="profile.html">Go to My Profile</a>
        <a class="btn btn-dark" href="index.html">‚Üê Home</a>
      </div>
      <p class="muted" style="margin-top:8px">Once saved, come back here to make your picks.</p>
    </div>

    <!-- Prediction UI -->
    <div id="app" class="card" style="display:none">
      <p class="muted" id="who">‚Äî</p>

      <table>
        <thead>
          <tr>
            <th class="left">Fixture</th>
            <th>Kickoff</th>
            <th>Your Pick</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>

      <div class="btn-row" style="margin-top:10px">
        <button id="saveAll" class="btn">Save all to cloud</button>
        <button id="clearLocal" class="btn btn-dark">Clear my device</button>
        <a id="homeBtn" class="btn btn-dark" href="index.html">‚Üê Home</a>
      </div>
      <div id="ok" class="ok" style="margin-top:10px;">Saved!</div>
      <p id="msg" class="muted" style="margin-top:8px;"></p>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase-config.js"></script>
  <script>
    const client = supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);

    const gate = document.getElementById('gate');
    const app  = document.getElementById('app');
    const who  = document.getElementById('who');
    const rows = document.getElementById('rows');
    const msg  = document.getElementById('msg');
    const okEl = document.getElementById('ok');

    document.getElementById('clearLocal').onclick = ()=> { localStorage.removeItem('localPicks'); location.reload(); };

    function nowUtcMs(){ return Date.now(); }
    function getLocalPicks(){ try{ return JSON.parse(localStorage.getItem('localPicks')||'{}'); }catch{ return {}; } }
    function setLocalPicks(obj){ localStorage.setItem('localPicks', JSON.stringify(obj)); }
    function isLocked(utcISO){ return nowUtcMs() >= new Date(utcISO).getTime(); }

    function pickRow(fix, pick){
      const locked = isLocked(fix.utc_date);
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td class="left">${fix.home_team} vs ${fix.away_team}</td>
        <td>${new Date(fix.utc_date).toLocaleString(undefined,{weekday:'short',month:'short',day:'2-digit',hour:'2-digit',minute:'2-digit'})}</td>
        <td>
          <input type="number" min="0" id="h_${fix.id}" value="${pick?.home_goals??''}" ${locked?'disabled':''} />
          -
          <input type="number" min="0" id="a_${fix.id}" value="${pick?.away_goals??''}" ${locked?'disabled':''} />
        </td>
        <td>${locked?'<span class="pill lock">Locked üîí</span>':'Open'}</td>
      `;
      return tr;
    }

    async function ensureProfile(id, email){
      const { data: prof } = await client.from('profiles').select('id').eq('id', id).maybeSingle();
      if (!prof){
        await client.from('profiles').insert({ id, display_name: (email||'').split('@')[0] || 'User' });
      }
    }

    async function profileComplete(id){
      const { data, error } = await client.from('profiles').select('display_name,favorite_team').eq('id', id).single();
      if (error) return false;
      return !!(data?.display_name && data?.favorite_team);
    }

    async function load(){
      const { data: ur } = await client.auth.getUser();
      const u = ur?.user;
      if (!u){ location.replace('login.html'); return; }

      who.textContent = `Signed in as ${u.email}`;
      await ensureProfile(u.id, u.email);

      const ok = await profileComplete(u.id);
      if (!ok){ gate.style.display='block'; app.style.display='none'; return; }

      gate.style.display='none'; app.style.display='block';

      // Featured & upcoming only
      const nowIso = new Date().toISOString();
      const { data: fixes, error } = await client
        .from('fixtures')
        .select('id,home_team,away_team,utc_date,featured')
        .eq('featured', true)
        .gt('utc_date', nowIso)
        .order('utc_date');
      if (error){ msg.textContent = 'Error loading fixtures: ' + error.message; return; }

      rows.innerHTML = '';
      const picks = getLocalPicks();
      (fixes||[]).forEach(f=>{
        const p = picks[f.id] || null;
        const tr = pickRow(f, p);
        rows.appendChild(tr);
        const h = tr.querySelector('#h_'+f.id);
        const a = tr.querySelector('#a_'+f.id);
        if (h) h.addEventListener('input', ()=>{
          picks[f.id] = picks[f.id] || {};
          picks[f.id].home_goals = h.value===''? null : +h.value;
          setLocalPicks(picks);
        });
        if (a) a.addEventListener('input', ()=>{
          picks[f.id] = picks[f.id] || {};
          picks[f.id].away_goals = a.value===''? null : +a.value;
          setLocalPicks(picks);
        });
      });

      msg.textContent = (!fixes || fixes.length===0) ? 'No upcoming featured fixtures yet.' : `Loaded ${fixes.length} fixtures.`;

      document.getElementById('saveAll').onclick = async ()=>{
        okEl.style.display = 'none';
        msg.textContent = 'Saving‚Ä¶';
        const payload = [];
        (fixes||[]).forEach(f=>{
          if (isLocked(f.utc_date)) return;
          const p = picks[f.id];
          if (p && Number.isInteger(p.home_goals) && Number.isInteger(p.away_goals)){
            payload.push({ fixture_id:f.id, user_id:u.id, home_goals:p.home_goals, away_goals:p.away_goals });
          }
        });
        if (!payload.length){ msg.textContent='Nothing to save. Enter scores for open fixtures.'; return; }
        const { error: e1 } = await client.from('predictions').upsert(payload, { onConflict:'user_id,fixture_id' });
        if (e1){ msg.textContent = 'Save error: ' + e1.message; return; }
        okEl.style.display='block'; msg.textContent='Saved to cloud.';
      };
    }

    load();
  </script>
</body>
</html>


