<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Make Predictions • Weekend Predictor</title>
  <link rel="stylesheet" href="brand.css?v=80" />
  <style>
    .wrap{max-width:960px;margin:0 auto;padding:16px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;
          box-shadow:0 8px 20px rgba(0,0,0,.08);padding:16px;margin-bottom:16px}
    .card h2{margin:0 0 10px;color:#1f357a}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid #e5e7eb;text-align:left}
    th{background:#f8fafc;text-transform:uppercase;font-size:.85rem;letter-spacing:.03em}
    input[type="number"]{width:48px;padding:4px 6px;border:1px solid #cbd5e1;border-radius:6px;text-align:center}
    .btn{background:#28428f;color:#fff;border:none;padding:10px 16px;border-radius:10px;
         font-weight:700;cursor:pointer;box-shadow:0 4px 10px rgba(38,67,179,.28)}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .msg{margin-top:8px;font-size:.95rem}
    .ok{color:#166534} .err{color:#b91c1c}
    .actions{margin-top:12px;display:flex;gap:10px;justify-content:flex-end}
  </style>
</head>
<body>
  <!-- Top nav -->
  <nav class="topnav">
    <a href="predict.html" class="active" data-nav="predict">Predict</a>
    <a href="my-picks.html" data-nav="mypicks">My Picks</a>
    <a href="leaderboard.html" data-nav="leaderboard">Leaderboard</a>
    <a href="profile.html" data-nav="profile">Profile</a>
    <a href="admin.html" data-nav="admin">Admin</a>
    <button class="logout" id="navLogout">Logout</button>
  </nav>

  <main class="wrap">
    <section class="card">
      <h2>This Week’s Predictions</h2>
      <div id="weekLabel" class="meta">—</div>
      <table>
        <thead>
          <tr>
            <th>Fixture</th>
            <th>Date</th>
            <th>Your Pick</th>
          </tr>
        </thead>
        <tbody id="fixturesBody">
          <tr><td colspan="3" class="muted">Loading fixtures…</td></tr>
        </tbody>
      </table>
      <div class="actions">
        <button id="saveBtn" class="btn">Save Picks</button>
        <button id="lockBtn" class="btn">Lock My Picks</button>
      </div>
      <div id="message" class="msg"></div>
    </section>
  </main>

  <script type="module" src="supabase-config.js"></script>
  <script type="module">
    import { supabase } from './supabase-config.js';

    const fixturesBody = document.getElementById('fixturesBody');
    const saveBtn = document.getElementById('saveBtn');
    const lockBtn = document.getElementById('lockBtn');
    const msg = document.getElementById('message');
    const weekLabel = document.getElementById('weekLabel');

    // --- Auth + logout ---
    const { data: { session } } = await supabase.auth.getSession();
    if (!session?.user) { window.location.replace('login.html'); throw new Error('No session'); }
    const user = session.user;

    const navLogout = document.getElementById('navLogout');
    if (navLogout) {
      navLogout.addEventListener('click', async () => {
        await supabase.auth.signOut();
        window.location.replace('login.html');
      });
    }

    // block admins from predicting
    {
      const { data: prof } = await supabase.from('profiles').select('is_admin').eq('id', user.id).maybeSingle();
      if (prof?.is_admin) {
        document.querySelector('main').innerHTML = `
          <section class="card">
            <h2>Admin cannot make predictions</h2>
            <p>Use the Admin page instead.</p>
          </section>`;
        throw new Error('Admin blocked from predict page');
      }
    }

    // --- Week window ---
    function startOfWeek(d=new Date()){
      const x=new Date(d); const day=x.getUTCDay(); // 0=Sun, 1=Mon
      const diff=x.getUTCDate()-day+(day===0?-6:1);
      x.setUTCHours(0,0,0,0);
      return new Date(Date.UTC(x.getUTCFullYear(), x.getUTCMonth(), diff));
    }
    function isoDate(d){ return d.toISOString().slice(0,10); }
    const weekStart = startOfWeek();
    const weekEnd = new Date(weekStart); weekEnd.setUTCDate(weekStart.getUTCDate()+7);
    weekLabel.textContent = `${weekStart.toUTCString().slice(0,16)} — ${new Date(weekEnd-1).toUTCString().slice(0,16)}`;

    // --- Load fixtures ---
    let fixtures = [];
    async function loadFixtures(){
      const { data, error } = await supabase
        .from('fixtures')
        .select('id,home_team,away_team,utc_date,home_score,away_score,status,featured')
        .gte('utc_date', isoDate(weekStart))
        .lt('utc_date', isoDate(weekEnd))
        .eq('featured', true)
        .order('utc_date',{ascending:true});
      if (error){ fixturesBody.innerHTML=`<tr><td colspan="3">Error loading fixtures.</td></tr>`; return; }
      fixtures = data||[];
      if (!fixtures.length){ fixturesBody.innerHTML=`<tr><td colspan="3">No featured fixtures selected by admin.</td></tr>`; return; }
      render();
      await loadPredictions();
    }

    function render(){
      fixturesBody.innerHTML='';
      for (const f of fixtures){
        const tr=document.createElement('tr');
        const dt=new Date(f.utc_date);
        const datestr=dt.toISOString().slice(0,16).replace('T',' ');
        tr.innerHTML=`
          <td>${f.home_team} vs ${f.away_team}</td>
          <td>${datestr} UTC</td>
          <td>
            <input type="number" min="0" id="h${f.id}" style="width:40px"> –
            <input type="number" min="0" id="a${f.id}" style="width:40px">
          </td>`;
        fixturesBody.appendChild(tr);
      }
    }

    // --- Load existing picks ---
    async function loadPredictions(){
      const ids=fixtures.map(f=>f.id);
      if (!ids.length) return;
      const { data, error } = await supabase
        .from('predictions')
        .select('fixture_id,home_goals,away_goals')
        .eq('user_id', user.id)
        .in('fixture_id', ids);
      if (error) return;
      (data||[]).forEach(p=>{
        const h=document.getElementById('h'+p.fixture_id);
        const a=document.getElementById('a'+p.fixture_id);
        if (h) h.value=p.home_goals;
        if (a) a.value=p.away_goals;
      });
    }

    // --- Save picks ---
    saveBtn.addEventListener('click', async ()=>{
      msg.textContent='Saving…';
      const rows=[];
      for (const f of fixtures){
        const h=document.getElementById('h'+f.id).value;
        const a=document.getElementById('a'+f.id).value;
        if (h!=='' && a!==''){
          rows.push({ user_id:user.id, fixture_id:f.id, home_goals:+h, away_goals:+a });
        }
      }
      if (!rows.length){ msg.innerHTML='<span class="err">Enter at least one score.</span>'; return; }
      const { error } = await supabase.from('predictions').upsert(rows,{onConflict:'user_id,fixture_id'});
      if (error){ msg.innerHTML='<span class="err">Error saving picks.</span>'; return; }
      msg.innerHTML='<span class="ok">Picks saved.</span>';
    });

    // --- Lock personal picks ---
    lockBtn.addEventListener('click', async ()=>{
      try {
        const { error } = await supabase.from('week_locks')
          .upsert({ user_id:user.id, week_start:isoDate(weekStart) }, { onConflict:'user_id,week_start' });
        if (error) throw error;
        msg.innerHTML='<span class="ok">Your picks are locked for this week.</span>';
        saveBtn.disabled=true; lockBtn.disabled=true;
      } catch(e){
        console.error(e);
        msg.innerHTML='<span class="err">Could not lock picks.</span>';
      }
    });

    loadFixtures();
  </script>
</body>
</html>
