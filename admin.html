<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin • Weekend Predictor</title>
  <link rel="stylesheet" href="brand.css?v=96" />
  
  <!-- Auth gate (standard) -->
  <script type="module">
    import { requireSession } from './app-auth.js';
    await requireSession();
  </script>
<style>
    .admin-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      margin-bottom:16px;
    }
    .admin-week{
      font-size:0.9rem;
    }
    .admin-actions{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      justify-content:flex-end;
    }
    .admin-count{
      font-size:0.9rem;
      color:#e5e7eb;
    }
    .admin-grid{
      display:grid;
      grid-template-columns:minmax(0,1.5fr) minmax(0,1fr);
      gap:16px;
      margin-top:8px;
    }
    .admin-card{
      border-radius:14px;
      border:1px solid rgba(148,163,184,0.45);
      background:rgba(15,23,42,0.96);
      padding:12px 14px;
    }
    .admin-card h2{
      margin-top:0;
      margin-bottom:6px;
      font-size:1rem;
    }
    .admin-card p{
      margin:0 0 6px;
    }
    .list{
      margin:8px 0 0;
      padding-left:18px;
    }
    .list .small{
      font-size:0.85rem;
      color:#e5e7eb;
      margin-bottom:3px;
    }
    .admin-error{
      border-color:rgba(248,113,113,0.7);
      background:rgba(30,7,7,0.9);
      margin-top:16px;
    }
    .admin-error h3{
      margin:0 0 4px;
      font-size:0.95rem;
      color:#fecaca;
    }
    .admin-error pre{
      margin:0;
      font-size:0.8rem;
      color:#fecaca;
      white-space:pre-wrap;
    }
    @media (max-width:840px){
      .admin-grid{
        grid-template-columns:minmax(0,1fr);
      }
    }
  </style>
</head>
<body class="bg-hero">
  <div class="page-shell">
    <header class="top-nav">
      <div class="top-nav-left">
        <div class="nav-logo">
          <img src="assets/brand-logo.png" alt="Weekend Predictor logo" />
        </div>
        <div class="nav-text-group">
          <div class="nav-title">Weekend Predictor</div>
          <div class="nav-subtitle">Admin dashboard</div>
        </div>
      </div>
      <nav class="nav-links">
        <a href="index.html">Home</a>
        <a href="predict.html">Predict</a>
        <a href="leaderboard.html">Leaderboard</a>
        <a href="my-picks.html">My Picks</a>
        <a href="all-picks.html">All Picks</a>
        <a href="stats.html">Stats</a>
        <a href="wallet.html">Wallet</a>
        <a href="profile.html">Profile</a>
        <a href="admin.html" class="active">Admin</a>
        <a href="#" id="navLogout">Logout</a>
      </nav>
    </header>

    <main class="main-layout">
      <section class="panel panel-main wide">
        <div class="panel-inner">
          <div class="admin-header">
            <div>
              <h1>Admin dashboard</h1>
              <p class="muted admin-week">
                Week window:
                <span id="weekLabel">Loading…</span>
                <span style="margin-left:10px; opacity:.85;">View:</span>
                <select id="weekSelect" aria-label="Select week" style="margin-left:6px; padding:6px 10px; border-radius:10px; background:rgba(255,255,255,.06); color:#f9fafb; border:1px solid rgba(255,255,255,.14);">
                  <option value="-1">Previous</option>
                  <option value="0" selected>This</option>
                  <option value="1">Next</option>
                </select>
              </p>
            </div>
            <div class="admin-actions">
              <div class="admin-count">
                Featured this week:
                <strong><span id="selectedCount">0</span>/5</strong>
              </div>
              <button id="saveFeaturedBtn" class="btn-ghost" type="button">
                Save featured
              </button>
              <button id="lockBtn" class="btn-primary" type="button">
                Lock week
              </button>
              <span id="saveStatus" class="muted" style="font-size:0.8rem;"></span>
              <span id="lockNote" class="muted" style="font-size:0.8rem; margin-left:8px;"></span>
            </div>
          </div>

          <div class="admin-grid">
            <section class="admin-card">
              <h2>Pick this week&apos;s fixtures</h2>
              <p class="muted">
                Select exactly five fixtures below to feature in this week&apos;s game.
              </p>
              <div class="table-wrapper" style="margin-top:10px;">
                <table class="table">
                  <thead>
                    <tr>
                      <th>Use</th>
                      <th>Date (UTC)</th>
                      <th>Fixture</th>
                      <th>Status / Result</th>
                    </tr>
                  </thead>
                  <tbody id="fixturesBody">
                    <tr>
                      <td colspan="4" class="muted">Loading fixtures…</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </section>

            <section class="admin-card">
              <h2>Who has submitted picks</h2>
              <p id="subsMeta" class="muted">Loading…</p>
              <ul id="listPicked" class="list"></ul>
            </section>
          </div>

          <section id="errorBox" class="admin-card admin-error" style="display:none;">
            <h3>Errors</h3>
            <pre id="errorText"></pre>
          </section>
        </div>
      </section>
    </main>
  </div>

  <script type="module">
    import { supabase } from './supabase-config.js';

    import { startOfWeekMonday, addDays, isoDate, formatWeekRange } from './app-week.js';

import { getGlobalLock, setGlobalLock } from './app-locks.js';
    // ---------- Utilities ----------
    const $ = (id) => document.getElementById(id);
    const fixturesBody = $('fixturesBody');
    const saveBtn = $('saveFeaturedBtn');
    const saveStatus = $('saveStatus');
    const selectedCountEl = $('selectedCount');
    const listPicked = $('listPicked');
    const subsMeta = $('subsMeta');
    const lockBtn = $('lockBtn');
    const weekLabel = $('weekLabel');
    const weekSelect = $('weekSelect');

    const errorBox = $('errorBox');
    const errorText = $('errorText');

    function showError(e){
      console.error(e);
      errorText.textContent = String(e?.message || e);
      errorBox.style.display = 'block';
    }

    function updateSelectedCounter(){
      const n = document.querySelectorAll('.feat:checked').length;
      selectedCountEl.textContent = n;
      saveBtn.disabled = (n !== 5);
    }

    // ---------- Week selection ----------
    const baseWeekStartDate = startOfWeekMonday(new Date()); // local Monday
    let weekOffset = 0; // -1 previous, 0 this, 1 next

    function getWeekStartDate(){
      return addDays(baseWeekStartDate, weekOffset * 7);
    }

    function getWeekStartISO(){
      return isoDate(getWeekStartDate());
    }

    function getWeekEndISO(){
      return isoDate(addDays(getWeekStartDate(), 7)); // exclusive end
    }

    function setWeekWindowLabel(){
      const ws = getWeekStartISO();
      const which = weekOffset === 0 ? 'This' : (weekOffset < 0 ? 'Previous' : 'Next');
      weekLabel.textContent = `${which} week • ${formatWeekRange(ws)} (Start: ${ws})`;
    }


    async function refreshLockUI(){
      try{
        const ws = getWeekStartISO();
        const g = await getGlobalLock(supabase, ws);

        const locked = !!g.locked;

        // Disable actions when admin has locked the week
        document.querySelectorAll('.feat').forEach(cb => cb.disabled = locked);
        saveBtn.disabled = locked || (document.querySelectorAll('.feat:checked').length !== 5);
        lockBtn.disabled = locked; // cannot lock again

        // Visual hint
        lockBtn.textContent = locked ? 'Week locked' : 'Lock week';
        lockBtn.classList.toggle('btn-disabled', locked);

        const noteEl = document.getElementById('lockNote');
        if (noteEl){
          noteEl.textContent = locked
            ? `Locked${g.locked_at ? ` on ${new Date(g.locked_at).toLocaleString()}` : ''}.`
            : 'Open for changes.';
          noteEl.className = locked ? 'muted' : 'muted';
        }
      }catch(e){
        console.error('refreshLockUI error', e);
      }
    }

    // ---------- Data ----------
    let fixtures = [];

    async function secureSession(){
      const { data: { session } } = await supabase.auth.getSession();
      if (!session?.user) {
        window.location.replace('login.html');
        throw new Error('No session');
      }

      // logout button
      document.getElementById('navLogout').onclick = async () => {
        await supabase.auth.signOut();
        window.location.replace('login.html');
      };

      // require admin
      const { data, error } = await supabase
        .from('profiles')
        .select('is_admin')
        .eq('id', session.user.id)
        .maybeSingle();
      if (error) throw error;
      if (!data?.is_admin) {
        window.location.replace('predict.html');
        throw new Error('Admins only');
      }
      return session.user;
    }

    async function loadFixtures(){
      fixturesBody.innerHTML = '<tr><td colspan="4" class="muted">Loading fixtures…</td></tr>';
      const weekStartISO = getWeekStartISO();
      const weekEndISO = getWeekEndISO();

      const { data, error } = await supabase
        .from('fixtures')
        .select('id,home_team,away_team,utc_date,home_score,away_score,status,featured')
        .gte('utc_date', weekStartISO)
        .lt('utc_date', weekEndISO)
        .order('utc_date', { ascending: true });

      if (error) {
        fixturesBody.innerHTML = '<tr><td colspan="4" class="muted">Error loading fixtures.</td></tr>';
        throw error;
      }

      fixtures = data || [];
      if (!fixtures.length) {
        fixturesBody.innerHTML = '<tr><td colspan="4" class="muted">No fixtures in this week window.</td></tr>';
        updateSelectedCounter();
        return;
      }

      fixturesBody.innerHTML = '';
      for (const f of fixtures){
        const dt = new Date(f.utc_date);
        const datestr = dt.toISOString().replace('T',' ').slice(0,16) + ' UTC';
        const res = (f.home_score ?? null) !== null && (f.away_score ?? null) !== null
          ? `${f.home_score}–${f.away_score}`
          : (f.status || '—');

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><input type="checkbox" class="feat" data-id="${f.id}" ${f.featured ? 'checked' : ''} /></td>
          <td>${datestr}</td>
          <td>${f.home_team || '?'} vs ${f.away_team || '?'}</td>
          <td class="muted">${res}</td>
        `;
        fixturesBody.appendChild(tr);
      }

      document.querySelectorAll('.feat').forEach(cb => cb.addEventListener('change', updateSelectedCounter));
      updateSelectedCounter();
    }

    async function saveFeatured(){
      const checks = Array.from(document.querySelectorAll('.feat'));
      const picked = checks.filter(c => c.checked).map(c => c.dataset.id);
      if (picked.length !== 5){
        alert('Please select exactly 5 fixtures.');
        return;
      }

      saveBtn.disabled = true;
      saveStatus.textContent = 'Saving…';
      try{
        const idsAll = fixtures.map(f => f.id);
        if (idsAll.length){
          const { error: e1 } = await supabase
            .from('fixtures')
            .update({ featured: false })
            .in('id', idsAll);
          if (e1) throw e1;
        }
        const { error: e2 } = await supabase
          .from('fixtures')
          .update({ featured: true })
          .in('id', picked);
        if (e2) throw e2;

        saveStatus.textContent = 'Saved.';
        await loadFixtures();
        await loadSubmissions();
      } catch(e){
        saveStatus.textContent = 'Error saving.';
        showError(e);
      } finally {
        saveBtn.disabled = false;
        setTimeout(() => (saveStatus.textContent = ''), 1500);
      }
    }

    async function lockWeek(){
      const weekStartISO = getWeekStartISO();
      lockBtn.disabled = true;
      try{
        await setGlobalLock(supabase, weekStartISO, true);
        await refreshLockUI();
        alert(`Week locked: ${weekStartISO}`);
      }catch(e){
        showError(e);
        alert('Could not lock the week.');
      }finally{
        lockBtn.disabled = false;
      }
    }

    }

    async function loadSubmissions(){
      listPicked.innerHTML = '';
      subsMeta.textContent = 'Loading…';

      const featured = fixtures.filter(f => f.featured);
      const featuredIds = featured.map(f => f.id);
      const totalNeeded = featuredIds.length;

      if (totalNeeded === 0){
        subsMeta.textContent = 'No featured fixtures selected yet.';
        return;
      }

      const { data: preds, error: prErr } = await supabase
        .from('predictions')
        .select('user_id, fixture_id')
        .in('fixture_id', featuredIds);
      if (prErr) { showError(prErr); throw prErr; }

      const userTotals = new Map();
      for (const p of preds || []){
        userTotals.set(p.user_id, (userTotals.get(p.user_id) || 0) + 1);
      }

      const userIds = [...userTotals.keys()];
      if (!userIds.length){
        subsMeta.textContent = 'No predictions yet on featured fixtures.';
        return;
      }

      const { data: profs, error: profErr } = await supabase
        .from('profiles')
        .select('id, display_name')
        .in('id', userIds);
      if (profErr) { showError(profErr); throw profErr; }

      const items = (profs || []).map(p => ({
        id: p.id,
        name: p.display_name || 'Player',
        c: userTotals.get(p.id) || 0
      }));
      items.sort((a,b) => (b.c === a.c ? a.name.localeCompare(b.name) : b.c - a.c));

      listPicked.innerHTML = '';
      for (const it of items){
        const li = document.createElement('li');
        li.className = 'small';
        const tick = it.c >= totalNeeded ? ' ✓' : '';
        li.textContent = `${it.name} — ${it.c}/${totalNeeded}${tick}`;
        listPicked.appendChild(li);
      }

      subsMeta.textContent = `Featured fixtures: ${totalNeeded} • Players with picks: ${items.length}`;
    }

    async function onWeekChange(){
      weekOffset = Number(weekSelect.value || 0);
      setWeekWindowLabel();
      saveStatus.textContent = '';
      await loadFixtures();
      await loadSubmissions();
    }

    async function init(){
      try{
        await secureSession();
        saveBtn.onclick = saveFeatured;
        lockBtn.onclick = lockWeek;
        weekSelect.onchange = () => onWeekChange().catch(showError);

        // initial render
        setWeekWindowLabel();
        await loadFixtures();
        await loadSubmissions();
      } catch(e){
        showError(e);
      }
    }
    init();
  </script>
</body>
</html>
