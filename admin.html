<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Dashboard</title>
  <link rel="stylesheet" href="brand.css?v=17" />
  <style>
    .panel{background:#fff;border-radius:16px;padding:20px;max-width:1000px;width:100%;box-shadow:0 8px 20px rgba(0,0,0,.15);margin-bottom:20px}
    .panel h3{margin-bottom:10px;color:#1f357a}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:8px;border-bottom:1px solid #e5e7eb;text-align:center}
    th{background:#f8fafc;text-transform:uppercase;letter-spacing:.03em}
    .btn{background:#28428f;color:#fff;border:none;padding:6px 12px;border-radius:8px;cursor:pointer;font-weight:600}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .small{font-size:.85rem;color:#475569}
    .danger{background:#b91c1c}
  </style>
</head>
<body>
  <!-- Top nav -->
  <nav class="topnav">
    <a href="predict.html" data-nav="predict">Predict</a>
    <a href="my-picks.html" data-nav="mypicks">My Picks</a>
    <a href="leaderboard.html" data-nav="leaderboard">Leaderboard</a>
    <a href="profile.html" data-nav="profile">Profile</a>
    <a href="admin.html" class="active" data-nav="admin">Admin</a>
    <button class="logout" id="navLogout">Logout</button>
  </nav>

  <main class="landing">
    <svg class="logo" viewBox="0 0 64 64" aria-hidden="true">
      <rect x="2" y="2" width="60" height="60" rx="12" fill="#1E824C"></rect>
      <circle cx="32" cy="32" r="16" fill="#FFF" stroke="#0E3E2A" stroke-width="3"></circle>
      <path d="M32 16 l6 6 -6 4 -6-4z M32 48 l6-6 -6-4 -6 4z M16 32 l6-6 4 6 -4 6z M48 32 l-6-6 -4 6 4 6z" fill="#0E3E2A"></path>
    </svg>

    <!-- Global Lock Panel -->
    <section class="panel">
      <h3>Lock Week for Everyone</h3>
      <p class="small">Force-close predictions for all players for this week.</p>
      <button id="lockGlobal" class="btn danger">Lock Week Now</button>
      <p id="lockGlobalStatus" class="small"></p>
    </section>

    <!-- Existing panels: choose featured, current featured, who has predicted -->
    <section class="panel">
      <h3>Choose 5 Featured Fixtures</h3>
      <p class="small">Select exactly 5 fixtures for this week.</p>
      <table id="allFixtures">
        <thead><tr><th></th><th>Home</th><th>Away</th><th>Kick-off</th></tr></thead>
        <tbody><tr><td colspan="4">Loading…</td></tr></tbody>
      </table>
      <button id="saveFeatured" class="btn" style="margin-top:12px">Save Featured</button>
      <p id="saveStatus" class="small"></p>
    </section>

    <section class="panel">
      <h3>Current Featured Fixtures</h3>
      <table id="featuredFixtures">
        <thead><tr><th>#</th><th>Home</th><th>Away</th><th>Kick-off</th></tr></thead>
        <tbody><tr><td colspan="4">Loading…</td></tr></tbody>
      </table>
    </section>

    <section class="panel">
      <h3>Who Has Made Predictions</h3>
      <table id="predMakers">
        <thead><tr><th>#</th><th>Name</th></tr></thead>
        <tbody><tr><td colspan="2">Loading…</td></tr></tbody>
      </table>
    </section>
  </main>

  <script type="module" src="supabase-config.js"></script>
  <script type="module">
    import { supabase } from './supabase-config.js';

    const lockBtn = document.getElementById('lockGlobal');
    const lockStatus = document.getElementById('lockGlobalStatus');
    const allTbody = document.querySelector('#allFixtures tbody');
    const featTbody = document.querySelector('#featuredFixtures tbody');
    const makersTbody = document.querySelector('#predMakers tbody');
    const saveBtn = document.getElementById('saveFeatured');
    const saveStatus = document.getElementById('saveStatus');

    const { data: { session } } = await supabase.auth.getSession();
    if (!session) window.location.replace('login.html');
    const user = session.user;

    // check admin
    const { data: me } = await supabase.from('profiles').select('is_admin').eq('id', user.id).single();
    if (!me?.is_admin) window.location.replace('predict.html');

    function startOfWeek(d=new Date()){const x=new Date(d);const day=x.getDay();const diff=x.getDate()-day+(day===0?-6:1);x.setHours(0,0,0,0);return new Date(x.setDate(diff))}
    const weekStart=startOfWeek();

    // Global lock action
    lockBtn.addEventListener('click', async ()=>{
      if(!confirm('Lock predictions for ALL players this week?')) return;
      lockStatus.textContent='Locking…';
      const { error } = await supabase.from('global_locks').upsert({
        week_start: weekStart.toISOString().slice(0,10),
        locked: true
      }, { onConflict: 'week_start' });
      if(error){ lockStatus.textContent='Error locking.'; console.error(error);}
      else { lockStatus.textContent='Week is now locked for everyone ✅'; }
    });

    // === Existing fixture selection + makers (same as before) ===
    async function loadAllFixtures(){
      const { data } = await supabase.from('fixtures')
        .select('id, home_team, away_team, utc_date, featured')
        .gt('utc_date', new Date().toISOString())
        .order('utc_date',{ascending:true}).limit(20);
      allTbody.innerHTML='';
      data.forEach(fx=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td><input type="checkbox" data-id="${fx.id}" ${fx.featured?'checked':''}></td>
          <td>${fx.home_team}</td>
          <td>${fx.away_team}</td>
          <td>${new Date(fx.utc_date).toLocaleString()}</td>`;
        allTbody.appendChild(tr);
      });
    }
    saveBtn.addEventListener('click', async ()=>{
      const selected=[...allTbody.querySelectorAll('input[type=checkbox]:checked')].map(cb=>Number(cb.dataset.id));
      if(selected.length!==5){saveStatus.textContent='Select exactly 5.';return;}
      saveStatus.textContent='Saving…';
      await supabase.from('fixtures').update({featured:false}).neq('id',0);
      const { error } = await supabase.from('fixtures').update({featured:true}).in('id',selected);
      saveStatus.textContent=error?'Error':'Featured updated ✅';
      loadFeatured();
    });
    async function loadFeatured(){
      const { data } = await supabase.from('fixtures')
        .select('home_team,away_team,utc_date').eq('featured',true).order('utc_date');
      featTbody.innerHTML='';
      if(!data||data.length===0){featTbody.innerHTML='<tr><td colspan="4">None</td></tr>';return;}
      data.forEach((fx,i)=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${i+1}</td><td>${fx.home_team}</td><td>${fx.away_team}</td><td>${new Date(fx.utc_date).toLocaleString()}</td>`;
        featTbody.appendChild(tr);
      });
    }
    async function loadMakers(){
      const { data: feats } = await supabase.from('fixtures').select('id').eq('featured',true);
      if(!feats||feats.length===0){makersTbody.innerHTML='<tr><td colspan="2">No featured fixtures</td></tr>';return;}
      const ids=feats.map(f=>f.id);
      const { data } = await supabase.from('predictions').select('user_id').in('fixture_id',ids);
      const unique=[...new Set(data.map(r=>r.user_id))];
      if(unique.length===0){makersTbody.innerHTML='<tr><td colspan="2">No predictions yet</td></tr>';return;}
      const { data: names } = await supabase.from('profiles').select('id,display_name').in('id',unique);
      makersTbody.innerHTML='';
      names.forEach((n,i)=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${i+1}</td><td>${n.display_name||'Anon'}</td>`;
        makersTbody.appendChild(tr);
      });
    }

    loadAllFixtures();
    loadFeatured();
    loadMakers();
  </script>
</body>
</html>









