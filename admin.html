<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin • Weekend Predictor</title>
  <link rel="stylesheet" href="brand.css?v=45" />
  <style>
    .wrap{max-width:1000px;margin:0 auto;padding:16px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 8px 20px rgba(0,0,0,.08);padding:16px;margin-bottom:16px}
    .card h2{margin:0 0 10px;color:#1f357a}
    .grid{display:grid;gap:12px}
    @media (min-width: 900px){ .grid{grid-template-columns:1fr 1fr} }

    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid #e5e7eb;text-align:left}
    th{background:#f8fafc;text-transform:uppercase;font-size:.85rem;letter-spacing:.03em}
    .muted{color:#64748b}
    .row-actions{display:flex;gap:8px;flex-wrap:wrap}
    .btn{background:#28428f;color:#fff;border:none;padding:10px 14px;border-radius:10px;font-weight:800;cursor:pointer}
    .btn.secondary{background:#111827}
    .btn.light{background:#e2e8f0;color:#111827}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .hint{font-size:.9rem;color:#475569}
    .pill{display:inline-block;padding:3px 8px;border-radius:999px;font-size:.75rem;font-weight:800}
    .ok{background:#dcfce7;color:#166534}
    .warn{background:#fef3c7;color:#92400e}
    .bad{background:#fee2e2;color:#991b1b}
    .meta{font-size:.85rem;color:#475569}

    .lists{display:grid;gap:10px}
    @media (min-width: 900px){ .lists{grid-template-columns:1fr 1fr 1fr} }
    .list card{padding:0}
    ul{list-style:none;padding:0;margin:6px 0 0}
    li{padding:6px 0;border-bottom:1px dashed #e5e7eb}
    .small{font-size:.9rem}
  </style>
</head>
<body>
  <!-- Top nav -->
  <nav class="topnav">
    <a href="predict.html" data-nav="predict">Predict</a>
    <a href="my-picks.html" data-nav="mypicks">My Picks</a>
    <a href="leaderboard.html" data-nav="leaderboard">Leaderboard</a>
    <a href="profile.html" data-nav="profile">Profile</a>
    <a href="admin.html" class="active" data-nav="admin">Admin</a>
    <button class="logout" id="navLogout">Logout</button>
  </nav>

  <main class="wrap">
    <!-- Header -->
    <div class="card" style="display:flex;align-items:center;justify-content:space-between;gap:10px">
      <div>
        <h2>Admin Dashboard</h2>
        <div class="meta">Week of <span id="weekLabel">—</span></div>
      </div>
      <div class="row-actions">
        <button id="lockBtn" class="btn">Lock Week for Everyone</button>
        <button id="unlockBtn" class="btn light">Unlock Week</button>
      </div>
    </div>

    <!-- Featured fixtures & picker -->
    <section class="card">
      <h2>Pick This Week’s Featured Fixtures</h2>
      <p class="hint">Tick the 5 games you want players to predict. Click <b>Save Featured</b> to publish.</p>
      <div class="row-actions" style="margin:8px 0 10px">
        <button id="saveFeaturedBtn" class="btn">Save Featured</button>
        <span id="saveStatus" class="meta"></span>
      </div>
      <table>
        <thead>
          <tr>
            <th>Pick</th>
            <th>Date (UTC)</th>
            <th>Fixture</th>
            <th>Status / Result</th>
          </tr>
        </thead>
        <tbody id="fixturesBody">
          <tr><td colspan="4" class="muted">Loading fixtures…</td></tr>
        </tbody>
      </table>
    </section>

    <!-- Submissions -->
    <section class="card">
      <h2>Who Has Submitted Picks (This Week)</h2>
      <div class="meta" id="subsMeta">Loading…</div>
      <div class="lists">
        <div>
          <div class="pill ok">Submitted (all picks in)</div>
          <ul id="listAll"></ul>
        </div>
        <div>
          <div class="pill warn">Started (some picks)</div>
          <ul id="listSome"></ul>
        </div>
        <div>
          <div class="pill bad">Not started</div>
          <ul id="listNone"></ul>
        </div>
      </div>
    </section>
  </main>

  <script type="module" src="supabase-config.js"></script>
  <script type="module">
    import { supabase } from './supabase-config.js';

    // --- Auth guard + logout ---
    const { data: { session } } = await supabase.auth.getSession();
    if (!session?.user) { window.location.replace('login.html'); throw new Error('No session'); }
    const me = session.user;
    document.getElementById('navLogout').addEventListener('click', async () => {
      await supabase.auth.signOut(); window.location.replace('login.html');
    });

    // Ensure admin
    {
      const { data, error } = await supabase.from('profiles').select('is_admin').eq('id', me.id).maybeSingle();
      if (error || !data?.is_admin) {
        alert('Admins only.'); window.location.replace('predict.html'); throw new Error('Not admin');
      }
    }

    // --- Date helpers: current Monday..next Monday ---
    function startOfWeek(d=new Date()){
      const x=new Date(d); const day=x.getDay(); const diff=x.getDate()-day+(day===0?-6:1);
      x.setHours(0,0,0,0); return new Date(x.setDate(diff));
    }
    function fmtISO(d){ return d.toISOString().slice(0,10); }
    const weekStart = startOfWeek();
    const weekEnd = new Date(weekStart); weekEnd.setDate(weekStart.getDate()+7);
    document.getElementById('weekLabel').textContent = `${weekStart.toDateString()} — ${new Date(weekEnd-1).toDateString()}`;

    // --- Elements ---
    const fixturesBody = document.getElementById('fixturesBody');
    const saveBtn = document.getElementById('saveFeaturedBtn');
    const saveStatus = document.getElementById('saveStatus');
    const lockBtn = document.getElementById('lockBtn');
    const unlockBtn = document.getElementById('unlockBtn');

    const listAll = document.getElementById('listAll');
    const listSome = document.getElementById('listSome');
    const listNone = document.getElementById('listNone');
    const subsMeta = document.getElementById('subsMeta');

    // --- Load fixtures for this week ---
    let fixtures = [];
    async function loadFixtures(){
      fixturesBody.innerHTML = '<tr><td colspan="4" class="muted">Loading fixtures…</td></tr>';
      const { data, error } = await supabase
        .from('fixtures')
        .select('id,home_team,away_team,utc_date,home_score,away_score,status,featured')
        .gte('utc_date', fmtISO(weekStart))
        .lt('utc_date', fmtISO(weekEnd))
        .order('utc_date', { ascending: true });

      if (error) { fixturesBody.innerHTML = `<tr><td colspan="4" class="muted">Error loading fixtures.</td></tr>`; return; }
      fixtures = data || [];
      if (!fixtures.length) {
        fixturesBody.innerHTML = `<tr><td colspan="4" class="muted">No fixtures for this week (yet).</td></tr>`;
        return;
      }
      renderFixtures();
    }

    function renderFixtures(){
      fixturesBody.innerHTML = '';
      for (const f of fixtures){
        const date = new Date(f.utc_date).toISOString().replace('T',' ').slice(0,16) + ' UTC';
        const res = (f.home_score ?? '') !== '' && (f.away_score ?? '') !== ''
          ? `${f.home_score}–${f.away_score}` : (f.status || '—');
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><input type="checkbox" class="feat" data-id="${f.id}" ${f.featured ? 'checked':''} /></td>
          <td>${date}</td>
          <td>${f.home_team || '?'} vs ${f.away_team || '?'}</td>
          <td class="muted">${res}</td>
        `;
        fixturesBody.appendChild(tr);
      }
    }

    // --- Save featured selection ---
    saveBtn.addEventListener('click', async ()=>{
      saveBtn.disabled = true; saveStatus.textContent = 'Saving…';
      try{
        const checks = Array.from(document.querySelectorAll('.feat'));
        const idsChecked = checks.filter(c=>c.checked).map(c=>c.dataset.id);
        const idsAll = fixtures.map(f=>f.id);

        // set featured=true for checked, false for others (only this week’s fixtures)
        if (idsAll.length){
          // false for all in this week
          const { error: e1 } = await supabase.from('fixtures')
            .update({ featured: false })
            .in('id', idsAll);
          if (e1) throw e1;
        }
        if (idsChecked.length){
          const { error: e2 } = await supabase.from('fixtures')
            .update({ featured: true })
            .in('id', idsChecked);
          if (e2) throw e2;
        }
        saveStatus.textContent = 'Saved.';
        await loadFixtures();
        await loadSubmissions(); // refresh submission buckets after changes
      } catch(e){
        console.error(e);
        saveStatus.textContent = 'Error saving.';
      } finally {
        saveBtn.disabled = false;
        setTimeout(()=>saveStatus.textContent='', 1500);
      }
    });

    // --- Global lock / unlock for the week ---
    lockBtn.addEventListener('click', async ()=>{
      lockBtn.disabled = true;
      try{
        // Insert if not exists
        const { data, error } = await supabase
          .from('global_locks')
          .upsert({ week_start: fmtISO(weekStart), locked: true }, { onConflict: 'week_start' })
          .select();
        if (error) throw error;
        alert('Week locked for everyone.');
      } catch(e){ console.error(e); alert('Could not lock the week.'); }
      finally{ lockBtn.disabled=false; }
    });

    unlockBtn.addEventListener('click', async ()=>{
      unlockBtn.disabled = true;
      try{
        const { error } = await supabase
          .from('global_locks')
          .update({ locked: false })
          .eq('week_start', fmtISO(weekStart));
        if (error) throw error;
        alert('Week unlocked.');
      } catch(e){ console.error(e); alert('Could not unlock the week.'); }
      finally{ unlockBtn.disabled=false; }
    });

    // --- Submissions (fixed) ---
    async function loadSubmissions(){
      listAll.innerHTML = ''; listSome.innerHTML = ''; listNone.innerHTML = '';
      subsMeta.textContent = 'Loading…';

      // 1) This week’s FEATURED fixtures
      const featured = fixtures.filter(f=>f.featured);
      const featuredIds = featured.map(f=>f.id);
      const totalNeeded = featuredIds.length;
      if (totalNeeded === 0){
        subsMeta.textContent = 'No featured fixtures picked yet.';
        return;
      }

      // 2) All players (profiles)
      const { data: profiles, error: pErr } = await supabase
        .from('profiles')
        .select('id,display_name')
        .order('display_name', { ascending: true });
      if (pErr){ subsMeta.textContent = 'Error loading players.'; return; }

      // 3) Predictions for these featured fixtures (any user)
      //    We only care about user_id and fixture_id.
      //    Chunk fixture ids if many; usually 5 so one query is fine.
      const { data: preds, error: prErr } = await supabase
        .from('predictions')
        .select('user_id, fixture_id')
        .in('fixture_id', featuredIds);
      if (prErr){ subsMeta.textContent = 'Error loading predictions.'; return; }

      // 4) Count distinct picks per user for the featured set
      const counts = new Map(); // user_id -> count
      (preds || []).forEach(p=>{
        counts.set(p.user_id, (counts.get(p.user_id)||0) + 1);
      });

      // 5) Bucket users
      const all = [];
      const some = [];
      const none = [];
      (profiles || []).forEach(u=>{
        const c = counts.get(u.id) || 0;
        const name = u.display_name || 'Anon';
        const li = document.createElement('li');
        li.className = 'small';
        li.textContent = `${name} — ${c}/${totalNeeded}`;
        if (c === 0) none.push(li);
        else if (c >= totalNeeded) all.push(li);
        else some.push(li);
      });

      // 6) Render
      if (!all.length) listAll.innerHTML = '<li class="muted small">—</li>';
      else all.forEach(li=>listAll.appendChild(li));

      if (!some.length) listSome.innerHTML = '<li class="muted small">—</li>';
      else some.forEach(li=>listSome.appendChild(li));

      if (!none.length) listNone.innerHTML = '<li class="muted small">—</li>';
      else none.forEach(li=>listNone.appendChild(li));

      subsMeta.textContent = `Featured fixtures: ${totalNeeded} • Players: ${profiles?.length||0}`;
    }

    // Boot
    await loadFixtures();
    await loadSubmissions();
  </script>
</body>
</html>
