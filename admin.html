<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin • Weekend Predictor</title>
  <link rel="stylesheet" href="brand.css?v=50" />
  <style>
    .wrap{max-width:1000px;margin:0 auto;padding:16px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 8px 20px rgba(0,0,0,.08);padding:16px;margin-bottom:16px}
    .card h2{margin:0 0 10px;color:#1f357a}
    .row-actions{display:flex;gap:10px;flex-wrap:wrap}
    .btn{background:#28428f;color:#fff;border:none;padding:10px 14px;border-radius:10px;font-weight:800;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn.light{background:#e2e8f0;color:#111827}
    .meta{font-size:.9rem;color:#475569}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid #e5e7eb;text-align:left;vertical-align:top}
    th{background:#f8fafc;text-transform:uppercase;font-size:.85rem;letter-spacing:.03em}
    .muted{color:#64748b}
    .count{font-weight:800;color:#1f357a}
    .list{list-style:none;margin:8px 0 0;padding:0}
    .list li{padding:6px 0;border-bottom:1px dashed #e5e7eb}
    .small{font-size:.95rem}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#ecfeff;color:#164e63;font-weight:800;font-size:.8rem}
  </style>
</head>
<body>
  <!-- Top nav -->
  <nav class="topnav">
    <a href="predict.html" data-nav="predict">Predict</a>
    <a href="my-picks.html" data-nav="mypicks">My Picks</a>
    <a href="leaderboard.html" data-nav="leaderboard">Leaderboard</a>
    <a href="profile.html" data-nav="profile">Profile</a>
    <a href="admin.html" class="active" data-nav="admin">Admin</a>
    <button class="logout" id="navLogout">Logout</button>
  </nav>

  <main class="wrap">
    <!-- Header -->
    <section class="card" style="display:flex;align-items:center;justify-content:space-between;gap:10px">
      <div>
        <h2>Admin Dashboard</h2>
        <div class="meta">Week of <span id="weekLabel">—</span></div>
      </div>
      <div class="row-actions">
        <button id="lockBtn" class="btn">Lock Week for Everyone</button>
      </div>
    </section>

    <!-- Featured fixtures -->
    <section class="card">
      <h2>Pick This Week’s Featured Fixtures</h2>
      <p class="meta">Select <b>exactly 5</b> fixtures for players to predict. Then click <b>Save Featured</b>.</p>

      <div class="row-actions" style="margin:8px 0 10px">
        <span class="pill">Selected: <span id="selectedCount">0</span>/5</span>
        <button id="saveFeaturedBtn" class="btn" disabled>Save Featured</button>
        <span id="saveStatus" class="meta"></span>
      </div>

      <table>
        <thead>
          <tr>
            <th>Pick</th>
            <th>Date (UTC)</th>
            <th>Fixture</th>
            <th>Status / Result</th>
          </tr>
        </thead>
        <tbody id="fixturesBody">
          <tr><td colspan="4" class="muted">Loading fixtures…</td></tr>
        </tbody>
      </table>
    </section>

    <!-- Submissions (ONLY those who picked) -->
    <section class="card">
      <h2>Who Has Submitted Picks (This Week)</h2>
      <div class="meta" id="subsMeta">Loading…</div>
      <ul class="list" id="listPicked"></ul>
    </section>
  </main>

  <script type="module" src="supabase-config.js"></script>
  <script type="module">
    import { supabase } from './supabase-config.js';

    // --- Auth guard + logout ---
    const { data: { session } } = await supabase.auth.getSession();
    if (!session?.user) { window.location.replace('login.html'); throw new Error('No session'); }
    document.getElementById('navLogout').addEventListener('click', async () => {
      await supabase.auth.signOut(); window.location.replace('login.html');
    });

    // Ensure admin
    {
      const { data, error } = await supabase
        .from('profiles').select('is_admin').eq('id', session.user.id).maybeSingle();
      if (error || !data?.is_admin) { alert('Admins only.'); window.location.replace('predict.html'); throw new Error('Not admin'); }
    }

    // --- Week window (Mon..Mon in UTC) ---
    function startOfWeek(d=new Date()){
      const x=new Date(d); const day=x.getUTCDay(); // use UTC to match utc_date
      const diff=x.getUTCDate()-day+(day===0?-6:1);
      x.setUTCHours(0,0,0,0);
      return new Date(Date.UTC(x.getUTCFullYear(), x.getUTCMonth(), diff));
    }
    function isoDate(d){ return d.toISOString().slice(0,10); }
    const weekStart = startOfWeek();
    const weekEnd = new Date(weekStart); weekEnd.setUTCDate(weekStart.getUTCDate()+7);
    document.getElementById('weekLabel').textContent =
      `${weekStart.toUTCString().slice(0,16)} — ${new Date(weekEnd-1).toUTCString().slice(0,16)}`;

    // --- Elements ---
    const fixturesBody = document.getElementById('fixturesBody');
    const saveBtn = document.getElementById('saveFeaturedBtn');
    const saveStatus = document.getElementById('saveStatus');
    const selectedCountEl = document.getElementById('selectedCount');
    const listPicked = document.getElementById('listPicked');
    const subsMeta = document.getElementById('subsMeta');
    const lockBtn = document.getElementById('lockBtn');

    // --- Load fixtures in week ---
    let fixtures = [];
    function updateSelectedCounter(){
      const n = document.querySelectorAll('.feat:checked').length;
      selectedCountEl.textContent = n;
      saveBtn.disabled = (n !== 5);
    }

    async function loadFixtures(){
      fixturesBody.innerHTML = '<tr><td colspan="4" class="muted">Loading fixtures…</td></tr>';
      const { data, error } = await supabase
        .from('fixtures')
        .select('id,home_team,away_team,utc_date,home_score,away_score,status,featured')
        .gte('utc_date', isoDate(weekStart))
        .lt('utc_date', isoDate(weekEnd))
        .order('utc_date', { ascending: true });

      if (error) { fixturesBody.innerHTML = `<tr><td colspan="4" class="muted">Error loading fixtures.</td></tr>`; return; }
      fixtures = data || [];
      if (!fixtures.length) {
        fixturesBody.innerHTML = `<tr><td colspan="4" class="muted">No fixtures for this week (yet).</td></tr>`;
        return;
      }
      renderFixtures();
      updateSelectedCounter();
    }

    function renderFixtures(){
      fixturesBody.innerHTML = '';
      for (const f of fixtures){
        const date = new Date(f.utc_date+'T00:00:00Z'); // utc_date is a date (no time); show as date only
        const dateStr = `${date.toISOString().slice(0,10)} UTC`;
        const res = (f.home_score ?? '') !== '' && (f.away_score ?? '') !== ''
          ? `${f.home_score}–${f.away_score}` : (f.status || '—');

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><input type="checkbox" class="feat" data-id="${f.id}" ${f.featured ? 'checked':''} /></td>
          <td>${dateStr}</td>
          <td>${f.home_team || '?'} vs ${f.away_team || '?'}</td>
          <td class="muted">${res}</td>
        `;
        fixturesBody.appendChild(tr);
      }
      document.querySelectorAll('.feat').forEach(cb=>cb.addEventListener('change', updateSelectedCounter));
    }

    // --- Save featured (require exactly 5) ---
    saveBtn.addEventListener('click', async ()=>{
      const checks = Array.from(document.querySelectorAll('.feat'));
      const picked = checks.filter(c=>c.checked).map(c=>c.dataset.id);
      if (picked.length !== 5){
        alert('Please select exactly 5 fixtures.');
        return;
      }
      saveBtn.disabled = true; saveStatus.textContent = 'Saving…';
      try{
        const idsAll = fixtures.map(f=>f.id);
        if (idsAll.length){
          const { error: e1 } = await supabase.from('fixtures')
            .update({ featured: false }).in('id', idsAll);
          if (e1) throw e1;
        }
        const { error: e2 } = await supabase.from('fixtures')
          .update({ featured: true }).in('id', picked);
        if (e2) throw e2;

        saveStatus.textContent = 'Saved.';
        await loadFixtures();
        await loadSubmissions(); // refresh list
      } catch(e){
        console.error(e); saveStatus.textContent = 'Error saving.';
      } finally {
        saveBtn.disabled = false;
        setTimeout(()=>saveStatus.textContent='', 1500);
      }
    });

    // --- Lock week for everyone ---
    lockBtn.addEventListener('click', async ()=>{
      lockBtn.disabled = true;
      try{
        const { error } = await supabase
          .from('global_locks')
          .upsert({ week_start: isoDate(weekStart), locked: true }, { onConflict: 'week_start' });
        if (error) throw error;
        alert('Week locked for everyone.');
      } catch(e){ console.error(e); alert('Could not lock the week.'); }
      finally{ lockBtn.disabled=false; }
    });

    // --- Submissions: only show users who picked (>=1) among this week's FEATURED fixtures ---
    async function loadSubmissions(){
      listPicked.innerHTML = ''; subsMeta.textContent = 'Loading…';

      const featured = fixtures.filter(f=>f.featured);
      const featuredIds = featured.map(f=>f.id);
      const totalNeeded = featuredIds.length;

      if (totalNeeded === 0){
        subsMeta.textContent = 'No featured fixtures selected yet.';
        return;
      }

      // All predictions on the featured fixtures
      const { data: preds, error: prErr } = await supabase
        .from('predictions')
        .select('user_id, fixture_id')
        .in('fixture_id', featuredIds);
      if (prErr){ subsMeta.textContent = 'Error loading predictions.'; return; }

      // Count by user
      const counts = new Map();
      (preds||[]).forEach(p=>{
        counts.set(p.user_id, (counts.get(p.user_id)||0) + 1);
      });

      // Filter users who picked >=1, and fetch their names
      const userIds = [...counts.keys()];
      if (userIds.length === 0){
        subsMeta.textContent = `Featured fixtures: ${totalNeeded} • No submissions yet.`;
        listPicked.innerHTML = '<li class="muted small">—</li>';
        return;
      }

      const { data: profs, error: pe } = await supabase
        .from('profiles')
        .select('id,display_name')
        .in('id', userIds);
      if (pe){ subsMeta.textContent = 'Error loading players.'; return; }

      const byId = new Map((profs||[]).map(p=>[p.id, p.display_name || 'Anon']));
      // Sort: completed first (5/5), then by count desc, then name
      const items = userIds.map(id=>({ id, name: byId.get(id) || 'Anon', c: counts.get(id) || 0 }));
      items.sort((a,b)=> (b.c===a.c ? (a.name.localeCompare(b.name)) : b.c-a.c));

      items.forEach(it=>{
        const li = document.createElement('li');
        li.className = 'small';
        const done = it.c >= totalNeeded ? ' ✓' : '';
        li.textContent = `${it.name} — ${it.c}/${totalNeeded}${done}`;
        listPicked.appendChild(li);
      });

      subsMeta.textContent = `Featured fixtures: ${totalNeeded} • Players with picks: ${items.length}`;
    }

    // Boot
    await loadFixtures();
    await loadSubmissions();
  </script>
</body>
</html>
